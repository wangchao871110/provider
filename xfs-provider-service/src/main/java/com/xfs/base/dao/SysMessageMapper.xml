<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SYS_MESSAGE" > 
<!-- Result Map-->
<resultMap id="result_map_SYS_MESSAGE" type="com.xfs.base.model.SysMessage" >
	<result column="message_id" property="messageId"/>
	<result column="todo_user_type" property="todoUserType"/>
	<result column="todo_user" property="todoUser"/>
	<result column="todo_org" property="todoOrg"/>
	<result column="title" property="title"/>
	<result column="content" property="content"/>
	<result column="type" property="type"/>
	<result column="state" property="state"/>
	<result column="deal_user" property="dealUser"/>
	<result column="deal_time" property="dealTime"/>
	<result column="send_user" property="sendUser"/>
	<result column="send_user_type" property="sendUserType"/>
	<result column="send_org" property="sendOrg"/>
	<result column="send_time" property="sendTime"/>
	<result column="data_id" property="dataId"/>
	<result column="url" property="url"/>
	<result column="create_by" property="createBy"/>
	<result column="create_dt" property="createDt"/>
	<result column="modify_by" property="modifyBy"/>
	<result column="modify_dt" property="modifyDt"/>
	<result column="dr" property="dr"/>
	<result column="short_name" property="shortName"/>
	<result column="is_read" property="isRead"/>
	<result column="userName" property="userName"/>
</resultMap>
       
<!-- sys_message table all fields -->
<sql id="Base_Column_List" >
	 message_id,todo_user_type,todo_user,todo_org,title,content,type,state,deal_user,deal_time,send_user,send_user_type,send_org,send_time,data_id,url,create_by,create_dt,modify_by,modify_dt,dr,is_read
</sql>

<!-- 查询条件 -->
<sql id="Example_Where_Clause">
  <trim prefix=" WHERE " prefixOverrides="AND ">
	<if test="messageId != null" >and message_id = #{messageId}</if>
	<if test="todoUserType != null" >and todo_user_type = #{todoUserType}</if>
	<if test="todoUser != null" >and todo_user = #{todoUser}</if>
	<if test="todoOrg != null" >and todo_org = #{todoOrg}</if>
	<if test="title != null" >and title = #{title}</if>
	<if test="content != null" >and content = #{content}</if>
	<if test="type != null" >and type = #{type}</if>
	<if test="state != null" >and state = #{state}</if>
	<if test="dealUser != null" >and deal_user = #{dealUser}</if>
	<if test="dealTime != null" >and deal_time = #{dealTime}</if>
	<if test="sendUser != null" >and send_user = #{sendUser}</if>
	<if test="sendUserType != null" >and send_user_type = #{sendUserType}</if>
	<if test="sendOrg != null" >and send_org = #{sendOrg}</if>
	<if test="sendTime != null" >and send_time = #{sendTime}</if>
	<if test="dataId != null" >and data_id = #{dataId}</if>
	<if test="url != null" >and url = #{url}</if>
	<if test="createBy != null" >and create_by = #{createBy}</if>
	<if test="createDt != null" >and create_dt = #{createDt}</if>
	<if test="modifyBy != null" >and modify_by = #{modifyBy}</if>
	<if test="modifyDt != null" >and modify_dt = #{modifyDt}</if>
	<if test="dr != null" >and dr = #{dr}</if>
	<if test="isRead != null" >and is_read = #{isRead}</if>
</trim>
</sql>

<!-- 查询条件 带模糊查询 以及 时间起始查询 -->
<sql id="Example_Where_Clause2">
  <trim prefix=" WHERE " prefixOverrides="AND ">
    <if test="messageId != null">AND message_id like '%${messageId}%'</if>
    <if test="todoUserType != null">AND todo_user_type like '%${todoUserType}%'</if>
    <if test="todoUserTypeEq != null">AND todo_user_type = #{todoUserTypeEq}</if>
    <if test="todoUser != null">AND todo_user like '${todoUser}'</if>
    <if test="todoOrg != null">AND todo_org like '%${todoOrg}%'</if>
    <if test="title != null">AND title like '%${title}%'</if>
    <if test="titleEq != null">AND title = #{titleEq}</if>
    <if test="content != null">AND content like '%${content}%'</if>
    <if test="contentEq != null">AND content = #{contentEq}</if>
    <if test="type != null">AND type like '%${type}%'</if>
    <if test="typeEq != null">AND type = #{typeEq}</if>
    <if test="state != null">AND state like '%${state}%'</if>
    <if test="stateEq != null">AND state = #{stateEq}</if>
    <if test="dealUser != null">AND deal_user like '%${dealUser}%'</if>
    <if test="dealTime != null">AND deal_time = #{dealTime}</if>
    <if test="dealTimeFrom != null">AND deal_time&gt;=#{dealTimeFrom}</if>
	<if test="dealTimeTo != null">AND deal_time&lt;=#{dealTimeTo}</if>
    <if test="sendUser != null">AND send_user like '%${sendUser}%'</if>
    <if test="sendUserType != null">AND send_user_type like '%${sendUserType}%'</if>
    <if test="sendUserTypeEq != null">AND send_user_type = #{sendUserTypeEq}</if>
    <if test="sendOrg != null">AND send_org like '%${sendOrg}%'</if>
    <if test="sendTime != null">AND send_time = #{sendTime}</if>
    <if test="sendTimeFrom != null">AND send_time&gt;=#{sendTimeFrom}</if>
	<if test="sendTimeTo != null">AND send_time&lt;=#{sendTimeTo}</if>
    <if test="dataId != null">AND data_id like '%${dataId}%'</if>
    <if test="url != null">AND url like '%${url}%'</if>
    <if test="urlEq != null">AND url = #{urlEq}</if>
    <if test="createBy != null">AND create_by like '%${createBy}%'</if>
    <if test="createDt != null">AND create_dt = #{createDt}</if>
    <if test="createDtFrom != null">AND create_dt&gt;=#{createDtFrom}</if>
	<if test="createDtTo != null">AND create_dt&lt;=#{createDtTo}</if>
    <if test="modifyBy != null">AND modify_by like '%${modifyBy}%'</if>
    <if test="modifyDt != null">AND modify_dt = #{modifyDt}</if>
    <if test="modifyDtFrom != null">AND modify_dt&gt;=#{modifyDtFrom}</if>
	<if test="modifyDtTo != null">AND modify_dt&lt;=#{modifyDtTo}</if>
    <if test="dr != null">AND dr like '%${dr}%'</if>
    <if test="isRead != null" >and is_read = #{isRead}</if>
  </trim>
</sql>

<!-- 插入记录 -->
<insert id="InsertSYS_MESSAGE" parameterType="Object" >
  INSERT INTO SYS_MESSAGE (
  <trim prefix=" " prefixOverrides=",">
	<if test="messageId != null ">,message_id</if>
	<if test="todoUserType != null ">,todo_user_type</if>
	<if test="todoUser != null ">,todo_user</if>
	<if test="todoOrg != null ">,todo_org</if>
	<if test="title != null ">,title</if>
	<if test="content != null ">,content</if>
	<if test="type != null ">,type</if>
	<if test="state != null ">,state</if>
	<if test="dealUser != null ">,deal_user</if>
	<if test="dealTime != null ">,deal_time</if>
	<if test="sendUser != null ">,send_user</if>
	<if test="sendUserType != null ">,send_user_type</if>
	<if test="sendOrg != null ">,send_org</if>
	<if test="sendTime != null ">,send_time</if>
	<if test="dataId != null ">,data_id</if>
	<if test="url != null ">,url</if>
	<if test="createBy != null ">,create_by</if>
	<if test="createDt != null ">,create_dt</if>
	<if test="modifyBy != null ">,modify_by</if>
	<if test="modifyDt != null ">,modify_dt</if>
	<if test="dr != null ">,dr</if>
	<if test="isRead != null" >,is_read</if>
  </trim>
  )  VALUES (
  <trim prefix=" " prefixOverrides=",">
	<if test="messageId != null ">,#{messageId}</if>
	<if test="todoUserType != null ">,#{todoUserType}</if>
	<if test="todoUser != null ">,#{todoUser}</if>
	<if test="todoOrg != null ">,#{todoOrg}</if>
	<if test="title != null ">,#{title}</if>
	<if test="content != null ">,#{content}</if>
	<if test="type != null ">,#{type}</if>
	<if test="state != null ">,#{state}</if>
	<if test="dealUser != null ">,#{dealUser}</if>
	<if test="dealTime != null ">,#{dealTime}</if>
	<if test="sendUser != null ">,#{sendUser}</if>
	<if test="sendUserType != null ">,#{sendUserType}</if>
	<if test="sendOrg != null ">,#{sendOrg}</if>
	<if test="sendTime != null ">,#{sendTime}</if>
	<if test="dataId != null ">,#{dataId}</if>
	<if test="url != null ">,#{url}</if>
	<if test="createBy != null ">,#{createBy}</if>
	<if test="createDt != null ">,#{createDt}</if>
	<if test="modifyBy != null ">,#{modifyBy}</if>
	<if test="modifyDt != null ">,#{modifyDt}</if>
	<if test="dr != null ">,#{dr}</if>
	<if test="isRead != null" >,#{isRead}</if>
  </trim>
  )
  <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="messageId">
	SELECT LAST_INSERT_ID() AS MESSAGE_ID
  </selectKey>
</insert>

<!-- 根据id，修改记录-->  
<update id="UpdateSYS_MESSAGE" parameterType="Object" >
UPDATE SYS_MESSAGE 
  <trim prefix=" SET " prefixOverrides=",">
	<if test="messageId != null ">,message_id=#{messageId}</if>
	<if test="todoUserType != null ">,todo_user_type=#{todoUserType}</if>
	<if test="todoUser != null ">,todo_user=#{todoUser}</if>
	<if test="todoOrg != null ">,todo_org=#{todoOrg}</if>
	<if test="title != null ">,title=#{title}</if>
	<if test="content != null ">,content=#{content}</if>
	<if test="type != null ">,type=#{type}</if>
	<if test="state != null ">,state=#{state}</if>
	<if test="dealUser != null ">,deal_user=#{dealUser}</if>
	<if test="dealTime != null ">,deal_time=#{dealTime}</if>
	<if test="sendUser != null ">,send_user=#{sendUser}</if>
	<if test="sendUserType != null ">,send_user_type=#{sendUserType}</if>
	<if test="sendOrg != null ">,send_org=#{sendOrg}</if>
	<if test="sendTime != null ">,send_time=#{sendTime}</if>
	<if test="dataId != null ">,data_id=#{dataId}</if>
	<if test="url != null ">,url=#{url}</if>
	<if test="createBy != null ">,create_by=#{createBy}</if>
	<if test="createDt != null ">,create_dt=#{createDt}</if>
	<if test="modifyBy != null ">,modify_by=#{modifyBy}</if>
	<if test="modifyDt != null ">,modify_dt=#{modifyDt}</if>
	<if test="dr != null ">,dr=#{dr}</if>
	<if test="isRead != null" >,is_read = #{isRead}</if>
  </trim>
WHERE MESSAGE_ID=#{messageId}
</update>
 
<!-- 删除记录 -->
<delete id="DeleteSYS_MESSAGE">DELETE FROM SYS_MESSAGE WHERE MESSAGE_ID=#{messageId}</delete>
<!-- 消息通知表 列表总数-->
<select id="CountFindAllSYS_MESSAGE" resultType="java.lang.Integer">SELECT count(1) as value FROM SYS_MESSAGE</select>
<select id="CountSYS_MESSAGE" resultType="java.lang.Integer">SELECT count(1) as value FROM SYS_MESSAGE WHERE MESSAGE_ID=#{messageId}</select>
<!-- 根据id查询 消息通知表 -->
<select id="FindByPK" resultMap="result_map_SYS_MESSAGE" parameterType="Object">SELECT <include refid="Base_Column_List" /> FROM SYS_MESSAGE WHERE MESSAGE_ID=#{messageId}</select>

<!-- 根据各字段条件带模糊查询  消息通知表 -->
<select id="FreeFindSYS_MESSAGE" resultMap="result_map_SYS_MESSAGE" parameterType="Object">
	SELECT <include refid="Base_Column_List" /> FROM SYS_MESSAGE 
	 <include refid="Example_Where_Clause2" />
</select>
<!-- 根据各字段条件带模糊查询  消息通知表 记录数 -->
<select id="CountFreeFindSYS_MESSAGE" resultType="java.lang.Integer">
SELECT count(1) as value FROM SYS_MESSAGE 
 <include refid="Example_Where_Clause2" />
</select>
<!-- 根据各字段条件带排序  消息通知表 -->
<select id="FreeFindSYS_MESSAGEOrdered" resultMap="result_map_SYS_MESSAGE" parameterType="Object">
	SELECT <include refid="Base_Column_List" /> FROM SYS_MESSAGE 
	 <include refid="Example_Where_Clause2" />
	 ORDER BY ${_orderBy}
</select>

<!-- *****************************  温馨提示：  ***************************** -->
<!-- **                                                                    ** -->
<!-- ** 以上为自动生成代码，请勿改动或删除。如有新sql添加请在下方区域内填写** -->
<!-- **                                             ** 2016/08/23 21:18:35 ** -->
<!-- ************************************************************************ -->
<!-- 2016-08 消息通知 查询增员代办业务 by zhangxiyan -->
<!-- 2016-08 待办事项新增，补缴 减员 查询暂时查询beginDate 因孔令潮处 没有执行计算出来 执行时间，暂时用生效时间来代替 -->
<select id="findinsFundAdd" resultType="java.util.Map" parameterType="Map">
	select count(1) count , st.sp_id,st.type ,count(distinct st.emp_id) emp_count 
	from sps_task st
	left join cm_corp cc on st.cp_id = cc.cp_id
	left join cm_employee ce on st.emp_id = ce.emp_id
	where st.bstype_id in (2,3,10) and st.execute_date=#{executeDate} and st.dr = 0 and cc.dr = 0 and ce.dr=0 and st.sp_id =#{spId}
	<if test="queryDeal == null "> and st.type =#{type} </if>
	<if test="queryDeal != null "> and st.type != 'TODO' </if>
	<if test="authority != 'ALL'"> 
		AND cc.cp_id in (${authority})
	 </if>
</select>
<!-- 2016-08 消息通知 查询减员代办业务 by zhangxiyan -->
<select id="findinsFundReduce" resultType="java.util.Map" parameterType="Map">
	select count(1) count , st.sp_id,st.type ,count(distinct st.emp_id) emp_count 
	from sps_task st
	left join cm_corp cc on st.cp_id = cc.cp_id
	left join cm_employee ce on st.emp_id = ce.emp_id
	where st.bstype_id in (4,11) and st.execute_date=#{executeDate} and st.dr = 0 and cc.dr = 0 and ce.dr=0 and st.sp_id =#{spId}
	<if test="queryDeal == null "> and st.type =#{type} </if>
	<if test="queryDeal != null "> and st.type != 'TODO' </if>
	<if test="authority != 'ALL'"> 
		AND cc.cp_id in (${authority})
	 </if>
</select>
<!-- 2016-08 消息通知 查询补缴代办业务 by zhangxiyan-->
<select id="findinsFundSupple" resultType="java.util.Map" parameterType="Map">
	select count(1) count,st.sp_id,st.type ,count(distinct st.emp_id) emp_count 
	from sps_task st
	left join cm_corp cc on st.cp_id = cc.cp_id
	left join cm_employee ce on st.emp_id = ce.emp_id
	where st.bstype_id in (29,30) and st.execute_date=#{executeDate} and st.dr = 0 and cc.dr = 0 and ce.dr=0 and sp_id =#{spId}
	<if test="queryDeal == null "> and st.type =#{type} </if>
	<if test="queryDeal != null "> and st.type != 'TODO' </if>
	<if test="authority != 'ALL'"> 
		AND cc.cp_id in (${authority})
	 </if>
</select>
<!-- 2016-08 消息通知 查询合作伙伴业务 by zhangxiyan -->
<select id="findPartner" resultType="java.util.Map" parameterType="Map">
	select count(1) count, cc.sp_id,cc.state,cc.type from cp_cooperation cc 
	where cc.state = 'SIGNEING' and cc.type='ENTRUSTED' and cc.dr = 0 and cc.sp_id =#{spId}
</select>
<!-- 2016-08 消息通知 根据传来的消息url 查询要发送给哪些用户  -->
<select id="findUserIdListByUrl" resultType="java.util.Map" parameterType="Object">
	select distinct atemp.user_id,sue.user_type,sue.org_id from (select su.user_id from sys_rel_role_func srf 
	inner join sys_user_role su
	on srf.role_id = su.role_id 
	inner join sys_function_data sfd 
	on sfd.data_id =#{sendOrg} and su.user_id = sfd.user_id and  sfd.data_type = 'CM_CORP' and sfd.is_all='N'
	where srf.function_crud_url =#{url}
	union all
	select sus.user_id from sys_rel_role_func srf 
	inner join sys_user_role sus
	on srf.role_id = sus.role_id 
	inner join sys_function_data sfd 
	on sfd.user_id = sus.user_id and  sfd.data_type = 'CM_CORP' and sfd.is_all='Y'
	where srf.function_crud_url =#{url}) atemp
	inner join sys_user sue on atemp.user_id = sue.user_id and sue.org_id = #{todoOrg};
</select>
<!-- 2016-08 消息通知 阅读消息 -->
<update id="UpdateMessageState" parameterType="Object" >
	update sys_message m 
	set m.modify_by=#{modifyBy},m.modify_dt=#{modifyDt},m.is_read=#{isRead}
	where m.message_id in(
		select m.message_id
		from (
			(
				select m.message_id from sys_message m 
				where m.dr=0 and m.is_read='UNREAD' and m.type in('SYS') 
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				GROUP BY m.message_id 
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join cm_employee_audit cea on m.data_id=cea.emp_id and m.dr=0 and m.is_read='UNREAD' and m.type in('HELPER')
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				inner join sps_scheme s on cea.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
			 	</if>
				GROUP BY m.message_id 
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.is_read='UNREAD' and m.type in('SPSTASK') 
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
			 	</if>
 				GROUP BY m.message_id 
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.is_read='UNREAD' and m.type in('YRC') 
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				inner join sps_scheme s on cea.scheme_id=s.scheme_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
			 	</if>
				GROUP BY m.message_id 
			)
			UNION all
			( 
				select m.message_id from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('HR') and cea.scheme_id is null
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.is_read='UNREAD' and m.type in('HR') 
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
			 	</if>
 				GROUP BY m.message_id 
			)
		) m
		<if test="messageId != null and messageId != '' ">where m.message_id = #{messageId} </if>
	)
	
<!-- 
	update sys_message m
	left join cm_employee_audit cea on m.data_id=cea.emp_id 
	left join sps_scheme s on cea.area_id=s.area_id 
	<if test="authority != 'ALL'"> 
		and s.scheme_id in (${authority})
	</if>
	set m.modify_by=#{modifyBy},m.modify_dt=#{modifyDt},m.is_read=#{isRead}
	where m.todo_org = #{todoOrg} 
	and todo_user = #{todoUser} 
	and m.todo_user_type = #{todoUserType}
	and m.is_read='UNREAD'
	<if test="messageId != null and messageId != '' "> and message_id = #{messageId} </if> -->
</update>
<!-- 2016-08 消息通知 查询列表 -->
<select id="FreeFindSYS_MESSAGEByUserId" resultMap="result_map_SYS_MESSAGE" parameterType="Object">
	select cc.short_name,sm.* from sys_message sm
	left join sps_task  st on st.task_id = sm.data_id
	left join cm_corp cc on st.cp_id =cc.cp_id
	where sm.todo_user_type = #{todoUserType} and (sm.todo_user = #{todoUser} or sm.todo_user is null) and sm.state=#{state}
	order by sm.create_dt desc
</select>
<!-- 2016 -08 消息通知 查询条数 -->
<select id="CountFreeFindSYS_MESSAGEByUserId" resultType="java.lang.Integer" parameterType="Object">
	select count(1) as value from sys_message sm
	left join sps_task  st on st.task_id = sm.data_id
	left join cm_corp cc on st.cp_id =cc.cp_id
	where sm.todo_user_type = #{todoUserType} and (sm.todo_user = #{todoUser} or sm.todo_user is null) and sm.state=#{state}
</select>
<!-- 2016-08根据任务单 taskId 反查 推送企业端 userId -->
<select id="FindUserIdByDataIdTaskIdCpId" resultType="java.util.Map" parameterType="Object">
	select su.user_id,su.user_type,su.org_id from sys_user su 
	inner join sps_task st on su.org_id = st.cp_id
	where su.user_type='CUSTOMER' and  st.task_id =#{dataId}
</select>




	<!-- 2016-08 消息通知 查询增员代办业务 by zhangxiyan -->
	<select id="CS_findinsFundAdd" resultType="java.util.Map" parameterType="Map">
		select count(1) count , st.sp_id,st.type
		from sps_task st
		left join cm_corp cc on st.cp_id = cc.cp_id
		left join cm_employee ce on st.emp_id = ce.emp_id
		where st.bstype_id in (2,3,10) and st.execute_date=#{executeDate} and st.dr = 0 and cc.dr = 0 and ce.dr=0 and st.sp_id =#{spId}
		<if test="queryDeal == null "> and st.type =#{type} </if>
		<if test="queryDeal != null "> and st.type != 'TODO' </if>
	</select>

	<!-- 2016-08 消息通知 查询减员代办业务 by zhangxiyan -->
	<select id="CS_findinsFundReduce" resultType="java.util.Map" parameterType="Map">
		select count(1) count , st.sp_id,st.type
		from sps_task st
		left join cm_corp cc on st.cp_id = cc.cp_id
		left join cm_employee ce on st.emp_id = ce.emp_id
		where st.bstype_id in (4,11) and st.execute_date=#{executeDate} and st.dr = 0 and cc.dr = 0 and ce.dr=0 and st.sp_id =#{spId}
		<if test="queryDeal == null "> and st.type =#{type} </if>
		<if test="queryDeal != null "> and st.type != 'TODO' </if>
	</select>

	<!-- 2016-08 消息通知 查询补缴代办业务 by zhangxiyan -->
	<select id="CS_findinsFundSupple" resultType="java.util.Map" parameterType="Map">
		select count(1) count,st.sp_id,st.type
		from sps_task st
		left join cm_corp cc on st.cp_id = cc.cp_id
		left join cm_employee ce on st.emp_id = ce.emp_id
		where st.bstype_id in (29,30) and st.execute_date=#{executeDate} and st.dr = 0 and cc.dr = 0 and ce.dr=0 and sp_id =#{spId}
		<if test="queryDeal == null "> and st.type =#{type} </if>
		<if test="queryDeal != null "> and st.type != 'TODO' </if>
	</select>

	<!-- 2016-08 消息通知 查询合作伙伴业务 by zhangxiyan -->
	<select id="CS_findPartner" resultType="java.util.Map" parameterType="Map">
		select count(1) count, cc.sp_id,cc.state from cp_cooperation cc
		where cc.state = 'SIGNEING' and cc.dr = 0 and cc.sp_id =#{spId}
	</select>

	<!-- 2016-08 消息通知 根据传来的消息url 查询要发送给哪些用户 -->
	<select id="CS_findUserIdListByUrl" resultType="java.util.Map" parameterType="Object">
		select distinct atemp.user_id,sue.user_type from (select su.user_id from sys_rel_role_func srf
		inner join sys_user_role su
		on srf.role_id = su.role_id
		inner join sys_function_data sfd
		on sfd.data_id =#{dataId} and  sfd.data_type = 'CM_CORP' and sfd.is_all='N'
		where srf.function_crud_url =#{url}
		union all
		select sus.user_id from sys_rel_role_func srf
		inner join sys_user_role sus
		on srf.role_id = sus.role_id
		inner join sys_function_data sfd
		on sfd.user_id = sus.user_id and  sfd.data_type = 'CM_CORP' and sfd.is_all='Y'
		where srf.function_crud_url =#{url}) atemp
		inner join sys_user sue on atemp.user_id = sue.user_id
	</select>

	<!-- 2016-08 消息通知 查询列表 -->
	<select id="CS_FreeFindSYS_MESSAGEByUserId" resultType="java.util.Map" parameterType="Object">
		<!-- select bbt.insurance_fund_type,bbt.name as bstype_name,st.task_no,st.type as task_type,ce.emp_id,ce.name as emp_name,cc.short_name,sm.* from sys_message sm
        inner join sps_task  st on st.task_id = sm.data_id
        inner join cm_corp cc on st.cp_id =cc.cp_id
        inner join cm_employee ce on st.emp_id = ce.emp_id
        inner join bd_bstype bbt on st.bstype_id = bbt.bstype_id
        where sm.todo_user_type = #{todoUserType} and (sm.todo_user = #{todoUser} or sm.todo_user is null) and sm.state=#{state}
        order by sm.create_dt desc
        limit 0,10 -->
		select * from sys_message  where todo_user_type = 'CUSTOMER' and todo_user=#{todoUser} and todo_org=#{todoOrg}  and state = 'TODO' order by create_dt desc limit 0,10
	</select>


	<!-- 2016 -08 消息通知 查询条数 -->
	<select id="CS_CountFreeFindSYS_MESSAGEByUserId" resultType="java.lang.Integer">
		select count(1) as value from sys_message sm
		where sm.todo_user_type = #{todoUserType} and sm.todo_user = #{todoUser} and sm.state=#{state}
	</select>



	<!-- 薪福加 查询文章消息信息 -->
	<select id="FindContentMsgList" resultType="java.util.Map" parameterType="Object">
		select msg.message_id,msg.title,msg.content,(CASE WHEN com.anonymous ='1' THEN '匿名' ELSE IFNULL(anc.nick_name,c.corp_name) END ) as nick_name,msg.send_time,msg.state,com.article_id as content_id from sys_message msg
		LEFT JOIN op_hrplus_comment com ON msg.data_id=com.id
		LEFT JOIN op_user_ancillary anc ON com.user_id=anc.user_id
		LEFT JOIN sys_user u ON com.user_id = u.user_id
		LEFT JOIN cm_corp c ON u.org_id = c.cp_id
		<trim prefix=" WHERE " prefixOverrides="AND ">
			<if test="todoUser != null" >and msg.todo_user=#{todoUser}</if>
			<if test="todoUserType != null" >and msg.todo_user_type=#{todoUserType}</if>
			<if test="type != null" >and msg.type=#{type}</if>
			<if test="state != null" >and msg.state=#{state}</if>
		</trim>
		ORDER BY msg.state desc,msg.send_time desc
	</select>


	<!-- 2016 -08 消息通知 查询条数 -->
	<select id="FindContentMsgListCount" resultType="java.lang.Integer">
		select count(1) as value from sys_message msg
		<trim prefix=" WHERE " prefixOverrides="AND ">
			<if test="todoUser != null" >and msg.todo_user=#{todoUser}</if>
			<if test="todoUserType != null" >and msg.todo_user_type=#{todoUserType}</if>
			<if test="type != null" >and msg.type=#{type}</if>
			<if test="state != null" >and msg.state=#{state}</if>
		</trim>
	</select>
	<!-- 根据各字段条件带排序  消息通知表 -->
	<select id="FreeFindXFJ_SYS_MESSAGEOrdered" resultMap="result_map_SYS_MESSAGE" parameterType="Object">
		SELECT message_id,todo_user_type,todo_user,todo_org,title,content,type,state,deal_user,deal_time,send_user,send_user_type,send_org,send_time,data_id,url,create_by,create_dt,modify_by,modify_dt,dr FROM SYS_MESSAGE
		where todo_user=#{todoUser} and todo_user_type='XINFUJIA' and type=#{type}
		ORDER BY state desc,send_time desc
	</select>
	
	<select id="findMessageListCount" resultType="java.lang.Integer">
		select count(m.message_id) as value
		from (
			<if test="type == null or type == ''" >
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'系统消息' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
				from sys_message m
				where m.dr=0 and m.type in('SYS')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
	 			inner join cm_employee_audit cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('HELPER') 
	 			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
	 			inner join sps_scheme s on cea.area_id=s.area_id 
	 			<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('SPSTASK')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('HR')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'人事' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on cea.scheme_id=s.scheme_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
				GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'人事' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC') and cea.scheme_id is null
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
				)
			</if>
			<if test="type != null and type != '' and type == 'SYS'" >
				select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'系统消息' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
				from sys_message m
				where m.dr=0 and m.type in('SYS')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
			</if>
			<if test="type != null and type != '' and type != 'SYS'" >
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
	 			inner join cm_employee_audit cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('HELPER') 
	 			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
	 			inner join sps_scheme s on cea.area_id=s.area_id 
	 			<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('SPSTASK')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'信息收集' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('HR')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'人事' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on cea.scheme_id=s.scheme_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
				GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'人事' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC') and cea.scheme_id is null
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
				)
			</if>
		) m
		where 1=1 
		<if test="createDtFrom != null">AND m.create_dt&gt;=#{createDtFrom}</if>
		<if test="createDtTo != null">AND m.create_dt&lt;=#{createDtTo}</if>
		<!-- select count(m.message_id) as value
		from (select msg.message_id 
			from sys_message msg
			left join cm_employee_audit cea on msg.data_id=cea.emp_id 
			left join sps_scheme s on cea.area_id=s.area_id
			<if test="authority != 'ALL'"> 
				and s.scheme_id in (${authority})
			</if>
			<trim prefix=" WHERE " prefixOverrides="AND ">
				<if test="todoUser != null" >and msg.todo_user=#{todoUser}</if>
				<if test="todoUserType != null" >and msg.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and msg.todo_org=#{todoOrg}</if>
				<if test="state != null" >and msg.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and msg.is_read=#{isRead}</if>
				<if test="type == null and type == ''" >and msg.type in ('SYS','HELPER','SPSTASK','YRC')</if>
				<if test="type != null and type != '' and type == 'SYS'" >and msg.type='SYS'</if>
				<if test="type != null and type != '' and type != 'SYS'" >and msg.type in ('HELPER','SPSTASK','YRC')</if>
				and msg.dr=0
			</trim>
			GROUP BY msg.message_id
		) m -->
	</select>
	
	<select id="findMessageList" resultMap="result_map_SYS_MESSAGE" parameterType="Object">
		select * from (
			<if test="type == null or type == ''" >
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'系统消息' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
				from sys_message m
				where m.dr=0 and m.type in('SYS')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
	 			inner join cm_employee_audit cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('HELPER') 
	 			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
	 			inner join sps_scheme s on cea.area_id=s.area_id 
	 			<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('SPSTASK')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'信息收集' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('HR')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'人事' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on cea.scheme_id=s.scheme_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
				GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'人事' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC') and cea.scheme_id is null
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
				)
			</if>
			<if test="type != null and type != '' and type == 'SYS'" >
				select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'系统消息' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
				from sys_message m
				where m.dr=0 and m.type in('SYS')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
			</if>
			<if test="type != null and type != '' and type != 'SYS'" >
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
	 			inner join cm_employee_audit cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('HELPER') 
	 			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
	 			inner join sps_scheme s on cea.area_id=s.area_id 
	 			<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'员工端' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('SPSTASK')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
	 			GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'人事' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC')
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				inner join sps_scheme s on cea.scheme_id=s.scheme_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
				</if>
				GROUP BY m.message_id 
				)
				UNION all
				( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
				,'人事' as short_name
				,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
	 			from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC') and cea.scheme_id is null 
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<if test="state != null" >and m.state=#{state}</if>
				<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
				GROUP BY m.message_id 
				)
			</if>
		) m
		where 1=1 
		<if test="createDtFrom != null">AND m.create_dt&gt;=#{createDtFrom}</if>
		<if test="createDtTo != null">AND m.create_dt&lt;=#{createDtTo}</if>
	order by m.create_dt desc
		<!-- select msg.message_id,msg.create_dt,msg.title,msg.state,msg.url,msg.data_id,NOW() AS modifyDt
		,msg.type,msg.is_read
		,CASE msg.type WHEN 'SYS' THEN '系统消息' WHEN 'HELPER' THEN '员工端' WHEN 'SPSTASK' THEN '员工端' WHEN 'YRC' THEN '人事' ELSE '' END as short_name
		,cea.name as userName
		from sys_message msg 
		left join cm_employee_audit cea on msg.data_id=cea.emp_id 
		left join sps_scheme s on cea.area_id=s.area_id
		<if test="authority != 'ALL'"> 
			and s.scheme_id in (${authority})
		</if>
		<trim prefix=" WHERE " prefixOverrides="AND ">
			<if test="todoUser != null" >and msg.todo_user=#{todoUser}</if>
			<if test="todoUserType != null" >and msg.todo_user_type=#{todoUserType}</if>
			<if test="todoOrg != null" >and msg.todo_org=#{todoOrg}</if>
			<if test="state != null" >and msg.state=#{state}</if>
			<if test="isRead != null and isRead != ''" >and msg.is_read=#{isRead}</if>
			<if test="type == null and type == ''" >and msg.type in ('SYS','HELPER','SPSTASK','YRC')</if>
			<if test="type != null and type != '' and type == 'SYS'" >and msg.type='SYS'</if>
			<if test="type != null and type != '' and type != 'SYS'" >and msg.type in ('HELPER','SPSTASK','YRC')</if>
			and msg.dr=0
		</trim>
		GROUP BY msg.message_id
		order by msg.create_dt desc -->
	</select>
	
	<select id="findMessageUserListCount" resultType="java.lang.Integer">
		select count(1) as value
		from sys_message m 
		left join cm_employee_audit e on m.data_id=e.emp_id
		left join sps_scheme s on e.area_id=s.area_id
		<if test="authority != 'ALL'"> 
			and s.scheme_id in (${authority})
		</if>
		left join bs_area a on e.area_id=a.area_id
		inner join sys_dictitem d on e.insurance_living_type=d.code and d.dictionary=93 and d.area_id=e.area_id
		inner join sys_dictitem c on e.identity_type=c.code and c.dictionary=89
		where m.type='HELPER' and m.dr=0
		<if test="state != null and state != ''" >and m.state = #{state}</if> 
		<if test="dataId != null and dataId != ''" >and m.data_id=#{dataId}</if> 
		<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
		<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
		<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
		<if test="messageId != null" >and m.message_id=#{messageId}</if>
		group by e.emp_id
	</select>
	
	<select id="messageUserList" resultType="com.xfs.msg.dto.MessageVo" parameterType="Object">
		select e.emp_id as empId,e.name as userName,e.identity_code as code,e.mobile,e.insurance_salary as insurance,e.fund_salary as fund
		,a.area_id as ctiyId,a.name as ctiyName,e.json,d.code as typeCode,d.name as typeName,m.message_id as msgId,m.state,m.is_read as isRead
		,e.insurance_fund_date as defaultInsuranceFundDate
		,e.head_photo as headPhoto,c.name as identityType
		from sys_message m 
		left join cm_employee_audit e on m.data_id=e.emp_id
		left join sps_scheme s on e.area_id=s.area_id
		<if test="authority != 'ALL'"> 
			and s.scheme_id in (${authority})
		</if>
		left join bs_area a on e.area_id=a.area_id
		inner join sys_dictitem d on e.insurance_living_type=d.code and d.dictionary=93 and d.area_id=e.area_id
		inner join sys_dictitem c on e.identity_type=c.code and c.dictionary=89
		where m.type='HELPER' and m.dr=0
		<if test="state != null and state != ''" >and m.state = #{state}</if> 
		<if test="dataId != null and dataId != ''" >and m.data_id=#{dataId}</if> 
		<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
		<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
		<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
		<if test="messageId != null" >and m.message_id=#{messageId}</if>
		group by e.emp_id
		order by m.create_dt desc
	</select>
	
	<select id="findMessageNumber" resultType="java.lang.Integer">
		select count(m.message_id) as value 
		from (
			(
				select m.message_id from sys_message m 
				where m.dr=0 and m.is_read='UNREAD' and m.type in('SYS') 
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				GROUP BY m.message_id 
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join cm_employee_audit cea on m.data_id=cea.emp_id and m.dr=0 and m.is_read='UNREAD' and m.type in('HELPER')
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				inner join sps_scheme s on cea.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
			 	</if>
				GROUP BY m.message_id
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.is_read='UNREAD' and m.type in('SPSTASK') 
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
			 	</if>
 				GROUP BY m.message_id
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.is_read='UNREAD' and m.type in('HR') 
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				inner join sps_scheme s on t.area_id=s.area_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
			 	</if>
 				GROUP BY m.message_id
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.is_read='UNREAD' and m.type in('YRC') 
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				inner join sps_scheme s on cea.scheme_id=s.scheme_id 
				<if test="authority != 'ALL'"> 
					and s.scheme_id in (${authority})
			 	</if>
				GROUP BY m.message_id
			)
			UNION all
			(
				select m.message_id from sys_message m 
				inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.is_read='UNREAD' and m.type in('YRC') and cea.scheme_id is null
				<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
				<!-- <if test="todoUser != null" >and m.todo_user=#{todoUser}</if> -->
				<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
				GROUP BY m.message_id
			)
		) m
	
		<!-- select count(m.message_id) as value
		from (select m.message_id 
			from sys_message m 
			left join cm_employee_audit cea on m.data_id=cea.emp_id 
			left join sps_scheme s on cea.area_id=s.area_id
	        <if test="authority != 'ALL'"> 
				and s.scheme_id in (${authority})
		 	</if>
			where m.dr=0 and m.is_read='UNREAD' and m.type in('SYS','HELPER','SPSTASK','YRC')
			<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
			<if test="todoUser != null" >and m.todo_user=#{todoUser}</if>
			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
			GROUP BY m.message_id
		) m -->
	</select>
	
	<select id="findMessageSysDetailsCount" resultType="java.lang.Integer">
		select count(1) as value
		from sys_message m 
		where m.type='SYS' and m.dr=0
		<!-- <if test="messageId != null and messageId != '' "> and message_id = #{messageId} </if> -->
		<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
		<if test="todoUser != null" >and m.todo_user=#{todoUser}</if>
		<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
	</select>
	
	<select id="findMessageSysDetailsList" resultMap="result_map_SYS_MESSAGE" parameterType="Object">
		select m.message_id,m.title,m.content
		from sys_message m 
		where m.type='SYS' and m.dr=0
		<if test="messageId != null and messageId != ''"> and message_id = #{messageId} </if>
		<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
		<if test="todoUser != null" >and m.todo_user=#{todoUser}</if>
		<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
		order by m.create_dt desc
	</select>

	<!--更新消息状态， 将该消息之前的同类消息设置为已读-->
	<update id="updateMessageStateByMessageId" parameterType="Object" >
		UPDATE sys_message
		SET state=#{state} , is_read=#{isRead}
		WHERE data_id=#{dataId} and todo_user=#{todoUser}
		<![CDATA[
		and  message_id <= #{messageId}
		]]>
		and state="TODO" AND is_read="UNREAD"
	</update>

	<select id="getMessgeByTodoUser" resultMap="result_map_SYS_MESSAGE" parameterType="Object">
		SELECT m.* FROM SYS_MESSAGE m WHERE message_id in (
		SELECT MAX(message_id) FROM SYS_MESSAGE
		WHERE todo_user=#{todoUser}  AND  state=#{state} AND is_read=#{isRead}
		GROUP  BY data_id);

	</select>
	<!-- 查询消息待办提醒列表 -->
	<select id="findTodoRemindList" resultMap="result_map_SYS_MESSAGE" parameterType="Object">
		select * from (
			( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
			,'系统消息' as short_name
			,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
			from sys_message m
			where m.dr=0 and m.type in('SYS')
			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
			<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
			<if test="state != null" >and m.state=#{state}</if>
			<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
			GROUP BY m.message_id 
			)
			UNION all
			( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
			,'员工端' as short_name
			,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
 			from sys_message m 
 			inner join cm_employee_audit cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('HELPER') 
 			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
			<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
			<if test="state != null" >and m.state=#{state}</if>
			<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
 			inner join sps_scheme s on cea.area_id=s.area_id 
 			<if test="authority != 'ALL'"> 
				and s.scheme_id in (${authority})
			</if>
 			GROUP BY m.message_id 
			)
			UNION all
			( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
			,'员工端' as short_name
			,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
 			from sys_message m 
			inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('SPSTASK')
			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
			<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
			<if test="state != null" >and m.state=#{state}</if>
			<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
			inner join sps_scheme s on t.area_id=s.area_id 
			<if test="authority != 'ALL'"> 
				and s.scheme_id in (${authority})
			</if>
 			GROUP BY m.message_id 
			)
			UNION all
			( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
			,'信息收集' as short_name
			,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
 			from sys_message m 
			inner join sps_task t on m.data_id=t.task_id and m.dr=0 and m.type in('HR')
			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
			<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
			<if test="state != null" >and m.state=#{state}</if>
			<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
			inner join sps_scheme s on t.area_id=s.area_id 
			<if test="authority != 'ALL'"> 
				and s.scheme_id in (${authority})
			</if>
 			GROUP BY m.message_id 
			)
			UNION all
			( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
			,'人事' as short_name
			,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
 			from sys_message m 
			inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC')
			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
			<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
			<if test="state != null" >and m.state=#{state}</if>
			<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
			inner join sps_scheme s on cea.scheme_id=s.scheme_id 
			<if test="authority != 'ALL'"> 
				and s.scheme_id in (${authority})
			</if>
			GROUP BY m.message_id 
			)
			UNION all
			( select m.message_id,m.create_dt,m.title,m.state,m.url,m.data_id,NOW() AS modifyDt ,m.type,m.is_read
			,'人事' as short_name
			,SUBSTRING_INDEX(SUBSTRING_INDEX(m.title,'「',-1), '」', 1) as userName
 			from sys_message m 
			inner join cm_employee cea on m.data_id=cea.emp_id and m.dr=0 and m.type in('YRC') and cea.scheme_id is null
			<if test="todoUserType != null" >and m.todo_user_type=#{todoUserType}</if>
			<if test="todoOrg != null" >and m.todo_org=#{todoOrg}</if>
			<if test="state != null" >and m.state=#{state}</if>
			<if test="isRead != null and isRead != ''" >and m.is_read=#{isRead}</if>
			GROUP BY m.message_id 
			)
		) m 
		order by m.create_dt desc
		LIMIT 10
	</select>

</mapper>   
