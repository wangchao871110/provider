<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SPS_MALL_ORDER" > 
<!-- Result Map-->
<resultMap id="result_map_SPS_MALL_ORDER" type="com.xfs.mall.order.model.SpsMallOrder" >
	<result column="order_id" property="orderId"/>
	<result column="customer_id" property="customerId"/>
	<result column="product_id" property="productId"/>
	<result column="sp_id" property="spId"/>
	<result column="order_no" property="orderNo"/>
	<result column="cusomer_name" property="cusomerName"/>
	<result column="order_type" property="orderType"/>
	<result column="order_state" property="orderState"/>
	<result column="order_online_type" property="orderOnlineType"/>
	<result column="per_month" property="perMonth"/>
	<result column="per_month_price" property="perMonthPrice"/>
	<result column="once" property="once"/>
	<result column="order_star" property="orderStar"/>
	<result column="appraise" property="appraise"/>
    <result column="appraise_dt" property="appraiseDt"/>
	<result column="once_price" property="oncePrice"/>
	<result column="orderby" property="orderby"/>
	<result column="create_by" property="createBy"/>
	<result column="create_dt" property="createDt"/>
	<result column="modify_by" property="modifyBy"/>
	<result column="modify_dt" property="modifyDt"/>
	<result column="dr" property="dr"/>
    <!-- 合同id -->
    <result column="contract_id" property="contractId"/>
    <result column="file_id" property="fileId"/>

</resultMap>
       
<!-- sps_mall_order table all fields -->
<sql id="Base_Column_List" >
	 order_id,customer_id,order_star,product_id,sp_id,order_no,cusomer_name,order_type,order_state,order_online_type,per_month,per_month_price,once,appraise,once_price,orderby,create_by,create_dt,modify_by,modify_dt,dr
</sql>

<!-- 查询条件 -->
<sql id="Example_Where_Clause">
  <trim prefix=" WHERE " prefixOverrides="AND ">
	<if test="orderId != null" >and order_id = #{orderId}</if>
	<if test="customerId != null" >and customer_id = #{customerId}</if>
	<if test="productId != null" >and product_id = #{productId}</if>
	<if test="spId != null" >and sp_id = #{spId}</if>
	<if test="orderNo != null" >and order_no = #{orderNo}</if>
	<if test="cusomerName != null" >and cusomer_name = #{cusomerName}</if>
	<if test="orderType != null" >and order_type = #{orderType}</if>
	<if test="orderState != null" >and order_state = #{orderState}</if>
	<if test="orderOnlineType != null">and order_online_type = #{orderOnlineType}</if>
	<if test="perMonth != null" >and per_month = #{perMonth}</if>
	<if test="perMonthPrice != null" >and per_month_price = #{perMonthPrice}</if>
	<if test="once != null" >and once = #{once}</if>
	<if test="appraise != null" >and appraise = #{appraise}</if>
	<if test="oncePrice != null" >and once_price = #{oncePrice}</if>
	<if test="orderby != null" >and orderby = #{orderby}</if>
	<if test="createBy != null" >and create_by = #{createBy}</if>
	<if test="createDt != null" >and create_dt = #{createDt}</if>
	<if test="modifyBy != null" >and modify_by = #{modifyBy}</if>
	<if test="modifyDt != null" >and modify_dt = #{modifyDt}</if>
	<if test="dr != null" >and dr = #{dr}</if>
</trim>
</sql>

<!-- 查询条件 带模糊查询 以及 时间起始查询 -->
<sql id="Example_Where_Clause2">
  <trim prefix=" WHERE " prefixOverrides="AND ">
    <if test="orderId != null">AND order_id = '${orderId}'</if>
    <if test="customerId != null">AND customer_id = '${customerId}'</if>
    <if test="productId != null">AND product_id = '${productId}'</if>
    <if test="spId != null">AND sp_id = '${spId}'</if>
    <if test="orderNo != null">AND order_no like '%${orderNo}%'</if>
    <if test="orderNoEq != null">AND order_no = #{orderNoEq}</if>
    <if test="cusomerName != null">AND cusomer_name like '%${cusomerName}%'</if>
    <if test="cusomerNameEq != null">AND cusomer_name = #{cusomerNameEq}</if>
    <if test="orderType != null">AND order_type like '%${orderType}%'</if>
    <if test="orderTypeEq != null">AND order_type = #{orderTypeEq}</if>
    <if test="orderState != null">AND order_state like '%${orderState}%'</if>
    <if test="orderStateEq != null">AND order_state = #{orderStateEq}</if>
	<if test="orderOnlineType != null">and order_online_type = #{orderOnlineType}</if>
    <if test="perMonth != null">AND per_month like '%${perMonth}%'</if>
    <if test="perMonthEq != null">AND per_month = #{perMonthEq}</if>
    <if test="perMonthPrice != null">AND per_month_price like '%${perMonthPrice}%'</if>
    <if test="once != null">AND once like '%${once}%'</if>
    <if test="onceEq != null">AND once = #{onceEq}</if>
    <if test="appraise != null">AND appraise like '%${appraise}%'</if>
    <if test="appraiseEq != null">AND appraise = #{appraiseEq}</if>
    <if test="oncePrice != null">AND once_price like '%${oncePrice}%'</if>
    <if test="orderby != null">AND orderby like '%${orderby}%'</if>
    <if test="createBy != null">AND create_by = '%${createBy}%'</if>
    <if test="createDt != null">AND create_dt = #{createDt}</if>
    <if test="createDtFrom != null">AND create_dt&gt;=#{createDtFrom}</if>
	<if test="createDtTo != null">AND create_dt&lt;=#{createDtTo}</if>
    <if test="modifyBy != null">AND modify_by = '%${modifyBy}%'</if>
    <if test="modifyDt != null">AND modify_dt = #{modifyDt}</if>
    <if test="modifyDtFrom != null">AND modify_dt&gt;=#{modifyDtFrom}</if>
	<if test="modifyDtTo != null">AND modify_dt&lt;=#{modifyDtTo}</if>
    <if test="dr != null">AND dr like '%${dr}%'</if>
  </trim>
</sql>

<!-- 插入记录 -->
<insert id="InsertSPS_MALL_ORDER" parameterType="Object" >
  INSERT INTO SPS_MALL_ORDER (
  <trim prefix=" " prefixOverrides=",">
	<if test="orderId != null ">,order_id</if>
	<if test="customerId != null ">,customer_id</if>
	<if test="productId != null ">,product_id</if>
	<if test="spId != null ">,sp_id</if>
	<if test="orderNo != null ">,order_no</if>
	<if test="cusomerName != null ">,cusomer_name</if>
	<if test="orderType != null ">,order_type</if>
	<if test="orderState != null ">,order_state</if>
	<if test="orderOnlineType != null ">,order_online_type</if>
	<if test="perMonth != null ">,per_month</if>
	<if test="perMonthPrice != null ">,per_month_price</if>
	<if test="once != null ">,once</if>
	<if test="appraise != null ">,appraise</if>
	<if test="oncePrice != null ">,once_price</if>
	<if test="orderby != null ">,orderby</if>
	<if test="createBy != null ">,create_by</if>
	<if test="createDt != null ">,create_dt</if>
	<if test="modifyBy != null ">,modify_by</if>
	<if test="modifyDt != null ">,modify_dt</if>
	<if test="dr != null ">,dr</if>
  </trim>
  )  VALUES (
  <trim prefix=" " prefixOverrides=",">
	<if test="orderId != null ">,#{orderId}</if>
	<if test="customerId != null ">,#{customerId}</if>
	<if test="productId != null ">,#{productId}</if>
	<if test="spId != null ">,#{spId}</if>
	<if test="orderNo != null ">,#{orderNo}</if>
	<if test="cusomerName != null ">,#{cusomerName}</if>
	<if test="orderType != null ">,#{orderType}</if>
	<if test="orderState != null ">,#{orderState}</if>
	<if test="orderOnlineType != null ">,#{orderOnlineType}</if>
	<if test="perMonth != null ">,#{perMonth}</if>
	<if test="perMonthPrice != null ">,#{perMonthPrice}</if>
	<if test="once != null ">,#{once}</if>
	<if test="appraise != null ">,#{appraise}</if>
	<if test="oncePrice != null ">,#{oncePrice}</if>
	<if test="orderby != null ">,#{orderby}</if>
	<if test="createBy != null ">,#{createBy}</if>
	<if test="createDt != null ">,#{createDt}</if>
	<if test="modifyBy != null ">,#{modifyBy}</if>
	<if test="modifyDt != null ">,#{modifyDt}</if>
	<if test="dr != null ">,#{dr}</if>
  </trim>
  )
  <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="orderId">
	SELECT LAST_INSERT_ID() AS ORDER_ID
  </selectKey>
</insert>

<!-- 根据id，修改记录-->  
<update id="UpdateSPS_MALL_ORDER" parameterType="Object" >
UPDATE SPS_MALL_ORDER 
  <trim prefix=" SET " prefixOverrides=",">
	<if test="orderId != null ">,order_id=#{orderId}</if>
	<if test="customerId != null ">,customer_id=#{customerId}</if>
	<if test="productId != null ">,product_id=#{productId}</if>
	<if test="spId != null ">,sp_id=#{spId}</if>
	<if test="orderNo != null ">,order_no=#{orderNo}</if>
	<if test="orderStar != null " >,order_star=#{orderStar}</if>
	<if test="cusomerName != null ">,cusomer_name=#{cusomerName}</if>
	<if test="orderType != null ">,order_type=#{orderType}</if>
	<if test="orderState != null ">,order_state=#{orderState}</if>
	<if test="orderOnlineType != null ">,order_online_type=#{orderOnlineType}</if>
	<if test="perMonth != null ">,per_month=#{perMonth}</if>
	<if test="perMonthPrice != null ">,per_month_price=#{perMonthPrice}</if>
	<if test="once != null ">,once=#{once}</if>
    <if test="appraiseDt != null ">,appraise_dt=#{appraiseDt}</if>
	<if test="appraise != null ">,appraise=#{appraise}</if>
	<if test="oncePrice != null ">,once_price=#{oncePrice}</if>
	<if test="orderby != null ">,orderby=#{orderby}</if>
	<if test="createBy != null ">,create_by=#{createBy}</if>
	<if test="createDt != null ">,create_dt=#{createDt}</if>
	<if test="modifyBy != null ">,modify_by=#{modifyBy}</if>
	<if test="modifyDt != null ">,modify_dt=#{modifyDt}</if>
	<if test="dr != null ">,dr=#{dr}</if>
  </trim>
WHERE ORDER_ID=#{orderId}
 	<if test="customerId != null "> AND customer_id=#{customerId}</if>
</update>
 
<!-- 删除记录 -->
<delete id="DeleteSPS_MALL_ORDER">
	DELETE FROM SPS_MALL_ORDER WHERE ORDER_ID=#{orderId} AND customer_id=#{customerId}
</delete>
<!-- 订单表 列表总数-->
<select id="CountFindAllSPS_MALL_ORDER" resultType="java.lang.Integer">SELECT count(1) as value FROM SPS_MALL_ORDER</select>
<select id="CountSPS_MALL_ORDER" resultType="java.lang.Integer">SELECT count(1) as value FROM SPS_MALL_ORDER WHERE ORDER_ID=#{orderId}</select>
<!-- 根据id查询 订单表 -->
<select id="FindByPK" resultMap="result_map_SPS_MALL_ORDER" parameterType="Object">SELECT <include refid="Base_Column_List" /> FROM SPS_MALL_ORDER WHERE ORDER_ID=#{orderId}</select>

<!-- 根据各字段条件带模糊查询  订单表 -->
<select id="FreeFindSPS_MALL_ORDER" resultMap="result_map_SPS_MALL_ORDER" parameterType="Object">
	SELECT <include refid="Base_Column_List" /> FROM SPS_MALL_ORDER 
	 <include refid="Example_Where_Clause2" />
</select>
<!-- 根据各字段条件带模糊查询  订单表 记录数 -->
<select id="CountFreeFindSPS_MALL_ORDER" resultType="java.lang.Integer">
SELECT count(1) as value FROM SPS_MALL_ORDER 
 <include refid="Example_Where_Clause2" />
</select>
<!-- 根据各字段条件带排序  订单表 -->
<select id="FreeFindSPS_MALL_ORDEROrdered" resultMap="result_map_SPS_MALL_ORDER" parameterType="Object">
	SELECT <include refid="Base_Column_List" /> FROM SPS_MALL_ORDER 
	 <include refid="Example_Where_Clause2" />
	 ORDER BY ${_orderBy}
</select>

<!-- *****************************  温馨提示：  ***************************** -->
<!-- **                                                                    ** -->
<!-- ** 以上为自动生成代码，请勿改动或删除。如有新sql添加请在下方区域内填写** -->
<!-- **                                             ** 2016/06/07 11:31:06 ** -->
<!-- ************************************************************************ -->

	<!-- 我的订单视图  -->
	<resultMap id="result_map_MY_ORDER_DTO" type="com.xfs.insurance.dto.MyOrder" >
		<result column="order_id" property="orderId"/>
		<result column="order_no" property="orderNo"/>
		<result column="cusomer_name" property="cusomerName"/>
		<result column="sp_name" property="spName"/>
		<result column="product_name" property="productName"/>
		<result column="per_month_price" property="perMonthPrice"/>
		<result column="once_price" property="oncePrice"/>
		<result column="order_state" property="orderState"/>
		<result column="create_dt" property="createDt"/>
		<result column="appraise" property="appraise"/>
		<result column="appraise_dt" property="appraiseDt"/>
		<result column="per_month" property="perMonth"/>
		<result column="once" property="once"/>
		<result column="photo" property="photo" />
		<result column="product_des" property="productDes" />
		<result column="ci_id" property="ciId" />
		<result column="order_online_type" property="orderOnlineType" />
		<result column="file_id" property="fileId" />
	</resultMap>

	<!-- 查询符合条件的订单列表 -->
	<select id="QUERY_CONDITION_SPS_MALL_ORDER_LIST" resultMap="result_map_MY_ORDER_DTO" parameterType="Object">
		SELECT ord.order_id as order_id,ord.order_star,ord.order_no as order_no, ss.sp_name as sp_name , pro.product_name as product_name,
			pro.`photo`, pro.`product_des`, ord.per_month_price as per_month_price, ord.once_price as once_price, ord.order_state as order_state,
			ord.create_dt as create_dt, ord.appraise_dt as appraise_dt, ord.appraise as appraise,ord.per_month,ord.once,co.id as ci_id,
			ord.order_online_type, ct.file_id
		FROM  sps_mall_order ord
		INNER join  sps_mall_product pro on ord.product_id = pro.product_id
		INNER join  sp_service ss on pro.sp_id = ss.sp_id
		left join sps_ci_order co on ord.order_id = co.order_id
		left join cm_contract ct on ord.order_id = ct.order_id and ct.state = 'USE'
		WHERE ord.customer_id = #{cpid} and ord.dr = 0
		<if test="orderState != null" > and ord.order_state = #{orderState}</if>
		<if test="searchWord != null "> AND (ss.sp_name like '%${searchWord}%' OR ord.order_no LIKE '%${searchWord}%' OR pro.product_name LIKE '%${searchWord}%')</if>
		<if test="createDtFrom != null"> AND ord.create_dt&gt;=#{createDtFrom}</if>
		<if test="createDtTo != null"> AND ord.create_dt&lt;=#{createDtTo}</if>
		ORDER BY  ord.order_id  Desc
	</select>
	<!-- 查询符合条件的订单个数 -->
	<select id="QUERY_CONDITION_SPS_MALL_ORDER_LIST_COUNT" resultType="java.lang.Integer" parameterType="Object">
		SELECT COUNT(1) FROM  sps_mall_order ord
		INNER join  sps_mall_product pro on ord.product_id = pro.product_id
		INNER join  sp_service ss on pro.sp_id = ss.sp_id
		left join sps_ci_order co on ord.order_id = co.order_id
		WHERE ord.customer_id = #{cpid} and ord.dr = 0
		<if test="orderState != null" > and ord.order_state = #{orderState}</if>
		<if test="searchWord != null "> AND (ss.sp_name like '%${searchWord}%' OR ord.order_no LIKE '%${searchWord}%' OR pro.product_name LIKE '%${searchWord}%')</if>
		<if test="createDtFrom != null"> AND ord.create_dt&gt;=#{createDtFrom}</if>
		<if test="createDtTo != null"> AND ord.create_dt&lt;=#{createDtTo}</if>
		ORDER BY  ord.order_id  Desc
	</select>
	<!-- 查询符合条件的订单 -->
	<select id="FIND_CS_MALL_ORDER" resultMap="result_map_MY_ORDER_DTO" parameterType="Object">
		SELECT ord.order_id as order_id,ord.appraise as appraise, ord.order_no as order_no, ss.sp_name as sp_name , pro.product_name as product_name, ord.per_month_price as per_month_price, ord.once_price as once_price, ord.order_state as order_state, ord.create_dt as create_dt
		FROM  sps_mall_order ord
		INNER join  sps_mall_product pro on ord.product_id = pro.product_id
		INNER join  sp_service ss on pro.sp_id = ss.sp_id
		WHERE ord.order_id = #{orderId} AND ord.customer_id = #{customerId}
	</select>

	<!-- 根据各字段条件带模糊查询  订单表 记录数 -->
	<select id="CountFind_SPS_MALL_ORDER" resultType="java.lang.Integer">
		SELECT count(1) as value FROM SPS_MALL_ORDER o INNER JOIN sps_mall_product p on o.product_id=p.product_id
		<trim prefix=" WHERE " prefixOverrides="AND ">
			<if test="spId != null">AND o.sp_id = #{spId}</if>
			<if test="orderType != null">AND o.order_type = #{orderType}</if>
			<if test="orderState != null">AND o.order_state = #{orderState}</if>
			<if test="orderId != null">AND o.order_id = #{orderId}</if>
			<if test="dr != null">AND o.dr = #{dr}</if>
			<if test="searchContent != null">AND (p.product_name like '%${searchContent}%' or o.order_no like '%${searchContent}%')</if>
		</trim>
	</select>
	<!-- 根据orderId查询 订单及产品信息 -->
	<select id="Find_SPS_MALL_ORDER" resultMap="result_map_SPS_MALL_ORDER" parameterType="Object">
		SELECT o.*,p.product_name as productName,co.id as ci_id,corp.contact_psn,corp.mobile as contact_num, ct.contract_id, ct.file_id FROM SPS_MALL_ORDER o
		INNER JOIN sps_mall_product p on o.product_id=p.product_id
		left join sps_ci_order co on o.order_id = co.order_id
		left join cm_corp corp on corp.cp_id = o.customer_id
		left join cm_contract ct on o.order_id = ct.order_id and ct.state = 'USE' and ct.online_type = 'OFFLINE'
		<trim prefix=" WHERE " prefixOverrides="AND ">
			<if test="spId != null">AND o.sp_id = #{spId}</if>
			<if test="orderType != null">AND o.order_type = #{orderType}</if>
			<if test="orderState != null">AND o.order_state = #{orderState}</if>
			<if test="orderId != null">AND o.order_id = #{orderId}</if>
			<if test="dr != null">AND o.dr = #{dr}</if>
			<if test="searchContent != null">AND (p.product_name like '%${searchContent}%' or o.order_no like '%${searchContent}%')</if>
		</trim>
		order by o.order_id desc
	</select>
	<!-- 查询 订单明细 项目信息  -->
	<select id="findOrderItems" resultType="java.util.Map" parameterType="Object">
		SELECT i.*,item.item_name
		FROM sps_mall_order o
		INNER JOIN sps_mall_order_item i ON o.order_id = i.order_id
		AND o.product_id = i.product_id
		INNER JOIN bs_mall_Item item ON i.item_id = item.item_id
		where o.order_id = #{orderId}
	</select>

	<!-- 商保订单视图  -->
	<resultMap id="result_map_MY_CI_ORDER_DTO" type="com.xfs.insurance.dto.MyCiOrder" >
		<result column="order_id" property="orderId"/>
		<result column="order_no" property="orderNo"/>
		<result column="order_state" property="orderState"/>
		<result column="sp_name" property="spName"/>
		<result column="transaction_date" property="transactionDate"/>
		<result column="product_name" property="productName"/>
		<result column="total_price" property="totalPrice"/>
		<result column="corp_name" property="corpName"/>
		<result column="corp_license_num" property="corpLicenseNum"/>
		<result column="contacts" property="contacts"/>
		<result column="contact_phone" property="contactPhone"/>
		<result column="appraise" property="appraise"/>
		<result column="amount" property="amount"/>
	</resultMap>
	<!--商保订单详情-->
	<select id="FIND_SPS_MALL_CI_ORDER" resultMap="result_map_MY_CI_ORDER_DTO" parameterType="Object">
		select ord.order_no,ord.order_id,ord.order_state,sp.sp_name,ord.create_dt as transaction_date,pro.product_name,co.total_price,ord.cusomer_name as corp_name,co.busi_license_num as corp_license_num,co.contacts,co.contact_phone,co.amount,ord.appraise from sps_mall_order ord
		left join sps_ci_order co on ord.order_id = co.order_id
		LEFT JOIN sp_service sp on ord.sp_id = sp.sp_id
		LEFT JOIN sps_mall_product pro on ord.product_id = pro.product_id
		where ord.order_id=#{orderId}
		<if test="customerId != null"> and ord.customer_id = #{customerId}</if>
		<if test="spId != null"> and ord.sp_id = #{spId}</if>
	</select>


	<!-- 评论订单视图  -->
	<resultMap id="RESULT_MAP_APPRAISEORDER_DTO" type="com.xfs.bs.dto.AppraiseOrder" >
		<result column="order_id" property="orderId"/>
		<result column="order_no" property="orderNo"/>
		<result column="sp_name" property="spName"/>
		<result column="product_name" property="productName"/>
		<result column="per_month_price" property="perMonthPrice"/>
		<result column="once_price" property="oncePrice"/>
		<result column="order_state" property="orderState"/>
		<result column="create_dt" property="createDt"/>
		<result column="order_star" property="orderStar"/>
		<result column="appraise" property="appraise"/>
		<result column="appraise_dt" property="appraiseDt"/>
		<result column="cusomer_name" property="cusomerName"/>
		<result column="appraise_show" property="appraiseShow"/>
	</resultMap>

	<!-- 查询符合条件的订单列表 -->
	<select id="QUERY_ORDER_APPRAISEORDER_LIST" resultMap="RESULT_MAP_APPRAISEORDER_DTO" parameterType="Object">
		select my_order.order_id as order_id, my_order.appraise_show as appraise_show, my_order.appraise as appraise, my_order.order_no as order_no, my_order.sp_name as sp_name , my_order.product_name as product_name, my_order.per_month_price as per_month_price, my_order.once_price as once_price, my_order.order_state as order_state, my_order.create_dt as create_dt,my_order.appraise_dt as appraise_dt, my_order.cusomer_name as cusomer_name,my_order.order_star as order_star
		from
		( select ord.*, pro.product_name as product_name, sse.sp_name as sp_name from sps_mall_order ord
		left join  sps_mall_product pro
		on ord.product_id = pro.product_id
		left join sp_service sse
		on ord.sp_id = sse.sp_id ) as my_order
		<include refid="CONDITION_ORDER_SQL" />
		ORDER BY  my_order.order_id  Desc
	</select>

	<sql id="CONDITION_ORDER_SQL">
		<trim prefix=" WHERE " prefixOverrides="AND ">
			<if test="orderState != null" >and order_state = #{orderState}</if>
			<if test="cusomerName != null "> AND cusomer_name like '%${searchWord}%'</if>
			<if test="createDtFrom != null">AND create_dt&gt;=#{createDtFrom}</if>
			<if test="createDtTo != null">AND create_dt&lt;=#{createDtTo}</if>
		</trim>
	</sql>

	<!-- 查询符合条件的订单个数 -->
	<select id="QUERY_ORDER_APPRAISEORDER_LIST_COUNT" resultType="java.lang.Integer" parameterType="Object">
		select count(1) from
		( select ord.*, pro.product_name as product_name, sse.sp_name as sp_name from sps_mall_order ord
		left join  sps_mall_product pro
		on ord.product_id = pro.product_id
		left join sp_service sse
		on ord.sp_id = sse.sp_id ) as my_order
		<include refid="CONDITION_ORDER_SQL" />
	</select>

	<select id="countCiOrder" resultType="java.lang.Integer" parameterType="Object">
		select count(1)
		from sps_mall_order mo
		inner join sps_ci_order co on mo.order_id = co.order_id and mo.dr = 0
		inner join sps_mall_product mp on mp.product_id = mo.product_id
		inner join bs_mall_item mi on mi.item_id = mp.agent_ci_id
		inner join bs_ci_product cp on cp.mall_item_id = mi.item_id
		inner join sp_service ss on ss.sp_id = mo.sp_id
		<if test="categoryId != null" >inner join bs_mall_item_category mic on mi.category_id = mic.category_id and mi.category_id = #{categoryId}</if>
		where 1=1
		<if test="orderState != null and orderState != ''" > and mo.order_state = #{orderState} </if>
		<if test="orderNo != null and orderNo != ''" > and mo.order_no = #{orderNo} </if>
	</select>
	<select id="queryCiOrder" resultType="com.xfs.insurance.dto.CiOrder" parameterType="Object">
		select mo.order_no, mo.order_id, mp.product_name, mo.cusomer_name, mo.order_state, mo.sp_id, co.amount, co.total_price,
		co.contacts, co.contact_phone, ss.short_name as sp_name, mo.create_dt, co.busi_license_num, cp.ins_time,cp.charge_way
		from sps_mall_order mo
		inner join sps_ci_order co on mo.order_id = co.order_id and mo.dr = 0
		inner join sps_mall_product mp on mp.product_id = mo.product_id
		inner join bs_mall_item mi on mi.item_id = mp.agent_ci_id
		inner join bs_ci_product cp on cp.mall_item_id = mi.item_id
		inner join sp_service ss on ss.sp_id = mo.sp_id
		<if test="categoryId != null" >inner join bs_mall_item_category mic on mi.category_id = mic.category_id and mi.category_id = #{categoryId}</if>
		where 1=1
		<if test="orderState != null and orderState != ''" > and mo.order_state = #{orderState} </if>
		<if test="orderNo != null and orderNo != ''" > and mo.order_no = #{orderNo} </if>
	</select>

	<!-- <select id="queryMallOrder" resultType="java.util.Map" parameterType="Object">
		select mo.order_no, mo.order_id, mp.product_name, mo.per_month,mo.per_month_price,
		mo.once,mo.once_price,
		mo.cusomer_name, mo.order_state, mo.sp_id,cc.contact_psn,cc.mobile,
		ss.short_name as sp_name, mo.create_dt
		from sps_mall_order mo
		inner join cm_corp cc on cc.cp_id = mo.customer_id
		inner join sps_mall_product mp on mp.product_id = mo.product_id
		inner join sp_service ss on ss.sp_id = mo.sp_id
		WHERE mp.agent_group_id is null
		<if test="orderState != null and orderState != ''" > and mo.order_state = #{orderState} </if>
		<if test="orderNo != null and orderNo != ''" > and mo.order_no = #{orderNo} </if>
	</select>

	<select id="countMallOrder" resultType="java.lang.Integer" parameterType="Object">
		select count(1)
		from sps_mall_order mo
		inner join cm_corp cc on cc.cp_id = mo.customer_id
		inner join sps_mall_product mp on mp.product_id = mo.product_id
		inner join sp_service ss on ss.sp_id = mo.sp_id
		WHERE mp.agent_group_id is null
		<if test="orderState != null and orderState != ''" > and mo.order_state = #{orderState} </if>
		<if test="orderNo != null and orderNo != ''" > and mo.order_no = #{orderNo} </if>
	</select> -->

	<select id="queryMallOrder" resultType="java.util.Map" parameterType="Object">
		select mo.order_no, mo.order_id, mp.product_name, mo.per_month,mo.per_month_price,
		mo.once,mo.once_price,mo.order_online_type,cm.file_id,
		mo.cusomer_name, mo.order_state, mo.sp_id,cc.contact_psn,cc.mobile,
		ss.short_name as sp_name, mo.create_dt
		from sps_mall_order mo
		LEFT join cm_corp cc on cc.cp_id = mo.customer_id
		LEFT join sps_mall_product mp on mp.product_id = mo.product_id
		LEFT join sp_service ss on ss.sp_id = mo.sp_id
		LEFT JOIN cm_contract cm ON cm.order_id = mo.order_id AND cm.state='USE'
		WHERE mp.agent_ci_id is null
		<if test="orderState != null and orderState != ''" > and mo.order_state = #{orderState}  </if>
		<if test="orderNo != null and orderNo != ''" > and mo.order_no = #{orderNo} </if>
		<if test="shortName != null and shortName != ''" > and ss.short_name like concat('%',#{shortName},'%') </if>
		<if test="cusomerName != null and cusomerName != ''" > and mo.cusomer_name like concat('%',#{cusomerName},'%') </if>
		<if test="startTime != null and startTime != ''" > and #{startTime } &lt;= mo.create_dt </if>
		<if test="endTime != null and endTime != ''" > and concat(#{endTime }, ' 23:59:59') &gt;= mo.create_dt </if>
		AND mo.dr=0
		order by mo.create_dt DESC
	</select>

	<select id="countMallOrder" resultType="java.lang.Integer" parameterType="Object">
		select count(1)
		from sps_mall_order mo
		LEFT join cm_corp cc on cc.cp_id = mo.customer_id
		LEFT join sps_mall_product mp on mp.product_id = mo.product_id
		LEFT join sp_service ss on ss.sp_id = mo.sp_id
		LEFT JOIN cm_contract cm ON cm.order_id = mo.order_id AND cm.state='USE'
		WHERE mp.agent_ci_id is null
		<if test="orderState != null and orderState != ''" > and mo.order_state = #{orderState}  </if>
		<if test="orderNo != null and orderNo != ''" > and mo.order_no = #{orderNo} </if>
		<if test="shortName != null and shortName != ''" > and ss.short_name like concat('%',#{shortName},'%')  </if>
		<if test="cusomerName != null and cusomerName != ''" > and mo.cusomer_name like concat('%',#{cusomerName},'%') </if>
		<if test="startTime != null and startTime != ''" > and #{startTime } &lt;= mo.create_dt </if>
		<if test="endTime != null and endTime != ''" > and concat(#{endTime }, ' 23:59:59') &gt;= mo.create_dt </if>
		AND mo.dr=0
	</select>

	<select id="queryList" resultType="java.util.Map" parameterType="Object">
		SELECT mo.order_no, mo.order_id,mp.product_name,mo.create_dt,sp.sp_id,sp.sp_name,mo.order_state
		FROM sps_mall_order mo
		LEFT JOIN sps_mall_product mp ON mp.product_id = mo.product_id
		LEFT JOIN sp_service sp ON sp.sp_id = mo.sp_id
		<if test="order_id != null and order_id != ''" > where mo.order_id = #{order_id} </if>
	</select>

	<select id="queryitem" resultType="java.util.Map" parameterType="Object">
		SELECT spm.order_id,bm.item_id,bm.item_name,spm.feetype,spm.price
		FROM sps_mall_order_item spm
		LEFT JOIN bs_mall_item bm ON bm.item_id = spm.item_id
		WHERE bm.item_id IS NOT NULL
		and spm.order_id = #{order_id}
	</select>
	<select id="countitem" resultType="java.lang.Integer" parameterType="Object">
		SELECT count(1)
		FROM sps_mall_order_item spm
		LEFT JOIN bs_mall_item bm ON bm.item_id = spm.item_id
		WHERE bm.item_id IS NOT NULL
		and spm.order_id = #{order_id}
	</select>
	<!-- 修改线下订单状态、线下合同 -->
	<update id="updateState" parameterType="Object">
		UPDATE cm_contract co , cm_corp  rp , sps_mall_order  so
		SET
		<if test="orderState == 'SIGN'">co.contract_state = 2,rp.collaborator = co.collaborator,</if>
		so.order_state = #{orderState}
		where so.order_id = #{orderId} 
		<if test="orderState == 'SIGN'">
			and co.cp_id = rp.cp_id 
			and co.state = 'USE'
			and co.online_type = 'OFFLINE'
			AND so.order_id = co.order_id
		</if>
	</update>
</mapper>   
