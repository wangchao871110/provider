<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="OP_HRPLUS_COMMENT">
    <!-- Result Map-->
    <resultMap id="result_map_OP_HRPLUS_COMMENT" type="com.xfs.op.model.OpHrplusComment">
        <result column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="article_id" property="articleId"/>
        <result column="parent_comment" property="parentComment"/>
        <result column="content" property="content"/>
        <result column="article_type" property="articleType"/>
        <result column="anonymous" property="anonymous"/>
        <result column="dr" property="dr"/>
        <result column="create_dt" property="createDt"/>
        <result column="create_by" property="createBy"/>
        <result column="modify_dt" property="modifyDt"/>
        <result column="modify_by" property="modifyBy"/>
        <result column="upvote_num" property="upvoteNum"/>
        <result column="mongo_article_id" property="mongoArticleId"/>
    </resultMap>

    <!-- op_hrplus_comment table all fields -->
    <sql id="Base_Column_List">
	 id,user_id,article_id,parent_comment,content,article_type,anonymous,dr,create_dt,create_by,modify_dt,modify_by,upvote_num,mongo_article_id
</sql>

    <!-- 查询条件 -->
    <sql id="Example_Where_Clause">
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="id != null">and id = #{id}</if>
            <if test="userId != null">and user_id = #{userId}</if>
            <if test="articleId != null">and article_id = #{articleId}</if>
            <if test="parentComment != null">and parent_comment = #{parentComment}</if>
            <if test="content != null">and content = #{content}</if>
            <if test="articleType != null">and article_type = #{articleType}</if>
            <if test="anonymous != null">and anonymous = #{anonymous}</if>
            <if test="dr != null">and dr = #{dr}</if>
            <if test="createDt != null">and create_dt = #{createDt}</if>
            <if test="createBy != null">and create_by = #{createBy}</if>
            <if test="modifyDt != null">and modify_dt = #{modifyDt}</if>
            <if test="modifyBy != null">and modify_by = #{modifyBy}</if>
            <if test="upvoteNum != null">and upvote_num = #{upvoteNum}</if>
            <if test="mongoArticleId != null">and mongo_article_id = #{mongoArticleId}</if>
        </trim>
    </sql>

    <!-- 查询条件 带模糊查询 以及 时间起始查询 -->
    <sql id="Example_Where_Clause2">
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="id != null">AND id like '%${id}%'</if>
            <if test="userId != null">AND user_id like '%${userId}%'</if>
            <if test="articleId != null">AND article_id like '%${articleId}%'</if>
            <if test="parentComment != null">AND parent_comment like '%${parentComment}%'</if>
            <if test="content != null">AND content like '%${content}%'</if>
            <if test="contentEq != null">AND content = #{contentEq}</if>
            <if test="articleType != null">AND article_type like '%${articleType}%'</if>
            <if test="articleTypeEq != null">AND article_type = #{articleTypeEq}</if>
            <if test="anonymous != null">AND anonymous like '%${anonymous}%'</if>
            <if test="anonymousEq != null">AND anonymous = #{anonymousEq}</if>
            <if test="dr != null">AND dr like '%${dr}%'</if>
            <if test="drEq != null">AND dr = #{drEq}</if>
            <if test="createDt != null">AND create_dt = #{createDt}</if>
            <if test="createDtFrom != null">AND create_dt&gt;=#{createDtFrom}</if>
            <if test="createDtTo != null">AND create_dt&lt;=#{createDtTo}</if>
            <if test="createBy != null">AND create_by like '%${createBy}%'</if>
            <if test="modifyDt != null">AND modify_dt = #{modifyDt}</if>
            <if test="modifyDtFrom != null">AND modify_dt&gt;=#{modifyDtFrom}</if>
            <if test="modifyDtTo != null">AND modify_dt&lt;=#{modifyDtTo}</if>
            <if test="modifyBy != null">AND modify_by like '%${modifyBy}%'</if>
            <if test="upvoteNum != null">AND upvote_num&lt;=#{upvoteNum}</if>
        </trim>
    </sql>

    <!-- 插入记录 -->
    <insert id="InsertOP_HRPLUS_COMMENT" parameterType="Object">
        INSERT INTO OP_HRPLUS_COMMENT (
        <trim prefix=" " prefixOverrides=",">
            <if test="id != null ">,id</if>
            <if test="userId != null ">,user_id</if>
            <if test="articleId != null ">,article_id</if>
            <if test="parentComment != null ">,parent_comment</if>
            <if test="content != null ">,content</if>
            <if test="articleType != null ">,article_type</if>
            <if test="anonymous != null ">,anonymous</if>
            <if test="dr != null ">,dr</if>
            <if test="createDt != null ">,create_dt</if>
            <if test="createBy != null ">,create_by</if>
            <if test="modifyDt != null ">,modify_dt</if>
            <if test="modifyBy != null ">,modify_by</if>
            <if test="upvoteNum != null ">,upvote_num</if>
            <if test="mongoArticleId != null ">,mongo_article_id</if>
        </trim>
        ) VALUES (
        <trim prefix=" " prefixOverrides=",">
            <if test="id != null ">,#{id}</if>
            <if test="userId != null ">,#{userId}</if>
            <if test="articleId != null ">,#{articleId}</if>
            <if test="parentComment != null ">,#{parentComment}</if>
            <if test="content != null ">,#{content}</if>
            <if test="articleType != null ">,#{articleType}</if>
            <if test="anonymous != null ">,#{anonymous}</if>
            <if test="dr != null ">,#{dr}</if>
            <if test="createDt != null ">,#{createDt}</if>
            <if test="createBy != null ">,#{createBy}</if>
            <if test="modifyDt != null ">,#{modifyDt}</if>
            <if test="modifyBy != null ">,#{modifyBy}</if>
            <if test="upvoteNum != null ">,#{upvoteNum}</if>
            <if test="mongoArticleId != null ">,#{mongoArticleId}</if>
        </trim>
        )
        <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
            SELECT LAST_INSERT_ID() AS ID
        </selectKey>
    </insert>

    <!-- 根据id，修改记录-->
    <update id="UpdateOP_HRPLUS_COMMENT" parameterType="Object">
        UPDATE OP_HRPLUS_COMMENT
        <trim prefix=" SET " prefixOverrides=",">
            <if test="id != null ">,id=#{id}</if>
            <if test="userId != null ">,user_id=#{userId}</if>
            <if test="articleId != null ">,article_id=#{articleId}</if>
            <if test="parentComment != null ">,parent_comment=#{parentComment}</if>
            <if test="content != null ">,content=#{content}</if>
            <if test="articleType != null ">,article_type=#{articleType}</if>
            <if test="anonymous != null ">,anonymous=#{anonymous}</if>
            <if test="dr != null ">,dr=#{dr}</if>
            <if test="createDt != null ">,create_dt=#{createDt}</if>
            <if test="createBy != null ">,create_by=#{createBy}</if>
            <if test="modifyDt != null ">,modify_dt=#{modifyDt}</if>
            <if test="modifyBy != null ">,modify_by=#{modifyBy}</if>
            <if test="upvoteNum != null ">,upvote_num=#{upvoteNum}</if>
            <if test="mongoArticleId != null ">,mongo_article_id=#{mongoArticleId}</if>
        </trim>
        WHERE ID=#{id}
    </update>

    <!-- 删除记录 -->
    <delete id="DeleteOP_HRPLUS_COMMENT">DELETE FROM OP_HRPLUS_COMMENT WHERE ID=#{id}</delete>
    <!-- 薪福+评论表 列表总数-->
    <select id="CountFindAllOP_HRPLUS_COMMENT"
            resultType="java.lang.Integer">SELECT count(1) as value FROM OP_HRPLUS_COMMENT
    </select>
    <select id="CountOP_HRPLUS_COMMENT"
            resultType="java.lang.Integer">SELECT count(1) as value FROM OP_HRPLUS_COMMENT WHERE ID=#{id}
    </select>
    <!-- 根据id查询 薪福+评论表 -->
    <select id="FindByPK" resultMap="result_map_OP_HRPLUS_COMMENT" parameterType="Object">SELECT
        <include refid="Base_Column_List"/>
        FROM OP_HRPLUS_COMMENT WHERE ID=#{id}
    </select>

    <!-- 根据各字段条件带模糊查询  薪福+评论表 -->
    <select id="FreeFindOP_HRPLUS_COMMENT" resultMap="result_map_OP_HRPLUS_COMMENT" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM OP_HRPLUS_COMMENT
        <include refid="Example_Where_Clause2"/>
    </select>
    <!-- 根据各字段条件带模糊查询  薪福+评论表 记录数 -->
    <select id="CountFreeFindOP_HRPLUS_COMMENT" resultType="java.lang.Integer">
        SELECT count(1) as value FROM OP_HRPLUS_COMMENT
        <include refid="Example_Where_Clause2"/>
    </select>
    <!-- 根据各字段条件带排序  薪福+评论表 -->
    <select id="FreeFindOP_HRPLUS_COMMENTOrdered" resultMap="result_map_OP_HRPLUS_COMMENT" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM OP_HRPLUS_COMMENT
        <include refid="Example_Where_Clause2"/>
        ORDER BY ${_orderBy}
    </select>

    <!-- *****************************  温馨提示：  ***************************** -->
    <!-- **                                                                    ** -->
    <!-- ** 以上为自动生成代码，请勿改动或删除。如有新sql添加请在下方区域内填写** -->
    <!-- **                                             ** 2017/01/06 10:23:05 ** -->
    <!-- ************************************************************************ -->

    <!-- DtoResult Map-->
    <resultMap id="result_map_OP_HRPLUS_COMMENT_Dto" type="com.xfs.op.dto.OpHrplusCommentDto">
        <result column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="article_id" property="articleId"/>
        <result column="parent_comment" property="parentComment"/>
        <result column="content" property="content"/>
        <result column="article_type" property="articleType"/>
        <result column="anonymous" property="anonymous"/>
        <result column="dr" property="dr"/>
        <result column="create_dt" property="createDt"/>
        <result column="create_by" property="createBy"/>
        <result column="modify_dt" property="modifyDt"/>
        <result column="modify_by" property="modifyBy"/>
        <result column="nick_name" property="nickName"/>
        <result column="head_img" property="headImg"/>
        <result column="parent_content" property="parentContent"/>
        <result column="parent_nick_name" property="parentNickName"/>
        <result column="parent_head_img" property="parentHeadImg"/>
        <result column="corp_name" property="corpName"/>
        <result column="parent_corp_name" property="parentCorpName"/>
    </resultMap>

    <resultMap id="RESULT_MAP_OP_HRPLUS_DTO" type="com.xfs.op.dto.OpHrPlushDto">
        <result column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="content" property="content"/>
        <result column="create_dt" property="createDt"/>
        <result column="nick_name" property="nickName"/>
        <result column="head_img" property="headImg"/>
        <result column="upvote_num" property="upvoteNum"/>
        <result column="mong_article_id" property="mongoArticleId"/>
        <result column="parent_content" property="parentContent"/>
        <result column="parent_nick_name" property="parentNickName"/>
        <result column="parent_head_img" property="parentHeadImg"/>
        <result column="parent_create_dt" property="parentCreateDt"/>
    </resultMap>


    <!-- 根据各字段条件带排序Dto类  薪福+评论表 -->
    <select id="FreeFindOP_HRPLUS_COMMENT_DTO_Ordered" resultMap="result_map_OP_HRPLUS_COMMENT_Dto"
            parameterType="Object">
        select com.*,(CASE WHEN com.anonymous = '1' THEN '匿名' ELSE anc.nick_name END) as nick_name,anc.head_img,(CASE
        WHEN p.anonymous = '1' THEN '匿名' ELSE anc1.nick_name END) as parent_nick_name,anc1.head_img as
        parent_head_img,(case WHEN p.dr='1' THEN '【该评论已被删除】' ELSE p.content END ) as
        parent_content,cp.corp_name,pcp.corp_name as parent_corp_name from op_hrplus_comment com
        LEFT JOIN op_user_ancillary anc ON com.user_id=anc.user_id
        LEFT JOIN sys_user u ON com.user_id = u.user_id
        LEFT JOIN cm_corp cp ON u.org_id = cp.cp_id
        LEFT JOIN op_hrplus_comment p ON com.parent_comment = p.id
        LEFT JOIN op_user_ancillary anc1 ON p.user_id=anc1.user_id
        LEFT JOIN sys_user pu ON p.user_id = pu.user_id
        LEFT JOIN cm_corp pcp ON pu.org_id = pcp.cp_id
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="articleId != null">and com.article_id = #{articleId}</if>
            <if test="articleType != null">and com.article_type = #{articleType}</if>
            <if test="dr != null">and com.dr = #{dr}</if>
        </trim>
        ORDER BY com.create_dt desc
    </select>
    <!-- 根据各字段条件查询总数  薪福+评论表 -->
    <select id="Count_OP_HRPLUS_COMMENT_DTO" resultType="java.lang.Integer" parameterType="Object">
        select count(1) as value from op_hrplus_comment com
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="articleId != null">and com.article_id = #{articleId}</if>
            <if test="articleType != null">and com.article_type = #{articleType}</if>
            <if test="dr != null">and com.dr = #{dr}</if>
            <if test="mongoArticleId != null">and com.mongo_article_id = #{mongoArticleId}</if>
        </trim>
    </select>
    <!-- 查询文章信息 -->
    <select id="FindContentInfo" resultType="java.util.Map" parameterType="Object">
        select ext.title,txt.txt from jc_content_ext ext
        LEFT JOIN jc_content_txt txt ON ext.content_id = txt.content_id
        where ext.content_id = #{contentId}
    </select>

    <!-- 管理评论列表 -->
    <select id="finManageComentList" resultType="java.util.Map" parameterType="Object">
        select com.*,u.user_name,anc.nick_name,ext.title from op_hrplus_comment com
        LEFT JOIN sys_user u ON com.user_id=u.user_id
        LEFT JOIN op_user_ancillary anc on com.user_id=anc.user_id
        LEFT JOIN jc_content_ext ext ON com.article_id = ext.content_id
        where  com.article_type  != 3
            <if test="nickName != null">and anc.nick_name like '%${nickName}%'</if>
            <if test="title != null">and ext.title like '%${title}%'</if>
            <if test="dr != null">and com.dr = #{dr}</if>
        ORDER BY com.create_dt desc
    </select>
    <!-- 管理评论列表总数 -->
    <select id="finManageComentListCount" resultType="java.lang.Integer" parameterType="Object">
        select count(1) as value from op_hrplus_comment com
        LEFT JOIN sys_user u ON com.user_id=u.user_id
        LEFT JOIN op_user_ancillary anc on com.user_id=anc.user_id
        LEFT JOIN jc_content_ext ext ON com.article_id = ext.content_id
        where  com.article_type  != 3
        <if test="nickName != null">and anc.nick_name like '%${nickName}%'</if>
        <if test="title != null">and ext.title like '%${title}%'</if>
        <if test="dr != null">and com.dr = #{dr}</if>
    </select>

    <sql id="findCommentPageSql">
        WHERE com.article_type = 3 AND  com.dr=0
        <if test="nickName != null and nickName != ''">and `user`.nick_name like '%${nickName}%'</if>
    </sql>

    <!-- 管理评论列表 op -->
    <select id="findCommentPageByQuery" resultMap="RESULT_MAP_OP_HRPLUS_DTO" parameterType="Object">
         SELECT com.id ,com.user_id, (CASE WHEN com.dr = '1' THEN '【该评论已被删除】' ELSE com.content END) as content,com.upvote_num,com.mongo_article_id,
        com.parent_comment,com.create_dt, (CASE WHEN user.nick_name is null THEN '匿名用户' ELSE user.nick_name END) as nick_name,user.head_img
        from op_hrplus_comment com
        LEFT JOIN op_headline_user user on `user`.id= com.user_id
        <include refid="findCommentPageSql"/>
        ORDER BY com.create_dt desc
    </select>

    <!-- 管理评论列表 op -->
    <select id="countCommentPageByQuery" resultType="java.lang.Integer" parameterType="Object">
         SELECT count(1)
        from op_hrplus_comment com
        LEFT JOIN op_headline_user user on `user`.id= com.user_id
        <include refid="findCommentPageSql"/>
    </select>

    <!-- 管理评论列表 -->
    <select id="findCommentPageByMongoArticleId" resultMap="RESULT_MAP_OP_HRPLUS_DTO" parameterType="Object">
         SELECT com.id ,com.user_id, (CASE WHEN com.dr = '1' THEN '【该评论已被删除】' ELSE com.content END) as content,com.upvote_num,com.mongo_article_id,
        com.parent_comment,com.create_dt, (CASE WHEN user.nick_name is null THEN '匿名用户' ELSE user.nick_name END) as nick_name,user.head_img
        ,(CASE WHEN comp.dr = '1' THEN '【该评论已被删除】' ELSE comp.content END)   as parent_content,
				(CASE WHEN userp.nick_name is null THEN '匿名用户' ELSE userp.nick_name END) as parent_nick_name
        ,userp.head_img as parent_head_img
        from op_hrplus_comment com
        LEFT JOIN op_headline_user user on `user`.id= com.user_id
        LEFT JOIN op_hrplus_comment comp ON com.parent_comment =comp.id
        LEFT JOIN op_headline_user userp on `userp`.id= comp.user_id
        WHERE com.mongo_article_id=#{mongoArticleId}
        ORDER BY com.upvote_num desc ,com.create_dt desc
    </select>

    <!--根据评论id 查询-->
    <select id="findCommentByCommentId" resultMap="RESULT_MAP_OP_HRPLUS_DTO" parameterType="Object">
        SELECT com.id ,com.user_id, (CASE WHEN com.dr = '1' THEN '【该评论已被删除】' ELSE com.content END) as content,com.upvote_num,com.mongo_article_id,
        com.parent_comment,com.create_dt, (CASE WHEN user.nick_name is null THEN '匿名用户' ELSE user.nick_name END) as nick_name,user.head_img
        ,(CASE WHEN comp.dr = '1' THEN '【该评论已被删除】' ELSE comp.content END)   as parent_content,
				(CASE WHEN userp.nick_name is null THEN '匿名用户' ELSE userp.nick_name END) as parent_nick_name
        ,userp.head_img as parent_head_img
        from op_hrplus_comment com
        LEFT JOIN op_headline_user user on `user`.id= com.user_id
        LEFT JOIN op_hrplus_comment comp ON com.parent_comment =comp.id
        LEFT JOIN op_headline_user userp on `userp`.id= comp.user_id
        WHERE com.id=#{commentId}
        ORDER BY com.upvote_num desc ,com.create_dt desc
    </select>

    <!-- 增加点赞数量-->
    <update id="updateUpvoteNum" parameterType="Object">
        UPDATE op_hrplus_comment
        SET  upvote_num=IFNULL(upvote_num,1)+1
        WHERE id=#{id} AND  dr=0
    </update>

    <!--获取点赞数量-->
    <select id="getUpvoteNumById" resultType="java.lang.Integer" parameterType="Object">
      select upvote_num from op_hrplus_comment WHERE id=#{id} AND  dr=0
    </select>


    <!--<delete id="deleteCommentByCommentId" parameterType="Object">-->
    <!--DELETE FROM OP_HRPLUS_COMMENT WHERE ID=#{id}  AND  parent_comment =#{id} AND  dr=0-->
    <!--</delete>-->

    <!-- 删除评论-->
    <update id="deleteCommentByCommentId" parameterType="Object">
        UPDATE op_hrplus_comment
        SET  dr=1
        WHERE id=#{id}
    </update>

    <!--&lt;!&ndash;根据 评论id 获取所有的子评论id&ndash;&gt;-->
    <!--<select id="getUpvoteNumById" resultType="result_map_OP_HRPLUS_COMMENT" parameterType="Object">-->
    <!--select-->
    <!--<include refid="Base_Column_List"/>-->
    <!--from OP_HRPLUS_COMMENT WHERE parent_comment=#{parentomment} AND dr=0-->
    <!--</select>-->


</mapper>
