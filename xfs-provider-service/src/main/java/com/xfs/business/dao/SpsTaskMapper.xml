<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SPS_TASK">
    <!-- Result Map-->
    <resultMap id="result_map_SPS_TASK" type="com.xfs.business.model.SpsTask">
        <result column="task_id" property="taskId"/>
        <result column="task_no" property="taskNo"/>
        <result column="emp_id" property="empId"/>
        <result column="cp_id" property="cpId"/>
        <result column="sp_id" property="spId"/>
        <result column="bstype_id" property="bstypeId"/>
        <result column="json" property="json"/>
        <result column="type" property="type"/>
        <result column="errmsg" property="errmsg"/>
        <result column="pic_id" property="picId"/>
        <result column="create_by" property="createBy"/>
        <result column="create_dt" property="createDt"/>
        <result column="modify_by" property="modifyBy"/>
        <result column="modify_dt" property="modifyDt"/>
        <result column="area_id" property="areaId"/>
        <result column="dr" property="dr"/>
        <result column="name" property="name"/>
        <result column="mobile" property="mobile"/>
        <result column="identity_code" property="identityCode"/>
        <!-- 8月版本新增字段 生效月份 网申状态 总包商 分包商 -->
        <result column="begin_date" property="beginDate"/>
        <result column="online_status" property="onlineStatus"/>
        <result column="parter_sp_id" property="parterSpId"/>
        <result column="scheme_id" property="schemeId"/>
        <result column="execute_date" property="executeDate"/>
        <result column="state_filed_id" property="stateFiledId"/>
        <result column="state_filed_name" property="stateFiledName"/>

        <result column="task_outer_id" property="taskOuterId"/>
        <result column="pic_url" property="picUrl"/>
        <result column="company_type" property="companyType"/>
        <result column="empName" property="empName"/>
        <result column="bsType" property="bsType"/>
        <result column="regNum" property="regNum"/>
        <result column="ukeyType" property="ukeyType"/>
        <result column="insuranceFundType" property="insuranceFundType"/>
    </resultMap>

    <!-- sps_task table all fields -->
    <sql id="Base_Column_List">
        task_id,task_no,emp_id,cp_id,sp_id,bstype_id,state_filed_id,state_filed_name,json,type,errmsg,pic_id,create_by,create_dt,modify_by,modify_dt,area_id,dr,name,mobile,identity_code,begin_date,online_status,parter_sp_id,scheme_id,execute_date,task_outer_id,pic_url,company_type
    </sql>

    <!-- 查询条件 -->
    <sql id="Example_Where_Clause">
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="taskId != null">and task_id = #{taskId}</if>
            <if test="taskNo != null">and task_no = #{taskNo}</if>
            <if test="empId != null">and emp_id = #{empId}</if>
            <if test="cpId != null">and cp_id = #{cpId}</if>
            <if test="spId != null">and sp_id = #{spId}</if>
            <if test="bstypeId != null">and bstype_id = #{bstypeId}</if>
            <if test="json != null">and json = #{json}</if>
            <if test="type != null">and type = #{type}</if>
            <if test="errmsg != null">and errmsg = #{errmsg}</if>
            <if test="picId != null">and pic_id = #{picId}</if>
            <if test="createBy != null">and create_by = #{createBy}</if>
            <if test="createDt != null">and create_dt = #{createDt}</if>
            <if test="modifyBy != null">and modify_by = #{modifyBy}</if>
            <if test="modifyDt != null">and modify_dt = #{modifyDt}</if>
            <if test="areaId != null">and area_id = #{areaId}</if>
            <if test="dr != null">and dr = #{dr}</if>
            <if test="name != null">and name = #{name}</if>
            <if test="mobile != null">and mobile = #{mobile}</if>
            <if test="identityCode != null">and identity_code = #{identityCode}</if>

            <if test="beginDate != null">and begin_date = #{beginDate}</if>
            <if test="onlineStatus != null">and online_status = #{onlineStatus}</if>
            <if test="parterSpId != null">and parter_sp_id = #{parterSpId}</if>
            <if test="schemeId != null">and scheme_id = #{schemeId}</if>
            <if test="executeDate != null">and execute_date = #{executeDate}</if>
            <if test="stateFiledName != null">and state_filed_name = #{stateFiledName}</if>
            <if test="stateFiledId != null">and state_filed_id = #{stateFiledId}</if>
            <if test="taskOuterId != null">and task_outer_id = #{taskOuterId}</if>
            <if test="picUrl != null">and pic_url = #{picUrl}</if>
            <if test="companyType != null">and company_type = #{companyType}</if>

        </trim>
    </sql>

    <!-- 查询条件 带模糊查询 以及 时间起始查询 -->
    <sql id="Example_Where_Clause2">
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="taskId != null">and task_id = #{taskId}</if>
            <if test="taskNo != null">and task_no = '${taskNo}'</if>
            <if test="empId != null">and emp_id = #{empId}</if>
            <if test="cpId != null">and cp_id = #{cpId}</if>
            <if test="spId != null">and sp_id = #{spId}</if>
            <if test="bstypeId != null">and bstype_id = #{bstypeId}</if>
            <if test="json != null">AND json like '%${json}%'</if>
            <if test="jsonEq != null">AND json = #{jsonEq}</if>
            <if test="type != null">AND type like '%${type}%'</if>
            <if test="typeEq != null">AND type = #{typeEq}</if>
            <if test="errmsg != null">AND errmsg like '%${errmsg}%'</if>
            <if test="errmsgEq != null">AND errmsg = #{errmsgEq}</if>
            <if test="picId != null">AND pic_id = '${picId}'</if>
            <if test="createBy != null">AND create_by = '%${createBy}%'</if>
            <if test="createDt != null">AND create_dt = #{createDt}</if>
            <if test="createDtFrom != null">AND create_dt&gt;=#{createDtFrom}</if>
            <if test="createDtTo != null">AND create_dt&lt;=#{createDtTo}</if>
            <if test="modifyBy != null">AND modify_by = '${modifyBy}'</if>
            <if test="modifyDt != null">AND modify_dt = #{modifyDt}</if>
            <if test="modifyDtFrom != null">AND modify_dt&gt;=#{modifyDtFrom}</if>
            <if test="modifyDtTo != null">AND modify_dt&lt;=#{modifyDtTo}</if>
            <if test="areaId != null">AND area_id = '${areaId}'</if>
            <if test="dr != null">AND dr like '%${dr}%'</if>
            <if test="name != null">AND name like '%${name}%'</if>
            <if test="nameEq != null">AND name = #{nameEq}</if>
            <if test="mobile != null">AND mobile like '%${mobile}%'</if>
            <if test="mobileEq != null">AND mobile = #{mobileEq}</if>
            <if test="identityCode != null">AND identity_code like '%${identityCode}%'</if>
            <if test="identityCodeEq != null">AND identity_code = #{identityCodeEq}</if>

            <if test="beginDate != null">AND begin_date like '%${beginDate}%'</if>
            <if test="beginDateEq != null">AND begin_date = #{beginDateEq}</if>
            <if test="onlineStatus != null">AND online_status like '%${onlineStatus}%'</if>
            <if test="onlineStatusEq != null">AND online_status = #{onlineStatusEq}</if>
            <if test="parterSpId != null">AND parter_sp_id = '${parterSpId}'</if>
            <if test="schemeId != null">AND scheme_id = '${schemeId}'</if>
            <if test="executeDate != null">AND execute_date = '${executeDate}'</if>
            <if test="stateFiledName != null">and state_filed_name = #{stateFiledName}</if>
            <if test="stateFiledId != null">and state_filed_id = #{stateFiledId}</if>

            <if test="taskOuterId != null">and task_outer_id = #{taskOuterId}</if>
            <if test="picUrl != null">and pic_url = #{picUrl}</if>
            <if test="companyType != null">and company_type = #{companyType}</if>
        </trim>
    </sql>

    <!-- 插入记录 -->
    <insert id="InsertSPS_TASK" parameterType="Object">
        INSERT INTO SPS_TASK (
        <trim prefix=" " prefixOverrides=",">
            <if test="taskId != null ">,task_id</if>
            <if test="taskNo != null ">,task_No</if>
            <if test="empId != null ">,emp_id</if>
            <if test="cpId != null ">,cp_id</if>
            <if test="spId != null ">,sp_id</if>
            <if test="bstypeId != null ">,bstype_id</if>
            <if test="json != null ">,json</if>
            <if test="type != null ">,type</if>
            <if test="errmsg != null ">,errmsg</if>
            <if test="picId != null ">,pic_id</if>
            <if test="createBy != null ">,create_by</if>
            <if test="createDt != null ">,create_dt</if>
            <if test="modifyBy != null ">,modify_by</if>
            <if test="modifyDt != null ">,modify_dt</if>
            <if test="areaId != null ">,area_id</if>
            <if test="dr != null ">,dr</if>
            <if test="name != null ">,name</if>
            <if test="mobile != null ">,mobile</if>
            <if test="identityCode != null ">,identity_code</if>

            <if test="beginDate != null ">,begin_date</if>
            <if test="onlineStatus != null ">,online_status</if>
            <if test="parterSpId != null ">,parter_sp_id</if>
            <if test="schemeId != null ">,scheme_id</if>
            <if test="executeDate != null ">,execute_date</if>
            <if test="stateFiledName != null">,state_filed_name</if>
            <if test="stateFiledId != null">,state_filed_id</if>
            <if test="taskOuterId != null">,task_outer_id</if>
            <if test="picUrl != null">,pic_url</if>
            <if test="companyType != null">,company_type</if>
        </trim>
        ) VALUES (
        <trim prefix=" " prefixOverrides=",">
            <if test="taskId != null ">,#{taskId}</if>
            <if test="taskNo != null ">,#{taskNo}</if>
            <if test="empId != null ">,#{empId}</if>
            <if test="cpId != null ">,#{cpId}</if>
            <if test="spId != null ">,#{spId}</if>
            <if test="bstypeId != null ">,#{bstypeId}</if>
            <if test="json != null ">,#{json}</if>
            <if test="type != null ">,#{type}</if>
            <if test="errmsg != null ">,#{errmsg}</if>
            <if test="picId != null ">,#{picId}</if>
            <if test="createBy != null ">,#{createBy}</if>
            <if test="createDt != null ">,#{createDt}</if>
            <if test="modifyBy != null ">,#{modifyBy}</if>
            <if test="modifyDt != null ">,#{modifyDt}</if>
            <if test="areaId != null ">,#{areaId}</if>
            <if test="dr != null ">,#{dr}</if>
            <if test="name != null ">,#{name}</if>
            <if test="mobile != null ">,#{mobile}</if>
            <if test="identityCode != null ">,#{identityCode}</if>

            <if test="beginDate != null ">,#{beginDate}</if>
            <if test="onlineStatus != null ">,#{onlineStatus}</if>
            <if test="parterSpId != null ">,#{parterSpId}</if>
            <if test="schemeId != null ">,#{schemeId}</if>
            <if test="executeDate != null ">,#{executeDate}</if>
            <if test="stateFiledName != null">,#{stateFiledName}</if>
            <if test="stateFiledId != null">,#{stateFiledId}</if>
            <if test="taskOuterId != null">,#{taskOuterId}</if>
            <if test="picUrl != null">,#{picUrl}</if>
            <if test="companyType != null">,#{companyType}</if>
        </trim>
        )
        <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="taskId">
            SELECT LAST_INSERT_ID() AS TASK_ID
        </selectKey>
    </insert>

    <!-- 根据id，修改记录-->
    <update id="UpdateSPS_TASK" parameterType="Object">
        UPDATE SPS_TASK
        <trim prefix=" SET " prefixOverrides=",">
            <if test="taskId != null ">,task_id=#{taskId}</if>
            <if test="taskNo != null">,task_no = #{taskNo}</if>
            <if test="empId != null">,emp_id = #{empId}</if>
            <if test="cpId != null ">,cp_id=#{cpId}</if>
            <if test="spId != null ">,sp_id=#{spId}</if>
            <if test="bstypeId != null ">,bstype_id=#{bstypeId}</if>
            <if test="json != null ">,json=#{json}</if>
            <if test="type != null ">,type=#{type}</if>
            <if test="errmsg != null ">,errmsg=#{errmsg}</if>
            <if test="picId != null ">,pic_id=#{picId}</if>
            <if test="createBy != null ">,create_by=#{createBy}</if>
            <if test="createDt != null ">,create_dt=#{createDt}</if>
            <if test="modifyBy != null ">,modify_by=#{modifyBy}</if>
            <if test="modifyDt != null ">,modify_dt=#{modifyDt}</if>
            <if test="areaId != null ">,area_id=#{areaId}</if>
            <if test="dr != null ">,dr=#{dr}</if>
            <if test="name != null ">,name=#{name}</if>
            <if test="mobile != null ">,mobile=#{mobile}</if>
            <if test="identityCode != null ">,identity_code=#{identityCode}</if>

            <if test="beginDate != null ">,begin_date=#{beginDate}</if>
            <if test="onlineStatus != null ">,online_status=#{onlineStatus}</if>
            <if test="parterSpId != null ">,parter_sp_id=#{parterSpId}</if>
            <if test="schemeId != null ">,scheme_id=#{schemeId}</if>
            <if test="executeDate != null ">,execute_date=#{executeDate}</if>
            <if test="stateFiledName != null">,state_filed_name = #{stateFiledName}</if>
            <if test="stateFiledId != null">,state_filed_id = #{stateFiledId}</if>
            <if test="taskOuterId != null">,task_outer_id = #{taskOuterId}</if>
            <if test="picUrl != null">,pic_url = #{picUrl}</if>
            <if test="companyType != null">,company_type = #{companyType}</if>
        </trim>
        WHERE TASK_ID=#{taskId}
    </update>

    <!-- 删除记录 -->
    <delete id="DeleteSPS_TASK">DELETE FROM SPS_TASK WHERE TASK_ID=#{taskId}</delete>
    <!-- 任务单 列表总数-->
    <select id="CountFindAllSPS_TASK" resultType="java.lang.Integer">SELECT count(1) as value FROM SPS_TASK</select>
    <select id="CountSPS_TASK" resultType="java.lang.Integer">SELECT count(1) as value FROM SPS_TASK WHERE
        TASK_ID=#{taskId}
    </select>
    <!-- 根据id查询 任务单 -->
    <select id="FindByPK" resultMap="result_map_SPS_TASK" parameterType="Object">SELECT
        <include refid="Base_Column_List"/>
        FROM SPS_TASK WHERE TASK_ID=#{taskId}
    </select>

    <!-- 根据各字段条件带模糊查询  任务单 -->
    <select id="FreeFindSPS_TASK" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM SPS_TASK
        <include refid="Example_Where_Clause2"/>
    </select>
    <!-- 根据各字段条件带模糊查询  任务单 记录数 -->
    <select id="CountFreeFindSPS_TASK_OLD" resultType="java.lang.Integer">
        SELECT count(1) as value FROM SPS_TASK
        <include refid="Example_Where_Clause2"/>
    </select>
    <!-- modify by wuzhe merge ,source from cs -->
    <select id="CountFreeFindSPS_TASK_CS" resultType="java.lang.Integer">
        SELECT count(1) as value FROM SPS_TASK
        <include refid="Example_Where_Clause2"/>
    </select>
    <!-- 根据各字段条件带排序  任务单 -->
    <select id="FreeFindSPS_TASKOrdered" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM SPS_TASK
        <include refid="Example_Where_Clause2"/>
        ORDER BY ${_orderBy}
    </select>

    <!-- *****************************  温馨提示：  ***************************** -->
    <!-- **                                                                    ** -->
    <!-- ** 以上为自动生成代码，请勿改动或删除。如有新sql添加请在下方区域内填写** -->
    <!-- **                                             ** 2016/05/25 17:51:45 ** -->
    <!-- ************************************************************************ -->

    <resultMap id="mapType" type="java.util.Map">
    </resultMap>
    <!-- 根据服务商id 企业下  任务单 数量信息 -->
    <select id="findTaskCount" resultMap="mapType" parameterType="Object">
        SELECT cm_corp.cp_id,sps_task.type,sps_task.bstype_id,count(1) as count
        FROM cm_corp inner join SP_CM_RELATION on cm_corp.cp_id = SP_CM_RELATION.cp_id
        inner join sps_task on sps_task.sp_id = SP_CM_RELATION.sp_id and sps_task.cp_id = cm_corp.cp_id
        where SP_CM_RELATION.sp_id=${sp_id} group by cm_corp.cp_id,sps_task.type,sps_task.bstype_id
    </select>

    <!-- 查询 企业列表 -->
    <select id="findEmpList" resultMap="mapType" parameterType="Object">
        SELECT distinct cm_corp.cp_id,cm_corp.corp_name,SP_CM_RELATION.area_id,SP_CM_RELATION.reg_num,
        SP_CM_RELATION.insurance_type
        FROM cm_corp inner join SP_CM_RELATION on cm_corp.cp_id = SP_CM_RELATION.cp_id
        inner join sps_task on sps_task.sp_id = SP_CM_RELATION.sp_id and sps_task.cp_id = cm_corp.cp_id
        where SP_CM_RELATION.sp_id=${sp_id} and sps_task.type = '${type}' and sps_task.bstype_id = ${bstype_id}
    </select>

    <!-- 查询 企业列表 -->
    <select id="findOrgList" resultType="java.util.HashMap" parameterType="Object">

        SELECT DISTINCT
        s.scheme_id,
        CONCAT(c.corp_name ,'_', s.name) as scheme_name,
        a1.reg_num,
        a1.reg_numpass,
        a1.reg_usbkeypass,
        a2.reg_num AS reg_num2,
        a2.reg_numpass AS reg_numpass2,
        IFNULL(t.todo,0) as todo,
        ff.insuranceLoginURL,
        ff.fundLoginURL,
        ff.insuranceTypes,
        ff.fundTypes,
        ff.city_code,
        ff.area_id,
        a1.usbport as usbport1,
        a2.usbport as usbport2
        FROM
        sps_scheme s
        LEFT JOIN sps_account a1 ON a1.acc_id = s.insurance_account_id
        LEFT JOIN sps_account a2 ON a2.acc_id = s.fund_account_id
        inner join cm_corp c on c.cp_id=s.cp_id
        left JOIN (
        SELECT
        k.scheme_id,
        count(k.task_id) AS todo,
        k.sp_id
        FROM
        sps_task k
        WHERE
        (k.online_status = 'TODO' OR k.online_status is null) and k.scheme_id>0
        GROUP BY
        k.sp_id,
        k.scheme_id
        ) t ON t.scheme_id = s.scheme_id
        AND t.sp_id = s.sp_id
        LEFT JOIN (
        SELECT
        h.scheme_id,
        s.city_code,
        s.insuranceLoginURL,
        s.fundLoginURL,
        s.insuranceTypes,
        s.fundTypes,
        s.area_id
        FROM
        sps_scheme h
        LEFT JOIN bs_area a ON h.area_id = a.area_id
        LEFT JOIN bs_area p ON LOCATE(p.CODE, a.CODE) = 1
        INNER JOIN sps_ts_citycode s ON s.area_id = p.CODE
        where h.sp_id=${sp_id}
        ) AS ff ON ff.scheme_id = s.scheme_id
        WHERE
        a1.reg_numpass IS NOT NULL
        AND ff.city_code IS NOT NULL
        AND s.sp_id =${sp_id}
        ORDER BY
        t.todo DESC

    </select>

    <!-- 查询 企业下 任务单列表 -->
    <select id="findEmpPersonList" resultMap="mapType" parameterType="Object">
        SELECT cm_corp.cp_id,cm_corp.corp_name,cm_corp.corp_name,sps_task.json,sps_task.errmsg,sps_task.pic_id,
        sps_task.create_dt,sps_task.task_id,sps_task.type,sps_task.create_dt
        FROM cm_corp inner join SP_CM_RELATION on cm_corp.cp_id = SP_CM_RELATION.cp_id
        inner join sps_task on sps_task.sp_id = SP_CM_RELATION.sp_id and sps_task.cp_id = cm_corp.cp_id
        where SP_CM_RELATION.sp_id=${sp_id} and sps_task.type = '${type}' and sps_task.bstype_id = ${bstype_id}
        and cm_corp.cp_id = ${cpId} order by sps_task.create_dt desc
    </select>

    <!-- 查询 企业下 任务单列表 记录数 -->
    <select id="findEmpPersonCount" resultType="java.lang.Integer" parameterType="Object">
        SELECT count(1) as value
        FROM cm_corp inner join SP_CM_RELATION on cm_corp.cp_id = SP_CM_RELATION.cp_id
        inner join sps_task on sps_task.sp_id = SP_CM_RELATION.sp_id and sps_task.cp_id = cm_corp.cp_id
        where SP_CM_RELATION.sp_id=${sp_id} and sps_task.type = '${type}' and sps_task.bstype_id = ${bstype_id}
        and cm_corp.cp_id = ${cpId}
    </select>

    <!-- 根据待办任务单 企业下 任务单json列表 -->
    <select id="findEmpPersonJsonList" resultMap="mapType" parameterType="Object">
        SELECT sps_task.task_id,sps_task.bstype_id,sps_task.json
        FROM sps_task
        where sps_task.sp_id=${spId} and (sps_task.online_status = '${type}' OR sps_task.online_status is NULL) and
        sps_task.scheme_id = ${schemeId}
        and sps_task.execute_date = #{executeDate}
        <if test="bstypeId !=null">and sps_task.bstype_id = ${bstypeId}</if>
    </select>

    <select id="findCurrMonthTaskJsonList" resultMap="mapType" parameterType="Object">
        SELECT sps_task.task_id,sps_task.bstype_id,sps_task.json
        FROM cm_corp inner join SP_CM_RELATION on cm_corp.cp_id = SP_CM_RELATION.cp_id
        inner join sps_task on sps_task.sp_id = SP_CM_RELATION.sp_id and sps_task.cp_id = cm_corp.cp_id
        where SP_CM_RELATION.sp_id=${spId} and sps_task.type = '${type}'
        and cm_corp.cp_id = ${cpId} and sps_task.begin_date = #{executeDate}
        <if test="bstypeId !=null">and sps_task.bstype_id = ${bstypeId}</if>
    </select>


    <!-- 查询 企业 记录数 -->
    <select id="findEmpPageCount" resultType="java.lang.Integer" parameterType="Object">
        SELECT count(distinct cm_corp.cp_id) as value
        FROM cm_corp inner join SP_CM_RELATION on cm_corp.cp_id = SP_CM_RELATION.cp_id
        where SP_CM_RELATION.sp_id=${sp_id}
    </select>
    <!-- 查询 企业 信息 -->
    <select id="findEmpPageData" resultMap="mapType" parameterType="Object">
        SELECT distinct cm_corp.cp_id,cm_corp.corp_name,cm_corp.contact_psn,SP_CM_RELATION.insurance_type
        FROM cm_corp inner join SP_CM_RELATION on cm_corp.cp_id = SP_CM_RELATION.cp_id
        where SP_CM_RELATION.sp_id=${sp_id}
    </select>


    <select id="findSpsTaskBotList" resultMap="mapType" parameterType="Object">
        SELECT
        sps_task.*,
        sys_user.user_name,
        cm_corp.corp_name,
        sp_service.sp_name
        FROM
        sps_task
        LEFT JOIN cm_corp ON sps_task.cp_id = cm_corp.cp_id
        LEFT JOIN sp_service ON sps_task.sp_id = sp_service.sp_id
        LEFT JOIN sys_user ON sys_user.user_id = sps_task.create_by
        WHERE
        sps_task.sp_id =${ spId } and sps_task.type!='TODO' and sps_task.modify_dt is not null and
        sps_task.modify_dt>'2000-01-01'
        and date_sub(curdate(), INTERVAL 30 DAY) &lt;= date(sps_task.create_dt)
        ORDER BY sps_task.modify_dt DESC
    </select>

    <select id="findTaskAndCorpCount" resultType="java.lang.Integer" parameterType="Object">
        SELECT COUNT(1) FROM (
        SELECT COUNT(1) FROM sps_task t
        INNER JOIN sp_cm_relation scr ON (scr.`sp_id` = t.`sp_id` AND scr.`cp_id` = t.`cp_id`)
        INNER JOIN cm_corp c ON c.`cp_id` = t.`cp_id`
        INNER JOIN bd_bstype bst ON bst.`bstype_id` = t.`bstype_id`
        WHERE t.`sp_id` = #{spId} AND t.`area_id` = 2 AND t.`dr` != 1 AND (type IS NOT NULL AND type != 'CLOSED')
        <if test="cpId != null ">AND t.`cp_id` = #{cpId}</if>
        <if test="searchWord != null">AND c.`corp_name` LIKE '%${searchWord}%'</if>
        <if test="bstypeId != null ">AND t.`bstype_id` = #{bstypeId}</if>
        <if test="authority != 'ALL'">
            AND c.cp_id in (${authority})
        </if>
        GROUP BY scr.`cp_id`, bst.`insurance_fund_type`
        ) t;
    </select>
    <!--yangfw 网上申报总条数不正常 备用-->
    <select id="findTaskAndCorpCount_" resultType="java.lang.Integer" parameterType="Object">
        SELECT
        count(1) as value
        FROM
        sps_scheme s
        INNER JOIN cm_corp c ON c.cp_id = s.cp_id
        LEFT JOIN (
        SELECT
        t.sp_id,
        t.cp_id,
        bb.insurance_fund_type,
        t.scheme_id,
        sum(IF(t.type = 'TODO', 1, 0)) AS todoNum,
        sum(IF(t.type = 'COMPLETED', 1, 0)) AS completedNum,
        sum(IF(t.type = 'ERROR', 1, 0)) AS errorNum
        FROM
        sps_task t
        LEFT JOIN bd_bstype bb ON t.bstype_id = bb.bstype_id
        WHERE
        t.sp_id > 0
        AND t.cp_id > 0
        AND t.scheme_id > 0
        AND t.dr = 0
        AND t.type != 'CLOSED'
        AND t.type IS NOT NULL
        <if test="bstypeId != null ">
            AND t.bstype_id = #{bstypeId}
        </if>
        GROUP BY
        t.sp_id,
        t.cp_id,
        bb.insurance_fund_type,
        t.scheme_id
        ORDER BY
        t.sp_id,
        t.cp_id
        ) a ON s.scheme_id = a.scheme_id
        AND a.sp_id = s.sp_id
        AND a.cp_id = s.cp_id
        WHERE
        s.sp_id = #{spId}
        AND s.`area_id` = #{areaId}
        AND s.dr != 1
        AND a.insurance_fund_type IS NOT NULL
        <if test="cpId != null ">
            AND s.`cp_id` = #{cpId}
        </if>
        <if test="searchWord != null">
            AND c.`corp_name` LIKE '%${searchWord}%'
        </if>
        <if test="authority != 'ALL'">
            AND c.cp_id IN (${authority})
        </if>
        GROUP BY
        s.scheme_id,
        a.insurance_fund_type
        ORDER BY
        c.corp_name,
        s.`name`,
        a.insurance_fund_type
    </select>
    <!-- 根据服务商id和区域id获取企业列表、任务汇总信息 -->
    <select id="findTaskAndCorps_" resultType="java.util.Map" parameterType="Object">
        SELECT
        s.sp_id,
        s.cp_id,
        c.corp_name,
        s. NAME as scheme_name,
        a.insurance_fund_type,
        s.insurance_type,
        s.fund_type,
        s.scheme_id,
        IFNULL(a.todoNum, 0) AS todoNum,
        IFNULL(a.completedNum, 0) AS completedNum,
        IFNULL(a.errorNum, 0) AS errorNum,
        a.usbport
        FROM
        sps_scheme s
        INNER JOIN cm_corp c ON c.cp_id = s.cp_id
        left JOIN (
        SELECT
        sum(IF( t.online_status is null OR t.online_status='TODO', 1, 0)) AS todoNum,
        sum(IF(t.online_status = 'COMPLETED', 1, 0)) AS completedNum,
        sum(IF(t.online_status = 'ERROR', 1, 0)) AS errorNum,
        t.scheme_id,
        b.insurance_fund_type,
        aas.usbport
        FROM
        sps_task t
        inner join bd_bstype b on t.bstype_id=b.bstype_id
        LEFT JOIN sps_account aas on aas.insurance_fund_type=b.insurance_fund_type
        WHERE
        t.scheme_id > 0 AND t.dr != 1 AND t.type != 'CLOSED' and t.type IS NOT NULL
        <if test="bstypeId != null ">AND t.bstype_id = #{bstypeId}</if>
        GROUP BY
        t.scheme_id,b.insurance_fund_type
        ) a ON s.scheme_id = a.scheme_id
        inner join bs_area sa on sa.area_id=s.area_id
        inner join bs_area pa on LOCATE(pa.CODE, sa.CODE) = 1
        WHERE
        s.sp_id = #{spId} AND pa.`area_id` = #{areaId} AND s.dr != 1 and a.insurance_fund_type is not null
        <if test="cpId != null ">AND s.`cp_id` = #{cpId}</if>
        <if test="searchWord != null">AND c.`corp_name` LIKE '%${searchWord}%'</if>
        <if test="authority != 'ALL'">AND c.cp_id in (${authority})</if>
        GROUP BY
        s.scheme_id,a.insurance_fund_type
        order by c.corp_name,s.`name`,a.insurance_fund_type
    </select>


    <!-- 根据服务商id和区域id获取企业列表、任务汇总信息 2016 11 19 修改 -->
    <select id="findTaskAndCorps" resultType="java.util.Map" parameterType="Object">
        SELECT
        s.sp_id,
        s.cp_id,
        c.corp_name,
        s. NAME AS scheme_name,
        a.insurance_fund_type,
        s.insurance_type,
        s.fund_type,
        s.scheme_id,
        IFNULL(a.todoNum, 0) AS todoNum,
        IFNULL(a.completedNum, 0) AS completedNum,
        IFNULL(a.errorNum, 0) AS errorNum
        FROM
        sps_scheme s
        INNER JOIN cm_corp c ON c.cp_id = s.cp_id
        LEFT JOIN (
        SELECT
        t.sp_id,
        t.cp_id,
        bb.insurance_fund_type,
        t.scheme_id,
        sum(IF( (t.online_status is null OR t.online_status='TODO') , 1, 0)) AS todoNum,
        sum(IF(t.online_status = 'COMPLETED', 1, 0)) AS completedNum,
        sum(IF(t.online_status = 'ERROR', 1, 0)) AS errorNum
        FROM
        sps_task t
        LEFT JOIN bd_bstype bb ON t.bstype_id = bb.bstype_id
        WHERE
        t.sp_id = #{spId}
        AND t.cp_id > 0
        AND t.scheme_id > 0
        AND t.dr = 0
        AND t.type != 'CLOSED'
        AND t.type IS NOT NULL
        <if test="bstypeId != null ">AND t.bstype_id = #{bstypeId}</if>
        GROUP BY
        t.sp_id,
        t.cp_id,
        bb.insurance_fund_type,
        t.scheme_id
        ORDER BY
        t.sp_id,
        t.cp_id
        ) a ON s.scheme_id = a.scheme_id
        AND a.sp_id = s.sp_id
        AND a.cp_id = s.cp_id
        inner join bs_area sa on sa.area_id=s.area_id
        WHERE
        s.sp_id = #{spId}
        AND sa.`belong_city` = #{areaId}
        AND s.dr != 1
        AND a.insurance_fund_type IS NOT NULL
        <if test="cpId != null ">
            AND s.`cp_id` = #{cpId}
        </if>
        <if test="searchWord != null">
            AND c.`corp_name` LIKE '%${searchWord}%'
        </if>
        <if test="authority != 'ALL'">
            AND c.cp_id IN (${authority})
        </if>
        GROUP BY
        s.scheme_id,
        a.insurance_fund_type
        ORDER BY
        c.corp_name,
        s.`name`,
        a.insurance_fund_type
    </select>


    <!-- 条件搜索任务列表 -->
    <select id="findTaskCountByCondition" resultType="java.lang.Integer" parameterType="Object">
        SELECT COUNT(t.`task_id`) FROM sps_task t
        INNER JOIN bd_bstype bst ON bst.`bstype_id` = t.`bstype_id`
        WHERE t.`sp_id` = #{spId} AND t.scheme_id = #{schemeId} AND bst.`insurance_fund_type` = #{insuranceFundType}
        <if test="onlineStatus != 'TODO' ">AND t.`online_status` = #{onlineStatus}</if>
        <if test="onlineStatus == 'TODO' ">AND ( t.`online_status` is null OR t.`online_status` ='TODO' ) AND t.type
            !='CLOSED'
        </if>
        <if test="searchWord != null ">AND (t.`name` LIKE '%${searchWord}%' OR t.`identity_code` LIKE
            '%${searchWord}%')
        </if>
        <if test="bstypeId != null ">AND t.`bstype_id` = #{bstypeId}</if>
        ORDER BY t.`task_id` DESC
    </select>
    <select id="findTasksByCondition" resultType="java.util.Map" parameterType="Object">
        SELECT t.*, bst.`name` AS bstype_name FROM sps_task t
        INNER JOIN bd_bstype bst ON bst.`bstype_id` = t.`bstype_id`
        WHERE t.`sp_id` = #{spId} AND t.scheme_id = #{schemeId} AND bst.`insurance_fund_type` = #{insuranceFundType}
        <if test="onlineStatus != 'TODO' ">AND t.`online_status` = #{onlineStatus}</if>
        <if test="onlineStatus == 'TODO' ">AND (t.`online_status` is null OR t.`online_status` ='TODO') AND t.type
            !='CLOSED'
        </if>
        <if test="searchWord != null ">AND (t.`name` LIKE '%${searchWord}%' OR t.`identity_code` LIKE
            '%${searchWord}%')
        </if>
        <if test="bstypeId != null ">AND t.`bstype_id` = #{bstypeId}</if>
        ORDER BY t.`task_id` DESC
    </select>

    <!-- 查询 代办、已完成 任务单 -->
    <select id="findTo_Deal_SPS_TASK" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT * FROM SPS_TASK t where t.cp_id = #{cpId} and t.sp_id = #{spId} and t.type in ('ERROR','TODO','SUBMIT')
        <if test="bstypeId != null">AND t.bstype_id = #{bstypeId}</if>
    </select>


    <select id="findProgressData" resultType="java.util.Map" parameterType="Object">
        SELECT
        t.scheme_id AS scheme_id,
        bb.belong_city as area_id,
        sum(IF(t.type = 'TODO', 1, 0)) AS todo,
        ifnull(p.state, 'UNDO') AS state,
        cast(
        ifnull(p.progress, 0) AS DECIMAL (10, 2)
        ) * 100 AS progress,
        b.insurance_fund_type AS type
        FROM
        bs_area bb,
        sps_task t
        LEFT JOIN bd_bstype b ON b.bstype_id = t.bstype_id
        LEFT JOIN sps_task_progress p ON t.scheme_id = p.cid
        AND b.insurance_fund_type = p.type
        where b.insurance_fund_type='${type}' and t.scheme_id=#{scheme_id} and bb.area_id = t.area_id
        GROUP BY t.scheme_id
    </select>


    <select id="findTaskProgress" resultType="java.util.Map" parameterType="Object">
        select * from sps_task_progress t where t.cid=#{scheme_id} and t.type='${type}';
    </select>


    <insert id="insertTaskProgress" parameterType="Object">
        insert into sps_task_progress(cid,type,state,time,createtime,updatetime,progress,mobile,sp_id) values
        (#{scheme_id}, #{type}, #{state}, #{time}, #{createtime},#{updatetime}, #{progress},#{mobile},#{spid});
    </insert>

    <update id="updateTaskProgress" parameterType="Object">
        update sps_task_progress set state=#{state},time=#{time},updatetime=#{updatetime},progress=#{progress} where
        cid=#{scheme_id} and type=#{type}
    </update>

    <!-- 2016-12 新版 任务管理 数据列表  -->
    <select id="FreeFindSPS_TASK_ALL_List" resultType="java.util.Map" parameterType="Object">
        SELECT st.task_id,st.task_no,st.emp_id,st.cp_id,st.sp_id,st.bstype_id,
        st.json,st.type,st.errmsg,st.pic_id,st.create_by,st.create_dt,st.modify_by,
        st.modify_dt,st.area_id,st.dr,st.name,st.mobile,st.begin_date,st.execute_date,
        st.online_status,st.parter_sp_id,st.scheme_id,
        su.user_name,su.user_type,su.org_id,
        ce.name as emp_name,ce.identity_type,ce.identity_code,
        cc.short_name,cc.corp_name,
        bsa.name as area_name,
        bbt.insurance_fund_type,bbt.name as bstype_name,
        ss.scheme_type,ss.insurance_type,ss.fund_type,
        sd.name as id_name
        FROM SPS_TASK st
        LEFT JOIN SYS_USER su on st.create_by = su.user_id
        LEFT JOIN cm_employee ce on ce.emp_id = st.emp_id and ce.cp_id = st.cp_id
        LEFT JOIN sys_dictitem sd on sd.code = ce.identity_type and sd.dictionary=89
        LEFT JOIN cm_corp cc on cc.cp_id = st.cp_id
        LEFT JOIN bs_area ba on st.area_id = ba.area_id
        LEFT JOIN bs_area bsa on ba.belong_city = bsa.area_id
        LEFT JOIN bd_bstype bbt on st.bstype_id = bbt.bstype_id
        LEFT JOIN sps_scheme ss on st.scheme_id = ss.scheme_id
        WHERE st.sp_id = #{spId} and st.dr=#{dr} and cc.dr = 0 and ss.dr=0
        <if test="areaId != null">and bsa.area_id = #{areaId}</if>
        <if test="bsType != null">and bbt.insurance_fund_type = #{bsType}</if>
        <if test="type != null">and st.type =#{type}</if>
        <if test="empName != null">and (ce.name like CONCAT('%',#{empName},'%') or ce.identity_code like
            CONCAT('%',#{empName},'%'))
        </if>
        <if test="corpName != null">and(cc.corp_name like concat('%',#{corpName},'%') or cc.short_name like
            concat('%',#{corpName},'%'))
        </if>
        <!-- 首页通知信息跳转过来 1000为增员业务 1001为减员业务 1002为补缴业务 -->
        <if test="bstypeId != null">
            <if test="bstypeId==1000">and st.bstype_id in(2,3,10)</if>
            <if test="bstypeId==1001">and st.bstype_id in(4,11)</if>
            <if test="bstypeId==1002">and st.bstype_id in(29,30)</if>
        </if>
        <!-- 首页通知信息跳转过来 -->
        <if test="executeDate != null">and st.execute_date =#{executeDate}</if>
        <if test="authority != 'ALL'">
            AND cc.cp_id in (${authority})
        </if>
        <!-- 消息推送处 查询使用只传 taskId-->
        <if test="taskId != null">and st.task_id =#{taskId}</if>
        order by st.create_dt desc
    </select>
    <!-- 2016-12 查询任务单总数 -->
    <select id="CountFreeFindSPS_TASK" resultType="java.lang.Integer">
        SELECT count(1) as value
        FROM SPS_TASK st
        LEFT JOIN SYS_USER su on st.create_by = su.user_id
        LEFT JOIN cm_employee ce on ce.emp_id = st.emp_id and ce.cp_id = st.cp_id
        LEFT JOIN sys_dictitem sd on sd.code = ce.identity_type and sd.dictionary=89
        LEFT JOIN cm_corp cc on cc.cp_id = st.cp_id
        LEFT JOIN bs_area ba on st.area_id = ba.area_id
        LEFT JOIN bs_area bsa on ba.belong_city = bsa.area_id
        LEFT JOIN bd_bstype bbt on st.bstype_id = bbt.bstype_id
        LEFT JOIN sps_scheme ss on st.scheme_id = ss.scheme_id
        WHERE st.sp_id = #{spId} and st.dr=#{dr} and cc.dr = 0 and ss.dr=0
        <if test="areaId != null">and bsa.area_id = #{areaId}</if>
        <if test="bsType != null">and bbt.insurance_fund_type = #{bsType}</if>
        <if test="type != null">and st.type =#{type}</if>
        <if test="empName != null">and (ce.name like CONCAT('%',#{empName},'%') or ce.identity_code like
            CONCAT('%',#{empName},'%'))
        </if>
        <if test="corpName != null">and(cc.corp_name like concat('%',#{corpName},'%') or cc.short_name like
            concat('%',#{corpName},'%'))
        </if>
        <!-- 首页通知信息跳转过来 1000为增员业务 1001为减员业务 1002为补缴业务 -->
        <if test="bstypeId != null">
            <if test="bstypeId==1000">and st.bstype_id in(2,3,10)</if>
            <if test="bstypeId==1001">and st.bstype_id in(4,11)</if>
            <if test="bstypeId==1002">and st.bstype_id in(29,30)</if>
        </if>
        <!-- 首页通知信息跳转过来 -->
        <if test="executeDate != null">and st.execute_date =#{executeDate}</if>
        <if test="authority != 'ALL'">
            AND cc.cp_id in (${authority})
        </if>
        <!-- 消息推送处 查询使用只传 taskId-->
        <if test="taskId != null">and st.task_id =#{taskId}</if>
        order by st.create_dt desc
    </select>
    <!--2016-11 新版 任务管理 根据任务单ID 查询任务单详情信息 zhangxiyan-->
    <select id="FreeFindSPS_TASK_List" resultType="java.util.Map" parameterType="Object">
        SELECT  st.task_id,st.task_no,st.emp_id,st.cp_id,st.sp_id,st.bstype_id,st.execute_date,
        st.json,st.type,st.errmsg,st.pic_id,st.create_by,st.create_dt,st.modify_by,
        st.modify_dt,st.area_id,st.dr,st.name,st.mobile,st.begin_date,
        st.online_status,st.parter_sp_id,st.scheme_id,
        su.user_name,
        suu.user_name as execute_name,
        bbt.insurance_fund_type,bbt.name as bstype_name,
        ss.scheme_type,
        ce.name as emp_name,ce.identity_code,ce.identity_type,ce.insurance_state,ce.insurance_salary,ce.fund_salary,ce.fund_state,ce.insurance_living_type
        FROM SPS_TASK st
        LEFT JOIN SYS_USER su on st.create_by = su.user_id
        LEFT JOIN SYS_USER suu on st.modify_by = suu.user_id
        LEFT JOIN bd_bstype bbt on st.bstype_id = bbt.bstype_id
        LEFT JOIN sps_scheme ss on st.scheme_id = ss.scheme_id
        LEFT JOIN cm_employee ce on ce.emp_id = st.emp_id and ce.cp_id = st.cp_id
        WHERE st.task_id =#{taskId}  and ss.dr = 0  and st.dr = 0
    </select>
    <!-- 2016-11 新版 任务管理 操作详情页面 完成 终止 任务单操作 zhangxiyan -->
    <update id="UpdateSPS_TASK_TASKID" parameterType="Object">
        UPDATE SPS_TASK SET type =#{type},modify_by =#{modifyBy}, modify_dt =#{modifyDt} WHERE TASK_ID=#{taskId} and
        dr=0
    </update>
    <select id="FreeFindSPS_TASK_List_By_Emp" resultType="java.util.Map" parameterType="Object">
        select u.user_name as user_name,task.task_id as task_id, task.task_no as task_no, bty.insurance_fund_type as
        insurance_fund_type, bty.name as insurance_fund_name , task.create_by as create_by, task.create_dt as create_dt,
        sysuser.user_name as customer_name, task.type as type
        from sps_task task
        LEFT JOIN bd_bstype bty on task.bstype_id = bty.bstype_id
        LEFT JOIN cm_corp corp on corp.cp_id = task.cp_id
        LEFT JOIN sys_user sysuser on sysuser.user_id= corp.collaborator
        LEFT JOIN sys_user u on u.user_id=task.create_by
        where task.dr = 0 and corp.dr = 0
        <if test="empId != null">and task.emp_id = #{empId}</if>
    </select>

    <select id="FreeFindSPS_TASK_List_Count_By_Emp" resultType="java.lang.Integer" parameterType="Object">
        select count(1)
        from sps_task task
        LEFT JOIN bd_bstype bty on task.bstype_id = bty.bstype_id
        LEFT JOIN cm_corp corp on corp.cp_id = task.cp_id
        LEFT JOIN sys_user sysuser on sysuser.user_id= corp.collaborator
        LEFT JOIN sys_user u on u.user_id=task.create_by
        where task.dr = 0 and corp.dr = 0
        <if test="empId != null">and task.emp_id = #{empId}</if>
    </select>

    <select id="FindSPS_TASK_By_Emp" resultType="java.util.Map" parameterType="Object">
        select task.task_no as task_no, btype.name as bstype_name, task.type as type, task.create_dt as create_dt
        from sps_task task
        LEFT JOIN bd_bstype btype
        on task.bstype_id = btype.bstype_id
        where task.dr = 0
        <if test="empId != null">and task.emp_id = #{empId}</if>
        <if test="insuranceFundType != null">and btype.insurance_fund_type = #{insuranceFundType}</if>
    </select>

    <select id="FindSPS_TASKLIST_By_Emp" resultType="java.util.Map" parameterType="Object">
        select task.task_no as task_no, btype.name as bstype_name, task.type as type, task.create_dt as
        create_dt,task.begin_date as begin_date,task.bstype_id as bstype_id
        from sps_task task
        LEFT JOIN bd_bstype btype
        on task.bstype_id = btype.bstype_id
        where task.dr = 0
        <if test="empId != null">and task.emp_id = #{empId}</if>
        <if test="insuranceFundType != null">and btype.insurance_fund_type = #{insuranceFundType}</if>
        order by task.create_dt desc

    </select>

    <!--查询多类型， 单个状态任务单-->
    <select id="findTaskByBsTypeAndState" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT * FROM SPS_TASK t where t.emp_id=#{empId} and t.dr = 0
        <if test="bstypeId != null">AND t.bstype_id in
            <foreach collection="bstypeId" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="state != null">AND t.type=#{state}</if>
        <if test="states != null">AND t.type in
            <foreach collection="states" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        order by t.create_dt DESC
    </select>

    <!-- 根据task_id 查询任务单详情 返回实体 -->
    <select id="FreeFindSPS_TASK_Detail_List" resultMap="result_map_SPS_TASK" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        from sps_task where task_id = #{taskId} and dr = 0
    </select>
    <!-- 查询 年度服务人数 -->
    <!-- 查询 年度服务人数 -->
    <select id="queryYearPersonNum" resultType="java.util.Map" parameterType="Map">
        select e.insured_month,count(distinct e.emp_id) as count from sps_bill t
        inner join sps_bill_emp e on t.bill_id=e.bill_id
        where t.bill_type = 'PREPAY' and t.sp_id=#{spId}
        <if test="insurance_fund_type == 'INSURANCE' ">AND e.insurance_official_fee>0</if>
        <if test="insurance_fund_type == 'FUND' ">AND e.fund_official_fee>0</if>
        <if test="beginPeriod != null">AND e.insured_month &gt;= #{beginPeriod}</if>
        <if test="endPeriod != null">AND e.insured_month &lt;= #{endPeriod}</if>
        <if test="authority != 'ALL'">
            AND t.cp_id in (${authority})
        </if>
        group by e.insured_month
    </select>

    <!-- under modify by wuzhe merger 20161104 source from cs -->
    <!-- modify by wuzhe merger 20161104  source from cs -->
    <select id="findTaskCountByCondition_CS" resultType="java.lang.Integer" parameterType="Object">
        SELECT COUNT(t.`task_id`) FROM sps_task t
        INNER JOIN bd_bstype bst ON bst.`bstype_id` = t.`bstype_id`
        INNER JOIN cm_employee emp ON emp.emp_id = t.emp_id
        WHERE t.`cp_id` = #{cpId}
        <if test="empId != null ">AND t.emp_id = #{empId}</if>
        <if test="areaId != null">AND t.`area_id` = #{areaId}</if>
        <if test="type != null">AND t.`type` in (${type})</if>
        <if test="insuranceFundType != null">AND bst.`insurance_fund_type` = #{insuranceFundType}</if>

        <if test="searchWord != null ">AND (emp.`name` LIKE '%${searchWord}%' OR t.`task_no` LIKE '%${searchWord}%' OR
            t.`mobile` LIKE '%${searchWord}%')
        </if>
        <if test="bstypeId != null ">AND t.`bstype_id` = #{bstypeId}</if>
        <if test="json != null">AND t.bstype_id in (${json})</if>
        ORDER BY t.`task_id` DESC
    </select>

    <!-- modify by wuzhe merger 20161104  source from cs -->
    <select id="findTasksByCondition_CS" resultType="java.util.Map" parameterType="Object">
        SELECT t.*, bst.`name` AS bstype_name,bst.insurance_fund_type,emp.name as emp_name,emp.identity_code as
        emp_identity_code,user.user_name,user.user_id FROM sps_task t
        INNER JOIN bd_bstype bst ON bst.`bstype_id` = t.`bstype_id`
        INNER JOIN cm_employee emp ON emp.emp_id = t.emp_id
        LEFT JOIN sys_user user ON user.user_id = t.create_by
        WHERE t.`cp_id` = #{cpId}
        <if test="empId != null ">AND t.emp_id = #{empId}</if>
        <if test="areaId != null">AND t.`area_id` = #{areaId}</if>
        <if test="type != null">AND t.`type` in (${type})</if>
        <if test="insuranceFundType != null">AND bst.`insurance_fund_type` = #{insuranceFundType}</if>

        <if test="searchWord != null ">AND (emp.`name` LIKE '%${searchWord}%' OR t.`task_no` LIKE '%${searchWord}%' OR
            t.`mobile` LIKE '%${searchWord}%')
        </if>
        <if test="bstypeId != null ">AND t.`bstype_id` = #{bstypeId}</if>
        <if test="json != null">AND t.bstype_id in (${json})</if>
        ORDER BY t.`task_id` DESC
    </select>


    <!--查询多类型任务单-->
    <select id="findTaskInBsTypeAndType" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT * FROM SPS_TASK t where t.emp_id=#{empId}
        <if test="bstypeId != null">AND t.bstype_id in (${bstypeId})</if>
        <if test="type != null">AND t.type != #{type}</if>
        <if test="typeIn != null">AND t.type IN
            <foreach collection="typeIn" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        order by t.create_dt DESC
    </select>


    <resultMap id="result_map_SPS_TASKDTO" type="com.xfs.sp.dto.SpsTaskDto">
        <result column="task_id" property="taskId"/>
        <result column="task_no" property="taskNo"/>
        <result column="emp_id" property="empId"/>
        <result column="cp_id" property="cpId"/>
        <result column="sp_id" property="spId"/>
        <result column="bstype_id" property="bstypeId"/>
        <result column="json" property="json"/>
        <result column="type" property="type"/>
        <result column="errmsg" property="errmsg"/>
        <result column="pic_id" property="picId"/>
        <result column="create_by" property="createBy"/>
        <result column="create_dt" property="createDt"/>
        <result column="modify_by" property="modifyBy"/>
        <result column="modify_dt" property="modifyDt"/>
        <result column="area_id" property="areaId"/>
        <result column="dr" property="dr"/>
        <result column="name" property="name"/>
        <result column="mobile" property="mobile"/>
        <result column="identity_code" property="identityCode"/>
        <result column="bstype_name" property="bstypeName"/>
        <result column="begin_date" property="beginDate"></result>
        <result column="online_status" property="onlineStatus"></result>
        <result column="parter_sp_id" property="parterSpId"></result>
        <result column="scheme_id" property="schemeId"></result>
        <result column="type_name" property="typeName"></result>
        <result column="if_type" property="ifType"></result>
        <result column="execute_date" property="executeDate"/>
    </resultMap>
    <!--左连接查询关于业务类型 -->
    <select id="findTaskByType" resultMap="result_map_SPS_TASKDTO" parameterType="Object">
        SELECT
        task.task_id,task.task_no,task.emp_id,task.cp_id,task.sp_id,task.bstype_id,task.json,task.type,task.errmsg,task.pic_id,task.create_by,task.create_dt,task.modify_by,task.modify_dt,task.area_id,task.dr,task.name,task.mobile,task.identity_code,task.begin_date,task.online_status,task.parter_sp_id,task.scheme_id,task.execute_date,type.name
        AS type_name,type.insurance_fund_type as if_type
        FROM sps_task task
        LEFT JOIN bd_bstype type
        ON task.bstype_id = type.bstype_id
        WHERE task.task_id=#{taskId}
        <if test="cpId != null">and task.cp_id=#{cpId}</if>
    </select>

    <!--查询diy字段-->
    <select id="findSpsTaskDIYFIELD" resultType="java.util.Map" parameterType="Object">
        select task.cp_id,task.type,task.bstype_id,type.insurance_fund_type,type.`name` from sps_task task LEFT JOIN
        bd_bstype type on task.bstype_id=type.bstype_id where task.cp_id =#{cpId}
    </select>


    <!--更新公积金usbport-->
    <select id="updateInsu" resultType="java.util.Map" parameterType="Object">
        update sps_account s2 set s2.usbport =#{usbport} where s2.acc_id in (SELECT s1.insurance_account_id from
        sps_scheme s1 where s1.scheme_id=#{schemeId});
    </select>


    <!--更新社保usbport-->
    <select id="updateFund" resultType="java.util.Map" parameterType="Object">
        update sps_account s2 set s2.usbport =#{usbport} where s2.acc_id in (SELECT s1.fund_account_id from sps_scheme
        s1 where s1.scheme_id=#{schemeId});
    </select>


    <update id="deleteTaskBySpIdAndCpId" parameterType="Object">
        UPDATE sps_task set dr = 1 WHERE cp_id = #{cpId} AND sp_id = #{spId}
    </update>

    <select id="countNoCompletedTask" resultType="Integer">
        SELECT count(1) FROM sps_task WHERE cp_id = #{cpId} AND sp_id = #{spId} AND dr = 0 AND TYPE = 'TODO'
    </select>

    <select id="findInsuranceFundByMonth" resultType="com.xfs.task.dto.TaskVo" parameterType="Object">
        select
        t1.addNumber,t2.subNumber,t3.supNumber,d1.dxxshNumber,d2.dbsddNumber,d3.dsjclNumber,d4.dtjzfNumber,d5.blcgNumber,d6.blycNumber,d7.dws,d8.wsz
        from
        (SELECT count(*) as addNumber from (SELECT t.emp_id FROM sps_task t where t.bstype_id in (2,3,10) and t.dr=0 and t.cp_id = ${cpId} AND t.type != 'CLOSED'
        <if test="countMonth != null and countMonth != ''"> and t.create_dt like '%${countMonth}%' </if>
        <if test="authority != 'ALL'"> 
			AND t.scheme_id in (${authority})
		</if>
        GROUP BY t.emp_id)t) t1
        ,(SELECT count(*) as subNumber from (SELECT t.emp_id FROM sps_task t where t.bstype_id in (4,11) and t.dr=0 and t.cp_id = ${cpId} AND t.type != 'CLOSED'
        <if test="countMonth != null and countMonth != ''"> and t.create_dt like '%${countMonth}%' </if>
        <if test="authority != 'ALL'"> 
			AND t.scheme_id in (${authority})
		</if>
        GROUP BY t.emp_id)t) t2
        ,(SELECT count(*) as supNumber from (SELECT t.emp_id FROM sps_task t where t.bstype_id in (29,30) and t.dr=0 and t.cp_id = ${cpId} AND t.type != 'CLOSED'
        <if test="countMonth != null and countMonth != ''"> and t.create_dt like '%${countMonth}%' </if>
        <if test="authority != 'ALL'"> 
			AND t.scheme_id in (${authority})
		</if>
        GROUP BY t.emp_id)t) t3
        ,(select count(*) as dxxshNumber from sps_task t INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0 AND e.cp_id = ${cpId}
        	where t.type = 'TODO' and t.state_filed_id = '7001' and t.dr = 0 and t.cp_id = ${cpId}
        	<if test="authority != 'ALL'"> 
				AND t.scheme_id in (${authority})
			</if>
        ) d1
        ,(select count(*) as dbsddNumber from sps_task t INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0 AND e.cp_id = ${cpId}
        	where t.type = 'TODO' and t.state_filed_id = '7002' and t.dr = 0 and t.cp_id = ${cpId}
        	<if test="authority != 'ALL'"> 
				AND t.scheme_id in (${authority})
			</if>
        ) d2
        ,(select count(*) as dsjclNumber from sps_task t INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0 AND e.cp_id = ${cpId}
        	where t.type = 'TODO' and t.state_filed_id = '7003' and t.dr = 0 and t.cp_id = ${cpId}
        	<if test="authority != 'ALL'"> 
				AND t.scheme_id in (${authority})
			</if>
        ) d3
        ,(select count(*) as dtjzfNumber from sps_task t INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0 AND e.cp_id = ${cpId}
        	where t.type = 'TODO' and t.state_filed_id = '7004' and t.dr = 0 and t.cp_id = ${cpId}
        	<if test="authority != 'ALL'"> 
				AND t.scheme_id in (${authority})
			</if>
        ) d4
        ,(select count(*) as blcgNumber from sps_task t INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0 AND e.cp_id = ${cpId}
        	where t.type = 'COMPLETED' and t.state_filed_id = '7009' and t.dr = 0 and t.cp_id = ${cpId}
        	<if test="authority != 'ALL'"> 
				AND t.scheme_id in (${authority})
			</if>
        ) d5
        ,(select count(*) as blycNumber from sps_task t INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0 AND e.cp_id = ${cpId}
        	where t.type = 'ERROR' and t.state_filed_id = '7000' and t.dr = 0 and t.cp_id = ${cpId}
        	<if test="authority != 'ALL'"> 
				AND t.scheme_id in (${authority})
			</if>
        ) d6
        ,(select count(*) as dws from sps_task t INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0 AND e.cp_id = ${cpId}
        	where t.type = 'TODO' and t.state_filed_id = '7144' and t.dr = 0 and t.cp_id = ${cpId}
        	<if test="authority != 'ALL'"> 
				AND t.scheme_id in (${authority})
			</if>
        ) d7
        ,(select count(*) as wsz from sps_task t INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0 AND e.cp_id = ${cpId}
        	where t.type = 'TODO' and t.state_filed_id = '7143' and t.dr = 0 and t.cp_id = ${cpId}
        	<if test="authority != 'ALL'"> 
				AND t.scheme_id in (${authority})
			</if>
        ) d8
    </select>

    <select id="findInsuranceFundMapByCity" resultType="com.xfs.task.dto.TaskMapVo" parameterType="Object">
        select s.p_num as peopleNumber,a.name as cityName
        from(
        select sum(s.p_num) as p_num,a.belong_province
        from
        (
        select count(s.scheme_id) as p_num ,s.area_id
        from
        (
        SELECT s.scheme_id,s.area_id,s.cp_id
        FROM sps_scheme s
        where s.dr = 0 and s.cp_id = ${cpId} 
        <if test="authority != 'ALL'"> 
			AND s.scheme_id in (${authority})
		</if>
        GROUP BY s.area_id
        ) s
        inner join sps_scheme_emp se on s.scheme_id = se.scheme_id and se.dr = 0 and se.state='USE'
        inner join cm_employee e on se.emp_id = e.emp_id and e.dr = 0
        GROUP BY s.area_id
        ) s
        inner join bs_area a on a.area_id = s.area_id
        GROUP BY a.belong_province
        ) s inner join bs_area a on s.belong_province = a.area_id
        order by peopleNumber desc
    </select>

    <select id="findItemWarnEndDateByCpId" resultType="com.xfs.task.dto.ItemWarnVo" parameterType="Object">
        select s.* from (
			(
				select s.end_date as endDate,GROUP_CONCAT( a.name) as name,'增员节点' as item
		        from(
		        	select s.end_date,a.belong_city
		        	from
				        (
				        SELECT s.area_id,t.end_day as end_date 
				        from sps_scheme s 
				        ,(select * from (select t.end_day,t.area_id from bd_bsareatype t where t.bstype_id in (2,3) and  t.end_day is not null order by t.end_day desc) t GROUP BY t.area_id) t
				        where s.cp_id=${cpId} and s.dr=0 and s.area_id=t.area_id AND s.sp_id = -999
				       <if test="authority != 'ALL'"> 
							AND s.scheme_id in (${authority})
						</if>
				        GROUP BY s.area_id,t.end_day
				        )s 
		        	INNER join bs_area a on s.area_id=a.area_id
		        	GROUP BY a.belong_city,s.end_date
		        ) s 
		        inner join bs_area a on s.belong_city = a.area_id
		        GROUP BY s.end_date
			)
		union
    	(
			select s.end_date as endDate,GROUP_CONCAT(s.spName) as name,'业务截止日' as item
        	from
        		(
        		SELECT s.end_date ,sp.sp_name as spName
        		from sps_scheme s,sp_service sp
        		where s.cp_id=${cpId} and s.dr=0 and s.sp_id != -999 and s.sp_id=sp.sp_id
       			<if test="authority != 'ALL'"> 
					AND s.scheme_id in (${authority})
				</if>
        		GROUP BY sp.sp_id,s.end_date
        		)s
        	GROUP BY s.end_date
    	)
		union
    	(
    		select s.bill_date as endDate,GROUP_CONCAT(s.spName) as name,'账单日' as item
        	from
        		(
        		SELECT s.bill_date ,sp.sp_name as spName
        		from sps_scheme s,sp_service sp
        		where s.cp_id=${cpId} and s.dr=0 and s.sp_id != -999 and s.sp_id=sp.sp_id and s.bill_date is not null
   				<if test="authority != 'ALL'"> 
					AND s.scheme_id in (${authority})
				</if>
        		GROUP BY sp.sp_id,s.bill_date
        		)s
        	GROUP BY s.bill_date
		)
		union
    	(
	   	 	select s.pay_date as endDate,GROUP_CONCAT(s.spName) as name,'付款日' as item
	        from
	        	(
	        	SELECT s.pay_date ,sp.sp_name as spName
	        	from sps_scheme s,sp_service sp
	        	where s.cp_id=${cpId} and s.dr=0 and s.sp_id != -999 and s.sp_id=sp.sp_id and s.pay_date is not null
				<if test="authority != 'ALL'"> 
					AND s.scheme_id in (${authority})
				</if>
	        	GROUP BY sp.sp_id,s.pay_date
	        	)s
	        GROUP BY s.pay_date
      	)
  		)s
  		order by s.endDate
    </select>

    <!-- 员工流动趋势图 -->
    <select id="findEmployeeFlowChartByCityId" resultType="com.xfs.corp.model.CmEmployeeInsurance"
            parameterType="Object">
        select ins.emp_id as empId,min(ins.begin_period) as beginPeriod,max(ifnull(ins.end_period,'2099-12')) as
        endPeriod
        from cm_employee_insurance ins
        left join cm_employee emp on ins.emp_id = emp.emp_id and emp.dr = 0
        left join sps_scheme_emp semp on emp.emp_id = semp.emp_id and semp.dr=0
        left join sps_scheme s on semp.scheme_id = s.scheme_id and s.dr=0
        where emp.cp_id = ${cpId} and ins.begin_period &lt;= '${beginPeriod}'
        and ifnull(ins.end_period,'2099-12') &gt;= '${endPeriod}'
        and ins.dr = 0 and ins.pay_type = 'MONTH'
        <if test="cityId != null and cityId != '' and cityId != '-1'">and s.area_id = ${cityId}</if>
        <if test="authority != 'ALL'"> 
			AND s.scheme_id in (${authority})
		</if>
        group by ins.emp_id ORDER BY ins.begin_period
    </select>

    <!-- 员工流动分析列表 -->
    <select id="findEmployeeFlowChartByCityIdList" resultType="java.util.Map" parameterType="Object">

        select * from (
            select ins.emp_id as empId, emp.name , emp.identity_code, area.name as areaName
                ,CASE min(ins.begin_period) WHEN #{beginPeriod} THEN '新增' ELSE '减员' END as empType
                ,min(ins.begin_period) as beginPeriod,max(ifnull(ins.end_period,'2099-12')) as endPeriod
            from cm_employee_insurance ins
                left join cm_employee emp on ins.emp_id = emp.emp_id and emp.dr = 0
                left join sps_scheme_emp semp on emp.emp_id = semp.emp_id and semp.dr=0
                left join sps_scheme s on semp.scheme_id = s.scheme_id and s.dr=0
                inner join bs_area area on area.area_id = s.area_id
            where emp.cp_id = ${cpId} and ins.begin_period = #{beginPeriod}
              and ins.dr = 0 and ins.pay_type = 'MONTH'
            <if test="areaId != null and areaId != '' and areaId != '-1'">and s.area_id = ${areaId}</if>
            <if test="authority != 'ALL'">
                AND s.scheme_id in (${authority})
            </if>
            group by ins.emp_id

            UNION ALL

            select * from (
                select ins.emp_id as empId, emp.name , emp.identity_code, area.name as areaName
                    ,CASE min(ins.end_period) WHEN #{beginPeriod} THEN '减员' ELSE '新增' END as empType
                    ,min(ins.begin_period) as beginPeriod,max(ifnull(ins.end_period,'2099-12')) as endPeriod
                from cm_employee_insurance ins
                    left join cm_employee emp on ins.emp_id = emp.emp_id and emp.dr = 0
                    left join sps_scheme_emp semp on emp.emp_id = semp.emp_id and semp.dr=0
                    left join sps_scheme s on semp.scheme_id = s.scheme_id and s.dr=0
                    inner join bs_area area on area.area_id = s.area_id
                where emp.cp_id = ${cpId}
                  and ins.dr = 0 and ins.pay_type = 'MONTH'
                <if test="areaId != null and areaId != '' and areaId != '-1'">and s.area_id = ${areaId}</if>
                <if test="authority != 'ALL'">
                    AND s.scheme_id in (${authority})
                </if>
                group by ins.emp_id
            ) t where t.endPeriod = #{beginPeriod}
        ) m order by m.empId desc

    </select>

    <!-- 员工流动分析列表 -->
    <select id="findEmployeeFlowChartByCityIdListCount" resultType="java.lang.Integer" parameterType="Object">

        select count(*) as value from (
        select ins.emp_id as empId, emp.name , emp.identity_code, area.name as areaName
        ,CASE min(ins.begin_period) WHEN #{beginPeriod} THEN '新增' ELSE '减员' END as empType
        ,min(ins.begin_period) as beginPeriod,max(ifnull(ins.end_period,'2099-12')) as endPeriod
        from cm_employee_insurance ins
        left join cm_employee emp on ins.emp_id = emp.emp_id and emp.dr = 0
        left join sps_scheme_emp semp on emp.emp_id = semp.emp_id and semp.dr=0
        left join sps_scheme s on semp.scheme_id = s.scheme_id and s.dr=0
        inner join bs_area area on area.area_id = s.area_id
        where emp.cp_id = ${cpId} and ins.begin_period = #{beginPeriod}
        and ins.dr = 0 and ins.pay_type = 'MONTH'
        <if test="areaId != null and areaId != '' and areaId != '-1'">and s.area_id = ${areaId}</if>
        <if test="authority != 'ALL'">
            AND s.scheme_id in (${authority})
        </if>
        group by ins.emp_id

        UNION ALL

        select * from (
        select ins.emp_id as empId, emp.name , emp.identity_code, area.name as areaName
        ,CASE min(ins.end_period) WHEN #{beginPeriod} THEN '减员' ELSE '新增' END as empType
        ,min(ins.begin_period) as beginPeriod,max(ifnull(ins.end_period,'2099-12')) as endPeriod
        from cm_employee_insurance ins
        left join cm_employee emp on ins.emp_id = emp.emp_id and emp.dr = 0
        left join sps_scheme_emp semp on emp.emp_id = semp.emp_id and semp.dr=0
        left join sps_scheme s on semp.scheme_id = s.scheme_id and s.dr=0
        inner join bs_area area on area.area_id = s.area_id
        where emp.cp_id = ${cpId}
        and ins.dr = 0 and ins.pay_type = 'MONTH'
        <if test="areaId != null and areaId != '' and areaId != '-1'">and s.area_id = ${areaId}</if>
        <if test="authority != 'ALL'">
            AND s.scheme_id in (${authority})
        </if>
        group by ins.emp_id
        ) t where t.endPeriod = #{beginPeriod}
        ) m order by m.empId desc

    </select>


    <select id="findHandlePersonnelListCount" resultType="java.util.Map" parameterType="Object">
        select count(1) as c_value,GROUP_CONCAT(DISTINCT e.bstypename) as bstypenames
        from(
        SELECT
        t.task_id,e.name,c.name as identityType,e.identity_code,a.belong_city,b.insurance_fund_type,b.bstype_id,t.state_filed_id,t.state_filed_name,t.create_dt,e.mobile,d.`name`
        as livingType,e.fund_salary,e.insurance_salary,t.begin_date,e.entry_time,t.errmsg,t.pic_url,t.scheme_id
        ,IFNULL(t.modify_dt,e.modify_dt) as modify_dt,b.name as bstypename,e.`head_photo` as headPhoto
        FROM sps_task t
        INNER join cm_employee e on t.emp_id = e.emp_id and e.dr = 0
        left join bs_area a on t.area_id = a.area_id
        left join bd_bstype b on t.bstype_id = b.bstype_id
        left join sys_dictitem d on e.insurance_living_type=d.code and d.dictionary=93 and a.area_id=d.area_id
		inner join sys_dictitem c on e.identity_type=c.code and c.dictionary=89
        where t.cp_id = ${cpId} and t.dr=0
        <if test="stateFiledId != null and stateFiledId != ''">
            <if test="stateFiledId == '7000'">and t.type = 'ERROR'</if>
            <if test="stateFiledId == '7009'">and (t.type = 'COMPLETED' or t.type = 'CLOSED')</if>
            <if test="stateFiledId == '7144'">
                and t.type = 'TODO' AND t.state_filed_id != 7143
            </if>
            <if test="stateFiledId == '7143'">
                and t.type = 'TODO' AND t.state_filed_id = 7143
            </if>
        </if>
        <if test="insuranceFundType != null and insuranceFundType != ''">
            and b.insurance_fund_type = #{insuranceFundType}
        </if>
        <if test="bstype != null and bstype != ''">
            and b.name = #{bstype}
        </if>
        <if test="authority != 'ALL'">
			AND t.scheme_id in (${authority})
		</if>
         GROUP BY t.task_id
        ) e left join bs_area a on e.belong_city = a.area_id
        where 1=1
        <if test="cityId != null and cityId != ''">and e.belong_city = ${cityId}</if>
        <if test="name != null and name != ''">and CONCAT(e.name,e.identity_code) LIKE CONCAT('%',#{name},'%')</if>
        <if test="countMonth != null and countMonth != ''"> and e.create_dt like CONCAT('%',#{countMonth},'%') </if>
        <if test="queryMonth != null and queryMonth != ''">
        	<if test="stateFiledId == 7144">
        		and e.create_dt like CONCAT('%',#{countMonth},'%')
        	</if>
        	<if test="stateFiledId == 7143 or stateFiledId == 7009 or stateFiledId == 7000">
        		and e.modify_dt like CONCAT('%',#{countMonth},'%')
        	</if>
        </if>
    </select>

    <select id="findHandlePersonnelList" resultType="com.xfs.task.dto.HandlePersonnelListVo" parameterType="Object">
        select e.name as name,e.identityType,e.identity_code as code,a.name as cityName,a.area_id as areaId
        ,CASE e.insurance_fund_type WHEN 'INSURANCE' THEN '社保' ELSE '公积金' END as insuranceFundType
        ,e.bstypename as bstype
        ,e.state_filed_name as stateFiledName,e.create_dt as createDt,e.mobile,e.fund_salary as
        fundSalary,e.insurance_salary as insuranceSalary,DATE_FORMAT(e.entry_time,'%Y-%m') AS beginPeriod,e.livingType,e.pic_url as
        picUrl,e.errmsg,e.task_id as taskId,e.scheme_id as schemeId,e.json,e.headPhoto,e.modify_dt as modifyDt
        from(
        SELECT
        t.task_id,e.name,c.name as identityType,e.identity_code,a.belong_city,b.insurance_fund_type,b.bstype_id,t.state_filed_id,t.state_filed_name,t.create_dt,e.mobile,d.`name`
        as livingType,e.fund_salary,e.insurance_salary,t.begin_date,e.entry_time,t.errmsg,t.pic_url,t.scheme_id
        ,IFNULL(t.modify_dt,e.modify_dt) as modify_dt,b.name as bstypename,t.json,e.`head_photo` as headPhoto
        FROM sps_task t
        LEFT join cm_employee e on t.emp_id = e.emp_id AND e.cp_id = ${cpId}
        left join bs_area a on t.area_id = a.area_id
        left join bd_bstype b on t.bstype_id = b.bstype_id
        left join sys_dictitem d on e.insurance_living_type=d.code and d.dictionary=93 and a.area_id=d.area_id
		inner join sys_dictitem c on e.identity_type=c.code and c.dictionary=89
        where t.cp_id = ${cpId} and t.dr=0
        <if test="stateFiledId != null and stateFiledId != ''">
            <if test="stateFiledId == '7000'">and t.type = 'ERROR'</if>
            <if test="stateFiledId == '7009'">and (t.type = 'COMPLETED' or t.type = 'CLOSED')</if>
            <if test="stateFiledId == '7144'">
                and t.type = 'TODO' AND t.state_filed_id != 7143
            </if>
            <if test="stateFiledId == '7143'">
                and t.type = 'TODO' AND t.state_filed_id = 7143
            </if>
        </if>
        <if test="insuranceFundType != null and insuranceFundType != ''">
            and b.insurance_fund_type = #{insuranceFundType}
        </if>
        <if test="bstype != null and bstype != ''">
            and b.name = #{bstype}
        </if>
        <if test="authority != 'ALL'">
			AND t.scheme_id in (${authority})
		</if>
         GROUP BY t.task_id
        ) e left join bs_area a on e.belong_city = a.area_id
        where 1=1
        <if test="cityId != null and cityId != ''">and e.belong_city = ${cityId}</if>
        <if test="name != null and name != ''">and CONCAT(e.name,e.identity_code) LIKE CONCAT('%',#{name},'%')</if>
        <if test="countMonth != null and countMonth != ''"> and e.create_dt like CONCAT('%',#{countMonth},'%') </if>
        <if test="queryMonth != null and queryMonth != ''">
        	<if test="stateFiledId == 7144">
        		and e.create_dt like CONCAT('%',#{countMonth},'%')
        	</if>
        	<if test="stateFiledId == 7143 or stateFiledId == 7009 or stateFiledId == 7000">
        		and e.modify_dt like CONCAT('%',#{countMonth},'%')
        	</if>
        </if>
        order by e.modify_dt desc
    </select>

    <select id="findOtherBusinessStateByMonth" resultType="java.util.Map" parameterType="Object">
        select count(1) AS countNumber,b.name,t.state_filed_name as stateFiledName
        from sps_task t
 		left join bd_bstype b on t.bstype_id=b.bstype_id
 		where t.bstype_id in (38,39,40,41,42,43,44,45,46,47,48,49,50) and t.dr=0 and t.cp_id=${cpId} and t.create_dt like '%${countMonth}%'
		and t.state_filed_id in(7001,7009,7000)
		<if test="authority != 'ALL'"> 
			AND t.scheme_id in (${authority})
		</if>
		GROUP BY t.bstype_id,t.type,t.state_filed_id
		ORDER BY b.name,t.state_filed_name
    </select>

    <update id="UPDATE_TASK_OUT_ID" parameterType="Object">
        UPDATE SPS_TASK
        <trim prefix=" SET " prefixOverrides=",">
            <if test="taskId != null ">,task_id=#{taskId}</if>
            <if test="taskNo != null">,task_no = #{taskNo}</if>
            <if test="empId != null">,emp_id = #{empId}</if>
            <if test="cpId != null ">,cp_id=#{cpId}</if>
            <if test="spId != null ">,sp_id=#{spId}</if>
            <if test="bstypeId != null ">,bstype_id=#{bstypeId}</if>
            <if test="json != null ">,json=#{json}</if>
            <if test="type != null ">,type=#{type}</if>
            <if test="errmsg != null ">,errmsg=#{errmsg}</if>
            <if test="picId != null ">,pic_id=#{picId}</if>
            <if test="createBy != null ">,create_by=#{createBy}</if>
            <if test="createDt != null ">,create_dt=#{createDt}</if>
            <if test="modifyBy != null ">,modify_by=#{modifyBy}</if>
            <if test="modifyDt != null ">,modify_dt=#{modifyDt}</if>
            <if test="areaId != null ">,area_id=#{areaId}</if>
            <if test="dr != null ">,dr=#{dr}</if>
            <if test="name != null ">,name=#{name}</if>
            <if test="mobile != null ">,mobile=#{mobile}</if>
            <if test="identityCode != null ">,identity_code=#{identityCode}</if>
            <if test="beginDate != null ">,begin_date=#{beginDate}</if>
            <if test="onlineStatus != null ">,online_status=#{onlineStatus}</if>
            <if test="parterSpId != null ">,parter_sp_id=#{parterSpId}</if>
            <if test="schemeId != null ">,scheme_id=#{schemeId}</if>
            <if test="executeDate != null ">,execute_date=#{executeDate}</if>
            <if test="stateFiledName != null">,state_filed_name = #{stateFiledName}</if>
            <if test="stateFiledId != null">,state_filed_id = #{stateFiledId}</if>
            <if test="picUrl != null">,pic_url = #{picUrl}</if>
        </trim>
        WHERE task_outer_id=#{taskOuterId}
    </update>

    <resultMap id="result_map_sps_task_state" type="com.xfs.employeeside.dto.SpsStateDto">
        <result column="id" property="id"/>
        <result column="bd_bsareatype_id" property="bdBsareatypeId"/>
        <result column="sys_dictitem_id" property="sysDicitemId"/>
        <result column="step" property="step"/>
        <result column="coee" property="code"/>
        <result column="name" property="name"/>
        <result column="time" property="time"/>
        <result column="location" property="location"/>
        <result column="state" property="state"/>
    </resultMap>

    <!-- 根据id查询 调度任务表 -->
    <select id="getAllStateBy" resultMap="result_map_sps_task_state" parameterType="Object">
        SELECT bb.*,dic.code ,dic.name FROM bd_bsareatype_process bb
        LEFT JOIN sys_dictitem dic on bb.sys_dictitem_id = dic.id
        WHERE bd_bsareatype_id=
        (SELECT id FROM bd_bsareatype WHERE bstype_id= #{bsTypeId} and area_id=#{areaId})
        and company_type=#{orgType}
        ORDER BY bb.step desc

    </select>
    <!-- 根据id查询 调度任务表 -->
    <select id="getSpsTaskByCondition" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        from  sps_task
        WHERE emp_id=#{empId}
        AND bstype_id=#{bsTypeId}
        AND  type  &lt;&gt; 'ERROR'
        and  type &lt;&gt; 'CLOSED'
        AND LEFT(create_dt,7) = LEFT (#{createDt},7)
        LIMIT 1

    </select>

    <!-- 首页 获取社保公积金申报进度-->
    <select id="findInsuranceFundProgress" resultType="com.xfs.task.dto.TaskVo" parameterType="Object">
		select
        	d1.ddsbNumber,d2.wszNumber,d3.blcgNumber,d4.blycNumber
        from
		(select count(*) as ddsbNumber from sps_task t where t.type = 'TODO' and t.state_filed_id = '7144' and t.dr = 0 and t.cp_id = ${cpId}) d1
        ,(select count(*) as wszNumber from sps_task t where t.type = 'TODO' and t.state_filed_id = '7143' and t.dr = 0 and t.cp_id = ${cpId}) d2
        ,(select count(*) as blcgNumber from sps_task t where t.type = 'COMPLETED' and t.state_filed_id = '7009' and t.dr = 0 and t.cp_id = ${cpId}) d3
        ,(select count(*) as blycNumber from sps_task t where t.type = 'ERROR' and t.state_filed_id = '7000' and t.dr = 0 and t.cp_id = ${cpId}) d4
    </select>


    <!-- 根据员工id查询 调度任务表 -->
    <select id="getAllSpsTaskAndSort" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sps_task WHERE emp_id=#{empId}
        and bstype_id in (
        SELECT bstype_id FROM  bd_bstype WHERE bstype_id in(${bstypeId}) or patrent_type_id in (${bstypeId}))
        ORDER BY create_dt
        DESC;

    </select>

    <!-- 根据员工id 和任务类型查询 调度任务表 -->
    <select id="getTwoTodoAndSort" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sps_task WHERE emp_id=#{empId}
        and bstype_id in (
        SELECT bstype_id FROM  bd_bstype WHERE bstype_id in(${bstypeId}) or patrent_type_id in(${bstypeId}))
        ORDER BY create_dt DESC
        limit 2;
    </select>


    <update id="delTaskByEmpIds" parameterType="Object">
        update sps_task ce set ce.dr = 1 where ce.cp_id = #{cpId} and ce.emp_id in (${empIds}) AND ce.type = 'TODO'
        <if test="bstypeId != null"> and bstype_id = #{bstypeId}</if>
    </update>

    <!-- 根据员工id 查询 变更医院 或 新参 任务单json -->
    <select id="getUseHostptialByEmpId" resultType="java.lang.String" parameterType="Object">
       SELECT json from sps_task
       WHERE emp_id=#{empId} and bstype_id in (2,7) and type ='COMPLETED' and dr=0
      ORDER BY create_dt desc  LIMIT 1;
    </select>

    <select id="findTaskByEmpId" parameterType="Object" resultType="java.util.Map" >
        select bb.`name`, (case when st.modify_dt is null then st.create_dt else st.modify_dt end) as modifyDt from sps_task st INNER JOIN bd_bstype bb on st.bstype_id = bb.bstype_id
        where emp_id = #{empId} and st.type = 'COMPLETED' and st.dr = 0 and st.company_type = 'SELFSERVICE' ORDER BY create_dt DESC
    </select>

    <insert id="insertByBatch" parameterType="java.util.List">
        INSERT INTO SPS_TASK (type,emp_id, json,cp_id,sp_id,create_by,create_dt,company_type,name,dr,bstype_id,area_id,identity_code,begin_date,execute_date,scheme_id,state_filed_name,state_filed_id)
        values
        <foreach collection="list" item="item" index="index" separator="," >
            (#{item.type},#{item.empId},#{item.json},#{item.cpId},#{item.spId},#{item.createBy},#{item.createDt},#{item.companyType},#{item.name},#{item.dr},#{item.bstypeId},#{item.areaId},#{item.identityCode},#{item.beginDate},#{item.executeDate},#{item.schemeId},#{item.stateFiledName},#{item.stateFiledId})
        </foreach>
    </insert>


    <update id="updateByBatch" parameterType="Object">
        UPDATE SPS_TASK
        <trim prefix=" SET " prefixOverrides=",">
            <if test="taskNo != null">,task_no = #{taskNo}</if>
            <if test="empId != null">,emp_id = #{empId}</if>
            <if test="cpId != null ">,cp_id=#{cpId}</if>
            <if test="spId != null ">,sp_id=#{spId}</if>
            <if test="bstypeId != null ">,bstype_id=#{bstypeId}</if>
            <if test="json != null ">,json=#{json}</if>
            <if test="type != null ">,type=#{type}</if>
            <if test="errmsg != null ">,errmsg=#{errmsg}</if>
            <if test="picId != null ">,pic_id=#{picId}</if>
            <if test="createBy != null ">,create_by=#{createBy}</if>
            <if test="createDt != null ">,create_dt=#{createDt}</if>
            <if test="modifyBy != null ">,modify_by=#{modifyBy}</if>
            <if test="modifyDt != null ">,modify_dt=#{modifyDt}</if>
            <if test="areaId != null ">,area_id=#{areaId}</if>
            <if test="dr != null ">,dr=#{dr}</if>
            <if test="name != null ">,name=#{name}</if>
            <if test="mobile != null ">,mobile=#{mobile}</if>
            <if test="identityCode != null ">,identity_code=#{identityCode}</if>
            <if test="beginDate != null ">,begin_date=#{beginDate}</if>
            <if test="onlineStatus != null ">,online_status=#{onlineStatus}</if>
            <if test="parterSpId != null ">,parter_sp_id=#{parterSpId}</if>
            <if test="schemeId != null ">,scheme_id=#{schemeId}</if>
            <if test="executeDate != null ">,execute_date=#{executeDate}</if>
            <if test="stateFiledName != null">,state_filed_name = #{stateFiledName}</if>
            <if test="stateFiledId != null">,state_filed_id = #{stateFiledId}</if>
            <if test="picUrl != null">,pic_url = #{picUrl}</if>
        </trim>
        WHERE task_outer_id in
        <foreach item="id" index="index" collection="taskIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="updateByBatchByTaskNos" parameterType="Object">
        UPDATE SPS_TASK
        <trim prefix=" SET " prefixOverrides=",">
            <if test="bstypeId != null ">,bstype_id=#{bstypeId}</if>
            <if test="errmsg != null ">,errmsg=#{errmsg}</if>
            <if test="modifyDt != null ">,modify_dt=#{modifyDt}</if>
            <if test="dr != null ">,dr=#{dr}</if>
            <if test="stateFiledName != null">,state_filed_name = #{stateFiledName}</if>
            <if test="stateFiledId != null">,state_filed_id = #{stateFiledId}</if>
            <if test="picUrl != null">,pic_url = #{picUrl}</if>
        </trim>
        WHERE task_no in
        <foreach item="id" index="index" collection="taskNos" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>


    <select id="queryByBatch" resultMap="result_map_SPS_TASK" parameterType="Object">
        SELECT t.*,emp.name as empName,b.`name` as bsType,(CASE WHEN b.insurance_fund_type = 'INSURANCE' THEN insAcc.reg_num ELSE fundAcc.reg_num END ) as regNum,city.ukey_type as ukeyType,b.insurance_fund_type as insuranceFundType FROM sps_task t INNER JOIN cm_employee emp ON t.emp_id = emp.emp_id AND t.cp_id = #{cpId} AND t.task_id in
        <foreach item="id" index="index" collection="taskIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        <if test="stateFiledId != null and stateFiledId != ''">
            <if test="stateFiledId == '7000'">and t.type = 'ERROR'</if>
            <if test="stateFiledId == '7009'">and (t.type = 'COMPLETED' or t.type = 'CLOSED')</if>
            <if test="stateFiledId == '7001' or stateFiledId == '7002' or stateFiledId == '7003'
             or stateFiledId == '7004' or stateFiledId == '7143' or stateFiledId == '7144'">
                and t.type = 'TODO'
            </if>
        </if>
        LEFT JOIN sps_scheme scheme ON scheme.scheme_id = t.scheme_id
        <if test="authority != 'ALL'">
          AND scheme.scheme_id in (${authority})
        </if>
        LEFT JOIN sps_account fundAcc ON fundAcc.acc_id = scheme.fund_account_id
        LEFT JOIN sps_account insAcc ON insAcc.acc_id = scheme.insurance_account_id
        LEFT JOIN bd_bstype b ON t.bstype_id = b.bstype_id
        <if test="loginList != null ">
            INNER JOIN
            <foreach item="vo" index="index" collection="loginList" open="(" separator=" UNION ALL " close=")">
                SELECT #{vo.areaId} as areaId,#{vo.insuranceFundType} as bstype
            </foreach>
             t ON t.areaId = t.area_id AND t.bstype = b.insurance_fund_type
        </if>
        INNER JOIN bs_area ba ON  ba.area_id = t.area_id
        LEFT JOIN sps_ts_citycode city ON city.area_id = ba.`code` AND
        (
        CASE WHEN city.ukey_type = 'THREE' THEN b.insurance_fund_type in ('FUND','INSURANCE')
        WHEN city.ukey_type = 'INSURANCE_FUND' THEN b.insurance_fund_type in ('FUND','INSURANCE')
        ELSE
        b.insurance_fund_type in (city.ukey_type)
        END
        )
    </select>
    <!-- 根据月份获取任务数量 -->
    <select id="findBusinessNumber" resultType="java.lang.Integer" parameterType="Object">
    	select count(1)
		from sps_task t inner join sps_scheme s on t.scheme_id=s.scheme_id and s.dr=0
		<if test="areaId != '' and areaId != null">
		and s.area_id = #{areaId}
		</if>
		<if test="authority != 'ALL'">
		and s.scheme_id in (${authority})
		</if>
		where t.cp_id=#{cpId} and t.sp_id=#{spId} and t.bstype_id in (2,3,4,10,11,29,30,31,32,33,34) and t.dr=0 and t.begin_date = #{beginDate}
    </select>
    <!-- 查询 已完成的调基任务单 lifq 20170814 ,处理完后 modify_by改成-1-->
    <select id="queryCompletedAdjustTask" resultMap="result_map_SPS_TASK" parameterType="Object">
	    SELECT t.* FROM SPS_TASK t,cm_employee emp 
		where t.emp_id=emp.emp_id and t.task_outer_id is not null and t.type = 'COMPLETED' 
		and emp.dr=0  and t.dr=0 and t.modify_by !=-1
		<if test="bstypeId == 31 ">
		 and t.bstype_id = 31 and emp.insurance_state='ON'
		</if>
		<if test="bstypeId == 32 ">
		 and t.bstype_id = 32 and emp.fund_state='ON'
		</if>
		<if test="areaId !=null ">
		 and t.area_id = #{areaId}
		</if>
		order by t.create_dt
    </select>

    <select id="findByEmpId" resultMap="result_map_SPS_TASK" parameterType="Object">
        select <include refid="Base_Column_List"/> from `sps_task` 
        where `bstype_id` = #{bstypeId} and emp_id = #{empId} and `type`= #{type} and dr = 0
        order by task_id desc
    </select>


    <insert id="repairTaskReport" parameterType="Object">
        INSERT INTO sps_task_history (task_id,bstype_id,type,create_by,create_dt,dr,state_filed_id,state_filed_name,errmsg,pic_url,task_outer_id)
        SELECT task.task_id,task.bstype_id,task.type,task.create_by,NOW(),0,apro.sys_dictitem_id,
        CASE WHEN apro.sys_dictitem_id = 7000 THEN '办理异常'
        WHEN apro.sys_dictitem_id = 7001 THEN '待信息审核'
        WHEN apro.sys_dictitem_id = 7002 THEN '待报送当地'
        WHEN apro.sys_dictitem_id = 7003 THEN '待收集材料'
        WHEN apro.sys_dictitem_id = 7004 THEN '待提交政府'
        WHEN apro.sys_dictitem_id = 7009 THEN '办理成功'
        WHEN apro.sys_dictitem_id = 7143 THEN '网申中'
        WHEN apro.sys_dictitem_id = 7144 THEN '等待申报'
        WHEN apro.sys_dictitem_id = 7200 THEN '提交申请'
        END AS state_filed_name,
        task.errmsg,task.pic_url,task.task_outer_id FROM sps_task task INNER JOIN bd_bsareatype atype ON task.area_id = atype.area_id AND task.bstype_id = atype.bstype_id AND task.task_id = #{taskId}
        INNER JOIN bd_bsareatype_process apro ON apro.bd_bsareatype_id = atype.ID
        WHERE apro.step &lt; (
        SELECT step FROM bd_bsareatype_process ep where ep.bd_bsareatype_id = atype.ID AND ep.sys_dictitem_id = task.state_filed_id
        )
        GROUP BY apro.step
        ORDER BY apro.step ASC;
    </insert>


    <!-- 任务单趋势图 -->
    <select id="QUERY_TASK_TREND" resultType="java.util.Map" parameterType="Object">
        SELECT p.period,bstype.insurance_fund_type, Count(DISTINCT task.task_id) as taskNum
        FROM
        (
        <foreach collection="months" index="index"  separator="UNION ALL" item="list">
            SELECT #{list} AS period
        </foreach>
        ) p
        left join sps_task task on p.period = date_format(task.create_dt,'%Y-%m')
        inner join bd_bstype bstype on bstype.bstype_id = task.bstype_id
        INNER JOIN sps_scheme scheme ON scheme.scheme_id = task.scheme_id
        <if test="areaId!=null and areaId != -1">
            AND scheme.area_id = #{areaId}
        </if>
        where task.cp_id = #{cpId} and task.dr = 0
        <if test="authority != 'ALL'">
            AND scheme.scheme_id in (${authority})
        </if>
        group by bstype.insurance_fund_type,p.period
    </select>

    <!-- 任务单分析列表 -->
    <select id="QUERY_TASK_TREND_LIST" resultType="java.util.Map" parameterType="Object">
        SELECT bstype.insurance_fund_type, bstype.name as bsTypeName, area.name as areaName, task.*
        ,CASE task.`state_filed_id` WHEN '7001' THEN '待完善' WHEN '7144' THEN '待处理' WHEN '7143' THEN '网申中' WHEN '7009' THEN '已完成' ELSE '失败' END as status
        ,CASE bstype.insurance_fund_type WHEN 'INSURANCE' THEN '社保' WHEN 'FUND' THEN '公积金' ELSE '--' END as insFundType
        ,CASE task.company_type WHEN 'SELFSERVICE' THEN '网申任务' ELSE sp.sp_name END as taskType
        FROM  sps_task task
        inner join bd_bstype bstype on bstype.bstype_id = task.bstype_id
        INNER JOIN sps_scheme scheme ON scheme.scheme_id = task.scheme_id
        inner join bs_area area on area.area_id = scheme.area_id
        left join sp_service sp on sp.sp_id = task.sp_id
        <if test="areaId!=null and areaId != -1">
            AND scheme.area_id = #{areaId}
        </if>
        where task.cp_id = #{cpId} and task.dr = 0 and date_format(NOW(),'%Y-%m') = date_format(task.create_dt,'%Y-%m')
        <if test="authority != 'ALL'">
            AND scheme.scheme_id in (${authority})
        </if>
        order by task.create_dt desc
    </select>

    <!-- 任务单分析Count -->
    <select id="QUERY_TASK_TREND_LIST_COUNT" resultType="java.lang.Integer" parameterType="Object">
        SELECT count(1) as value
        FROM  sps_task task
        inner join bd_bstype bstype on bstype.bstype_id = task.bstype_id
        INNER JOIN sps_scheme scheme ON scheme.scheme_id = task.scheme_id
        inner join bs_area area on area.area_id = scheme.area_id
        left join sp_service sp on sp.sp_id = task.sp_id
        <if test="areaId!=null and areaId != -1">
            AND scheme.area_id = #{areaId}
        </if>
        where task.cp_id = #{cpId} and task.dr = 0 and date_format(NOW(),'%Y-%m') = date_format(task.create_dt,'%Y-%m')
        <if test="authority != 'ALL'">
            AND scheme.scheme_id in (${authority})
        </if>
    </select>

    <!-- 获取任务中心数据列表总数 -->
    <select id="findTaskCenterListCount"  resultType="java.lang.Integer" parameterType="Object">
        select count(t.taskId) as value
		from(
			SELECT 
				t.`task_id` as taskId,t.`emp_id` as empId,t.`name` as empName,t.`identity_code` as code,ifnull(t.`mobile`,'--') as mobile,a.`name` as areaName
				,CASE b.insurance_fund_type WHEN 'INSURANCE' THEN '社保' WHEN 'FUND' THEN '公积金' ELSE '--' END as insFundType
				,b.bstype_id as bstypeId,ifnull(b.`name`,'--') as bstypeName
				<if test="type == 0">
				,t.`create_dt` as createDt
				</if>
				<if test="type == 1 or type == 2 ">
				,t.`modify_dt` as createDt 
				</if> 
				,ifnull(t.modify_dt,t.create_dt) taskTime
				<if test="outTaskCenterTime != null">,#{outTaskCenterTime} as outTaskCenterTime</if>
				,CASE WHEN t.bstype_id = -99 THEN '入职任务' ELSE '网申任务' END AS taskType
				,'' as spName ,t.`state_filed_id` as filedId,t.`state_filed_name` as filedName
				,CASE WHEN (t.state_filed_id=7001 or t.state_filed_id=7144) THEN '待处理'
				WHEN t.type='TODO' AND t.state_filed_id=7143 THEN '处理中'
				WHEN t.type='COMPLETED' THEN '已完成'
				WHEN t.type='CLOSED' THEN '已关闭'
				WHEN t.type='ERROR' THEN '失败'
				ELSE '待处理' END as status
				,t.area_id as areaId,t.type
				,t.dr
			FROM sps_task t 
			left join cm_employee e on t.emp_id = e.emp_id
			inner join bs_area a on t.area_id = a.area_id 
			left join bd_bstype b on t.bstype_id = b.bstype_id
			where t.cp_id = #{cpId}
			<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
			<if test="type == 0">
			 	and t.type in('TODO','ERROR')
	            and t.`state_filed_id` in (7001,7144,7000)
	        </if>
			<if test="type == 1">
				and t.type in('TODO','SUBMIT')
				and t.`state_filed_id` in (7143)
			</if>
			<if test="type == 2">
				and t.type in('COMPLETED','CLOSED')
			</if>
			<if test="authority != 'ALL' and type == 0">
				AND (t.scheme_id in (${authority}) or t.scheme_id is null)
			</if>
			<if test="authority != 'ALL' and type != 0">
				AND t.scheme_id in (${authority})
			</if>
			<!-- taskType 任务类型 ALL：全部，SELFSERVICE：网申任务，SERVICE：服务商任务，ENTRY：入职任务 -->
			<if test="taskType == 'SELFSERVICE'">
				and t.company_type='SELFSERVICE'
				and t.bstype_id != -99
			</if>
			<if test="taskType == 'SERVICE'">
				and t.company_type='SERVICE'
				and t.bstype_id != -99
			</if>
			<if test="taskType == 'ENTRY'">
				and t.bstype_id=-99
			</if>
			<if test="insuranceFundType != null and insuranceFundType != ''">
				and b.insurance_fund_type=#{insuranceFundType}
			</if>
			<if test="bstype != null and bstype != ''">
				and t.bstype_id=#{bstype}
			</if>
			union all
			SELECT 
				t.`task_id` as taskId,t.`emp_id` as empId,t.`name` as empName,t.`identity_code` as code,ifnull(t.`mobile`,'--') as mobile,a.`name` as areaName
				,CASE b.insurance_fund_type WHEN 'INSURANCE' THEN '社保' WHEN 'FUND' THEN '公积金' ELSE '--' END as insFundType
				,b.bstype_id as bstypeId,ifnull(b.`name`,'--') as bstypeName
				<if test="type == 0">
				,t.`create_dt` as createDt 
				</if>
				<if test="type == 1 or type == 2 ">
				,t.`modify_dt` as createDt 
				</if> 
				,ifnull(t.modify_dt,t.create_dt) taskTime
				<if test="outTaskCenterTime != null">,#{outTaskCenterTime} as outTaskCenterTime</if>
				, '服务商任务' AS taskType,s.sp_name as spName ,t.`state_filed_id` as filedId,t.`state_filed_name` as filedName
				,CASE WHEN (t.state_filed_id=7001 or t.state_filed_id=7144) THEN '待处理'
				WHEN t.type='TODO' AND t.state_filed_id=7143 THEN '处理中'
				WHEN t.type='COMPLETED' THEN '已完成'
				WHEN t.type='CLOSED' THEN '已关闭'
				WHEN t.type='ERROR' THEN '失败'
				ELSE '待处理' END as status
				,t.area_id as areaId,t.type
				,t.dr
			FROM sps_task t
			inner join `sp_service` s on t.sp_id=s.sp_id
			left join cm_employee e on t.emp_id = e.emp_id
			inner join bs_area a on t.area_id = a.area_id 
			left join bd_bstype b on t.bstype_id = b.bstype_id
			where t.cp_id = #{cpId}
			<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
			<if test="type == 0">
			 	and t.type in('TODO','ERROR')
	            and t.`state_filed_id` in (7001,7144,7000)
	        </if>
			<if test="type == 1">
				and t.type in('TODO','SUBMIT')
				and t.`state_filed_id` in (7143)
			</if>
			<if test="type == 2">
				and t.type in('COMPLETED','CLOSED')
			</if>
			<if test="authority != 'ALL' and type == 0">
				AND (t.scheme_id in (${authority}) or t.scheme_id is null)
			</if>
			<if test="authority != 'ALL' and type != 0">
				AND t.scheme_id in (${authority})
			</if>
			<!-- taskType 任务类型 ALL：全部，SELFSERVICE：网申任务，SERVICE：服务商任务，ENTRY：入职任务 -->
			<if test="taskType == 'SELFSERVICE'">
				and t.company_type='SELFSERVICE'
				and t.bstype_id != -99
			</if>
			<if test="taskType == 'SERVICE'">
				and t.company_type='SERVICE'
				and t.bstype_id != -99
			</if>
			<if test="taskType == 'ENTRY'">
				and t.bstype_id=-99
			</if>
			<if test="insuranceFundType != null and insuranceFundType != ''">
				and b.insurance_fund_type=#{insuranceFundType}
			</if>
			<if test="bstype != null and bstype != ''">
				and t.bstype_id=#{bstype}
			</if>
		)t
		where 1=1 and t.dr=0
        <if test="cityId != null and cityId != ''">and t.areaId = ${cityId}</if>
        <if test="name != null and name != ''">and CONCAT(ifnull(t.empName,''),ifnull(t.code,'')) LIKE CONCAT('%',#{name},'%')</if>
        <if test="queryMonth != null and queryMonth != ''">and t.createDt LIKE CONCAT('%',#{queryMonth},'%')</if>
        <if test="taskStatus != null and taskStatus != ''">and t.filedId in (${taskStatus})</if>
        <if test="outTaskCenterTime != null">and t.taskTime&gt;=#{outTaskCenterTime}</if>
        order by t.createDt desc
    </select>
    <!-- 获取任务中心数据列表 -->
    <select id="findTaskCenterList" resultType="java.util.Map" parameterType="Object">
    	select t.* 
    	from(
			SELECT 
				t.`task_id` as taskId,t.`emp_id` as empId,t.`name` as empName,t.`identity_code` as code,ifnull(t.`mobile`,'--') as mobile,a.`name` as areaName
				,CASE b.insurance_fund_type WHEN 'INSURANCE' THEN '社保' WHEN 'FUND' THEN '公积金' ELSE '--' END as insFundType
				,b.bstype_id as bstypeId,ifnull(b.`name`,'--') as bstypeName
				<if test="type == 0">
				,t.`create_dt` as createDt 
				</if>
				<if test="type == 1 or type == 2 ">
				,t.`modify_dt` as createDt 
				</if>
				,ifnull(t.modify_dt,t.create_dt) taskTime
				<if test="outTaskCenterTime != null">,#{outTaskCenterTime} as outTaskCenterTime</if>
				,CASE WHEN t.bstype_id = -99 THEN '入职任务' ELSE '网申任务' END AS taskType
				,'' as spName ,t.`state_filed_id` as filedId,t.`state_filed_name` as filedName
				,CASE WHEN (t.state_filed_id=7001 or t.state_filed_id=7144) THEN '待处理'
				WHEN t.type='TODO' AND t.state_filed_id=7143 THEN '处理中'
				WHEN t.type='COMPLETED' THEN '已完成'
				WHEN t.type='CLOSED' THEN '已关闭'
				WHEN t.type='ERROR' THEN '失败'
				ELSE '待处理' END as status
				,t.area_id as areaId,t.type
				,t.dr
			FROM sps_task t 
			left join cm_employee e on t.emp_id = e.emp_id
			inner join bs_area a on t.area_id = a.area_id 
			left join bd_bstype b on t.bstype_id = b.bstype_id
			where t.cp_id = #{cpId}
			<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
			<if test="type == 0">
			 	and t.type in('TODO','ERROR')
	            and t.`state_filed_id` in (7001,7144,7000)
	        </if>
			<if test="type == 1">
				and t.type in('TODO','SUBMIT')
				and t.`state_filed_id` in (7143)
			</if>
			<if test="type == 2">
				and t.type in('COMPLETED','CLOSED')
			</if>
			<if test="authority != 'ALL' and type == 0">
				AND (t.scheme_id in (${authority}) or t.scheme_id is null)
			</if>
			<if test="authority != 'ALL' and type != 0">
				AND t.scheme_id in (${authority})
			</if>
			<!-- taskType 任务类型 ALL：全部，SELFSERVICE：网申任务，SERVICE：服务商任务，ENTRY：入职任务 -->
			<if test="taskType == 'SELFSERVICE'">
				and t.company_type='SELFSERVICE'
				and t.bstype_id != -99
			</if>
			<if test="taskType == 'SERVICE'">
				and t.company_type='SERVICE'
				and t.bstype_id != -99
			</if>
			<if test="taskType == 'ENTRY'">
				and t.bstype_id=-99
			</if>
			<if test="insuranceFundType != null and insuranceFundType != ''">
				and b.insurance_fund_type=#{insuranceFundType}
			</if>
			<if test="bstype != null and bstype != ''">
				and t.bstype_id=#{bstype}
			</if>
			union all
			SELECT 
				t.`task_id` as taskId,t.`emp_id` as empId,t.`name` as empName,t.`identity_code` as code,ifnull(t.`mobile`,'--') as mobile,a.`name` as areaName
				,CASE b.insurance_fund_type WHEN 'INSURANCE' THEN '社保' WHEN 'FUND' THEN '公积金' ELSE '--' END as insFundType
				,b.bstype_id as bstypeId,ifnull(b.`name`,'--') as bstypeName
				<if test="type == 0">
				,t.`create_dt` as createDt 
				</if>
				<if test="type == 1 or type == 2 ">
				,t.`modify_dt` as createDt 
				</if>
				,ifnull(t.modify_dt,t.create_dt) taskTime
				<if test="outTaskCenterTime != null">,#{outTaskCenterTime} as outTaskCenterTime</if>
				, '服务商任务' AS taskType,s.sp_name as spName ,t.`state_filed_id` as filedId,t.`state_filed_name` as filedName
				,CASE WHEN (t.state_filed_id=7001 or t.state_filed_id=7144) THEN '待处理'
				WHEN t.type='TODO' AND t.state_filed_id=7143 THEN '处理中'
				WHEN t.type='COMPLETED' THEN '已完成'
				WHEN t.type='CLOSED' THEN '已关闭'
				WHEN t.type='ERROR' THEN '失败'
				ELSE '待处理' END as status
				,t.area_id as areaId,t.type
				,t.dr
			FROM sps_task t
			inner join `sp_service` s on t.sp_id=s.sp_id
			left join cm_employee e on t.emp_id = e.emp_id
			inner join bs_area a on t.area_id = a.area_id 
			left join bd_bstype b on t.bstype_id = b.bstype_id
			where t.cp_id = #{cpId}
			<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
			<if test="type == 0">
			 	and t.type in('TODO','ERROR')
	            and t.`state_filed_id` in (7001,7144,7000)
	        </if>
			<if test="type == 1">
				and t.type in('TODO','SUBMIT')
				and t.`state_filed_id` in (7143)
			</if>
			<if test="type == 2">
				and t.type in('COMPLETED','CLOSED')
			</if>
			<if test="authority != 'ALL' and type == 0">
				AND (t.scheme_id in (${authority}) or t.scheme_id is null)
			</if>
			<if test="authority != 'ALL' and type != 0">
				AND t.scheme_id in (${authority})
			</if>
			<!-- taskType 任务类型 ALL：全部，SELFSERVICE：网申任务，SERVICE：服务商任务，ENTRY：入职任务 -->
			<if test="taskType == 'SELFSERVICE'">
				and t.company_type='SELFSERVICE'
				and t.bstype_id != -99
			</if>
			<if test="taskType == 'SERVICE'">
				and t.company_type='SERVICE'
				and t.bstype_id != -99
			</if>
			<if test="taskType == 'ENTRY'">
				and t.bstype_id=-99
			</if>
			<if test="insuranceFundType != null and insuranceFundType != ''">
				and b.insurance_fund_type=#{insuranceFundType}
			</if>
			<if test="bstype != null and bstype != ''">
				and t.bstype_id=#{bstype}
			</if>
		) t
		where 1=1 and t.dr=0
        <if test="cityId != null and cityId != ''">and t.areaId = #{cityId}</if>
        <if test="name != null and name != ''">and CONCAT(ifnull(t.empName,''),ifnull(t.code,'')) LIKE CONCAT('%',#{name},'%')</if>
        <if test="queryMonth != null and queryMonth != ''">and t.createDt LIKE CONCAT('%',#{queryMonth},'%')</if>
        <if test="taskStatus != null and taskStatus != ''">and t.filedId in (${taskStatus})</if>
        order by t.taskTime desc
    </select>

	<select id="findQueryConditionAreaData" resultType="java.util.Map" parameterType="Object">
		select count(t.`area_id`) as number,t.area_id AS id,a.`name` as name
		FROM sps_task t 
		inner join bs_area a on t.area_id = a.area_id 
		where t.cp_id = #{cpId}
		<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
		<if test="type == 0">
		 	and t.type in('TODO','ERROR')
            and t.`state_filed_id` in (7001,7144,7000)
        </if>
		<if test="type == 1">
			and t.type in('TODO','SUBMIT')
			and t.`state_filed_id` in (7143)
		</if>
		<if test="type == 2">
			and t.type='COMPLETED'
			and t.`state_filed_id` in (7009)
		</if>
		<if test="authority != 'ALL'">
			AND (t.scheme_id in (${authority}) or t.scheme_id is null)
		</if>
		GROUP BY t.area_id
		order by t.area_id
	</select>
	<select id="findQueryConditionInsFundTypeData" resultType="java.util.Map" parameterType="Object">
		select count(t.`bstype_id`) as number,b.`bstype_id` as id,b.`name` as name
		FROM sps_task t 
		inner join bd_bstype b on t.bstype_id = b.bstype_id
		where t.cp_id = #{cpId}
		<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
		<if test="type == 0">
		 	and t.type in('TODO','ERROR')
            and t.`state_filed_id` in (7001,7144,7000)
        </if>
		<if test="type == 1">
			and t.type in('TODO','SUBMIT')
			and t.`state_filed_id` in (7143)
		</if>
		<if test="type == 2">
			and t.type in('COMPLETED','CLOSED')
		</if>
		<if test="authority != 'ALL'">
			AND (t.scheme_id in (${authority}) or t.scheme_id is null)
		</if>
		 AND t.dr=0
		GROUP BY t.`bstype_id`
		order by t.`bstype_id`
	</select>
	<select id="findQueryConditionTaskTypeData" resultType="java.util.Map" parameterType="Object">
		select count(t.`task_id`) as number,'社保' as name,'INSURANCE' as id
		FROM sps_task t 
		where t.cp_id = #{cpId}
		<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
		<if test="type == 0">
		 	and t.type in('TODO','ERROR')
            and t.`state_filed_id` in (7001,7144,7000)
        </if>
		<if test="type == 1">
			and t.type in('TODO','SUBMIT')
			and t.`state_filed_id` in (7143)
		</if>
		<if test="type == 2">
			and t.type='COMPLETED'
			and t.`state_filed_id` in (7009)
		</if>
		<if test="authority != 'ALL'">
			AND (t.scheme_id in (${authority}) or t.scheme_id is null)
		</if>
		and t.`bstype_id` in (
			select b.`bstype_id` from bd_bstype b where b.`insurance_fund_type`='INSURANCE'
		)
		UNION all
		select count(t.`task_id`) as number,'公积金' as name,'FUND' as id
		FROM sps_task t 
		where t.cp_id = #{cpId}
		<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
		<if test="type == 0">
		 	and t.type in('TODO','ERROR')
            and t.`state_filed_id` in (7001,7144,7000)
        </if>
		<if test="type == 1">
			and t.type in('TODO','SUBMIT')
			and t.`state_filed_id` in (7143)
		</if>
		<if test="type == 2">
			and t.type='COMPLETED'
			and t.`state_filed_id` in (7009)
		</if>
		<if test="authority != 'ALL'">
			AND (t.scheme_id in (${authority}) or t.scheme_id is null)
		</if>
		and t.`bstype_id` in (
			select b.`bstype_id` from bd_bstype b where b.`insurance_fund_type`='FUND'
		)
	</select>
	<select id="findQueryConditionTaskStatusData" resultType="java.util.Map" parameterType="Object">
		select count(t.status) as number,t.status as name, GROUP_CONCAT(DISTINCT t.state_filed_id) as id
		from(
			select 
				t.state_filed_id,
				CASE WHEN t.state_filed_id=7001 THEN '待处理' 
				WHEN t.state_filed_id=7144 THEN '待处理'
				WHEN t.state_filed_id=7143 and t.type='TODO' THEN '处理中'
				WHEN t.state_filed_id=7143 and t.type='SUBMIT' THEN '处理中'
				WHEN t.state_filed_id=7009 THEN '已完成'
				WHEN t.type='CLOSED' THEN '已关闭'
				ELSE '失败' END as status
			FROM sps_task t
			where t.cp_id = #{cpId}
			<!-- type 办理状态 0：待处理，1：处理中，2：已完成 --> 
			<if test="type == 0">
			 	and t.type in('TODO','ERROR')
	            and t.`state_filed_id` in (7001,7144,7000)
	        </if>
			<if test="type == 1">
				and t.type in('TODO','SUBMIT')
				and t.`state_filed_id` in (7143)
			</if>
			<if test="type == 2">
				 and t.type in('COMPLETED','CLOSED')
			</if>
			<if test="authority != 'ALL'">
				AND (t.scheme_id in (${authority}) or t.scheme_id is null)
			</if>
			 AND t.dr=0
		) t
		GROUP BY t.status
		order by t.status
	</select>

</mapper>
