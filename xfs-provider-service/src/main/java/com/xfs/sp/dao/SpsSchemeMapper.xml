<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SPS_SCHEME">
    <!-- Result Map-->
    <resultMap id="result_map_SPS_SCHEME" type="com.xfs.sp.model.SpsScheme">
        <result column="scheme_id" property="schemeId"/>
        <result column="sp_id" property="spId"/>
        <result column="cp_id" property="cpId"/>
        <result column="name" property="name"/>
        <result column="area_id" property="areaId"/>
        <result column="scheme_type" property="schemeType"/>
        <result column="parent_sp_id" property="parentSpId"/>
        <result column="parent_id" property="parentId"/>
        <result column="state" property="state"/>
        <result column="price" property="price"/>
        <result column="insurance_type" property="insuranceType"/>
        <result column="insurance_account_id" property="insuranceAccountId"/>
        <result column="fund_type" property="fundType"/>
        <result column="fund_account_id" property="fundAccountId"/>
        <result column="bill_type" property="billType"/>
        <result column="end_date" property="endDate"/>
        <result column="bill_date_type" property="billDateType"/>
        <result column="bill_date" property="billDate"/>
        <result column="pay_date_type" property="payDateType"/>
        <result column="pay_date" property="payDate"/>
        <result column="afterpay_rule" property="afterpayRule"/>
        <result column="memo" property="memo"/>
        <result column="ispackage" property="ispackage"/>
        <result column="isdefault" property="isdefault"/>
        <result column="create_by" property="createBy"/>
        <result column="create_dt" property="createDt"/>
        <result column="modify_by" property="modifyBy"/>
        <result column="modify_dt" property="modifyDt"/>
        <result column="insurance_fund_type" property="insurance_fund_type"/>
        <result column="areaname" property="areaname"/>
        <result column="dr" property="dr"/>
    </resultMap>

    <!-- sps_scheme table all fields -->
    <sql id="Base_Column_List">
	 scheme_id,sp_id,cp_id,name,area_id,scheme_type,parent_sp_id,parent_id,state,price,insurance_type,insurance_account_id,fund_type,fund_account_id,bill_type,end_date,bill_date_type,bill_date,pay_date_type,pay_date,afterpay_rule,memo,ispackage,isdefault,create_by,create_dt,modify_by,modify_dt,dr
</sql>

    <!-- 查询条件 -->
    <sql id="Example_Where_Clause">
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="schemeId != null">and scheme_id = #{schemeId}</if>
            <if test="spId != null">and sp_id = #{spId}</if>
            <if test="cpId != null">and cp_id = #{cpId}</if>
            <if test="name != null">and name = #{name}</if>
            <if test="areaId != null">and area_id = #{areaId}</if>
            <if test="schemeType != null">and scheme_type = #{schemeType}</if>
            <if test="parentSpId != null">and parent_sp_id = #{parentSpId}</if>
            <if test="parentId != null">and parent_id = #{parentId}</if>
            <if test="state != null">and state = #{state}</if>
            <if test="price != null">and price = #{price}</if>
            <if test="insuranceType != null">and insurance_type = #{insuranceType}</if>
            <if test="insuranceAccountId != null">and insurance_account_id = #{insuranceAccountId}</if>
            <if test="fundType != null">and fund_type = #{fundType}</if>
            <if test="fundAccountId != null">and fund_account_id = #{fundAccountId}</if>
            <if test="billType != null">and bill_type = #{billType}</if>
            <if test="endDate != null">and end_date = #{endDate}</if>
            <if test="billDateType != null">and bill_date_type = #{billDateType}</if>
            <if test="billDate != null">and bill_date = #{billDate}</if>
            <if test="payDateType != null">and pay_date_type = #{payDateType}</if>
            <if test="payDate != null">and pay_date = #{payDate}</if>
            <if test="afterpayRule != null">and afterpay_rule = #{afterpayRule}</if>
            <if test="memo != null">and memo = #{memo}</if>
            <if test="ispackage != null">and ispackage = #{ispackage}</if>
            <if test="isdefault != null">and isdefault = #{isdefault}</if>
            <if test="createBy != null">and create_by = #{createBy}</if>
            <if test="createDt != null">and create_dt = #{createDt}</if>
            <if test="modifyBy != null">and modify_by = #{modifyBy}</if>
            <if test="modifyDt != null">and modify_dt = #{modifyDt}</if>
            <if test="dr != null">and dr = #{dr}</if>
        </trim>
    </sql>

    <!-- 查询条件 带模糊查询 以及 时间起始查询 -->
    <sql id="Example_Where_Clause2">
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="schemeId != null">AND scheme_id = #{schemeId}</if>
            <if test="spId != null">AND sp_id = #{spId}</if>
            <if test="cpId != null">AND cp_id = #{cpId}</if>
            <if test="name != null">AND name like '%${name}%'</if>
            <if test="nameEq != null">AND name = #{nameEq}</if>
            <if test="areaId != null">AND area_id = #{areaId}</if>
            <if test="schemeType != null">AND scheme_type like '%${schemeType}%'</if>
            <if test="schemeTypeEq != null">AND scheme_type = #{schemeTypeEq}</if>
            <if test="parentSpId != null">AND parent_sp_id = #{parentSpId}</if>
            <if test="parentId != null">AND parent_id = #{parentId}</if>
            <if test="state != null">AND state like '%${state}%'</if>
            <if test="stateEq != null">AND state = #{stateEq}</if>
            <if test="price != null">AND price like '%${price}%'</if>
            <if test="insuranceType != null">AND insurance_type like '%${insuranceType}%'</if>
            <if test="insuranceTypeEq != null">AND insurance_type = #{insuranceTypeEq}</if>
            <if test="insuranceAccountId != null">AND insurance_account_id = #{insuranceAccountId}</if>
            <if test="fundType != null">AND fund_type like '%${fundType}%'</if>
            <if test="fundTypeEq != null">AND fund_type = #{fundTypeEq}</if>
            <if test="fundAccountId != null">AND fund_account_id = #{fundAccountId}</if>
            <if test="billType != null">AND bill_type like '%${billType}%'</if>
            <if test="billTypeEq != null">AND bill_type = #{billTypeEq}</if>
            <if test="endDate != null">AND end_date = #{endDate}</if>
            <if test="billDateType != null">AND bill_date_type like '%${billDateType}%'</if>
            <if test="billDateTypeEq != null">AND bill_date_type = #{billDateTypeEq}</if>
            <if test="billDate != null">AND bill_date = #{billDate}</if>
            <if test="payDateType != null">AND pay_date_type like '%${payDateType}%'</if>
            <if test="payDateTypeEq != null">AND pay_date_type = #{payDateTypeEq}</if>
            <if test="payDate != null">AND pay_date = #{payDate}</if>
            <if test="afterpayRule != null">AND afterpay_rule = #{afterpayRule}</if>
            <if test="memo != null">AND memo like '%${memo}%'</if>
            <if test="memoEq != null">AND memo = #{memoEq}</if>
            <if test="ispackage != null">AND ispackage like '%${ispackage}%'</if>
            <if test="ispackageEq != null">AND ispackage = #{ispackageEq}</if>
            <if test="isdefault != null">AND isdefault like '%${isdefault}%'</if>
            <if test="isdefaultEq != null">AND isdefault = #{isdefaultEq}</if>
            <if test="createBy != null">AND create_by = #{createBy}</if>
            <if test="createDt != null">AND create_dt = #{createDt}</if>
            <if test="createDtFrom != null">AND create_dt&gt;=#{createDtFrom}</if>
            <if test="createDtTo != null">AND create_dt&lt;=#{createDtTo}</if>
            <if test="modifyBy != null">AND modify_by = #{modifyBy}</if>
            <if test="modifyDt != null">AND modify_dt = #{modifyDt}</if>
            <if test="modifyDtFrom != null">AND modify_dt&gt;=#{modifyDtFrom}</if>
            <if test="modifyDtTo != null">AND modify_dt&lt;=#{modifyDtTo}</if>
            <if test="dr != null">AND dr = #{dr}</if>
        </trim>
    </sql>

    <!-- 插入记录 -->
    <insert id="InsertSPS_SCHEME" parameterType="Object">
        INSERT INTO SPS_SCHEME (
        <trim prefix=" " prefixOverrides=",">
            <if test="schemeId != null ">,scheme_id</if>
            <if test="spId != null ">,sp_id</if>
            <if test="cpId != null ">,cp_id</if>
            <if test="name != null ">,name</if>
            <if test="areaId != null ">,area_id</if>
            <if test="schemeType != null ">,scheme_type</if>
            <if test="parentSpId != null ">,parent_sp_id</if>
            <if test="parentId != null ">,parent_id</if>
            <if test="state != null ">,state</if>
            <if test="price != null ">,price</if>
            <if test="insuranceType != null ">,insurance_type</if>
            <if test="insuranceAccountId != null ">,insurance_account_id</if>
            <if test="fundType != null ">,fund_type</if>
            <if test="fundAccountId != null ">,fund_account_id</if>
            <if test="billType != null ">,bill_type</if>
            <if test="endDate != null ">,end_date</if>
            <if test="billDateType != null ">,bill_date_type</if>
            <if test="billDate != null ">,bill_date</if>
            <if test="payDateType != null ">,pay_date_type</if>
            <if test="payDate != null ">,pay_date</if>
            <if test="afterpayRule != null ">,afterpay_rule</if>
            <if test="memo != null ">,memo</if>
            <if test="ispackage != null ">,ispackage</if>
            <if test="isdefault != null ">,isdefault</if>
            <if test="createBy != null ">,create_by</if>
            <if test="createDt != null ">,create_dt</if>
            <if test="modifyBy != null ">,modify_by</if>
            <if test="modifyDt != null ">,modify_dt</if>
            <if test="dr != null ">,dr</if>
        </trim>
        ) VALUES (
        <trim prefix=" " prefixOverrides=",">
            <if test="schemeId != null ">,#{schemeId}</if>
            <if test="spId != null ">,#{spId}</if>
            <if test="cpId != null ">,#{cpId}</if>
            <if test="name != null ">,#{name}</if>
            <if test="areaId != null ">,#{areaId}</if>
            <if test="schemeType != null ">,#{schemeType}</if>
            <if test="parentSpId != null ">,#{parentSpId}</if>
            <if test="parentId != null ">,#{parentId}</if>
            <if test="state != null ">,#{state}</if>
            <if test="price != null ">,#{price}</if>
            <if test="insuranceType != null ">,#{insuranceType}</if>
            <if test="insuranceAccountId != null ">,#{insuranceAccountId}</if>
            <if test="fundType != null ">,#{fundType}</if>
            <if test="fundAccountId != null ">,#{fundAccountId}</if>
            <if test="billType != null ">,#{billType}</if>
            <if test="endDate != null ">,#{endDate}</if>
            <if test="billDateType != null ">,#{billDateType}</if>
            <if test="billDate != null ">,#{billDate}</if>
            <if test="payDateType != null ">,#{payDateType}</if>
            <if test="payDate != null ">,#{payDate}</if>
            <if test="afterpayRule != null ">,#{afterpayRule}</if>
            <if test="memo != null ">,#{memo}</if>
            <if test="ispackage != null ">,#{ispackage}</if>
            <if test="isdefault != null ">,#{isdefault}</if>
            <if test="createBy != null ">,#{createBy}</if>
            <if test="createDt != null ">,#{createDt}</if>
            <if test="modifyBy != null ">,#{modifyBy}</if>
            <if test="modifyDt != null ">,#{modifyDt}</if>
            <if test="dr != null ">,#{dr}</if>
        </trim>
        )
        <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="schemeId">
            SELECT LAST_INSERT_ID() AS SCHEME_ID
        </selectKey>
    </insert>

    <!-- 根据id，修改记录-->
    <update id="UpdateSPS_SCHEME" parameterType="Object">
        UPDATE SPS_SCHEME
        <trim prefix=" SET " prefixOverrides=",">
            <if test="schemeId != null ">,scheme_id=#{schemeId}</if>
            <if test="spId != null ">,sp_id=#{spId}</if>
            <if test="cpId != null ">,cp_id=#{cpId}</if>
            <if test="name != null ">,name=#{name}</if>
            <if test="areaId != null ">,area_id=#{areaId}</if>
            <if test="schemeType != null ">,scheme_type=#{schemeType}</if>
            <if test="parentSpId != null ">,parent_sp_id=#{parentSpId}</if>
            <if test="parentId != null ">,parent_id=#{parentId}</if>
            <if test="state != null ">,state=#{state}</if>
            ,price=#{price}
            <if test="insuranceType != null ">,insurance_type=#{insuranceType}</if>
            ,insurance_account_id=#{insuranceAccountId}
            <if test="fundType != null ">,fund_type=#{fundType}</if>
            ,fund_account_id=#{fundAccountId}
            <if test="billType != null ">,bill_type=#{billType}</if>
            <if test="endDate != null ">,end_date=#{endDate}</if>
            <if test="billDateType != null ">,bill_date_type=#{billDateType}</if>
            <if test="billDate != null ">,bill_date=#{billDate}</if>
            <if test="payDateType != null ">,pay_date_type=#{payDateType}</if>
            <if test="payDate != null ">,pay_date=#{payDate}</if>
            <if test="afterpayRule != null ">,afterpay_rule=#{afterpayRule}</if>
            <if test="memo != null ">,memo=#{memo}</if>
            <if test="ispackage != null ">,ispackage=#{ispackage}</if>
            <if test="isdefault != null ">,isdefault=#{isdefault}</if>
            <if test="createBy != null ">,create_by=#{createBy}</if>
            <if test="createDt != null ">,create_dt=#{createDt}</if>
            <if test="modifyBy != null ">,modify_by=#{modifyBy}</if>
            <if test="modifyDt != null ">,modify_dt=#{modifyDt}</if>
            <if test="dr != null ">,dr=#{dr}</if>
        </trim>
        WHERE SCHEME_ID=#{schemeId}
    </update>

    <!-- 删除记录 -->
    <delete id="DeleteSPS_SCHEME">DELETE FROM SPS_SCHEME WHERE SCHEME_ID=#{schemeId}</delete>
    <!-- 方案表 列表总数-->
    <select id="CountFindAllSPS_SCHEME" resultType="java.lang.Integer">SELECT count(1) as value FROM SPS_SCHEME</select>
    <select id="CountSPS_SCHEME"
            resultType="java.lang.Integer">SELECT count(1) as value FROM SPS_SCHEME WHERE SCHEME_ID=#{schemeId}</select>
    <!-- 根据id查询 方案表 -->
    <select id="FindByPK" resultMap="result_map_SPS_SCHEME" parameterType="Object">SELECT
        <include refid="Base_Column_List"/>
        FROM SPS_SCHEME WHERE SCHEME_ID=#{schemeId}
    </select>

    <!-- 根据各字段条件带模糊查询  方案表 -->
    <select id="FreeFindSPS_SCHEME" resultMap="result_map_SPS_SCHEME" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM SPS_SCHEME
        <include refid="Example_Where_Clause2"/>
    </select>
    <!-- 根据各字段条件带模糊查询  方案表 记录数 -->
    <select id="CountFreeFindSPS_SCHEME" resultType="java.lang.Integer">
        SELECT count(1) as value FROM SPS_SCHEME
        <include refid="Example_Where_Clause2"/>
    </select>
    <!-- 根据各字段条件带排序  方案表 -->
    <select id="FreeFindSPS_SCHEMEOrdered" resultMap="result_map_SPS_SCHEME" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM SPS_SCHEME
        <include refid="Example_Where_Clause2"/>
        ORDER BY ${_orderBy}
    </select>

    <!-- *****************************  温馨提示：  ***************************** -->
    <!-- **                                                                    ** -->
    <!-- ** 以上为自动生成代码，请勿改动或删除。如有新sql添加请在下方区域内填写** -->
    <!-- **                                             ** 2016/08/12 15:46:36 ** -->
    <!-- ************************************************************************ -->


    <resultMap id="mapType" type="java.util.Map">
    </resultMap>
    <!-- 查询方案信息,areaid 不存在，用left join -->
    <select id="findSchemes" resultMap="mapType" parameterType="Object">
        SELECT t.scheme_id,t.sp_id,t.cp_id,t.state,t.`name`,t.area_id,a.fullname,t.scheme_type,t.isdefault,a.belong_city,t.ispackage from sps_scheme t 
		inner join cm_corp c on c.cp_id = t.cp_id and c.dr=0
		left join bs_area a on t.area_id=a.area_id
        where t.sp_id=${sp_id} and t.cp_id = ${cp_id} and t.dr=0
    </select>

    <select id="findSchemes_State" resultMap="mapType" parameterType="Object">
        SELECT t.scheme_id,t.sp_id,t.cp_id,t.state,t.`name`,t.area_id,a.fullname,t.scheme_type,t.isdefault,a.belong_city,t.ispackage from sps_scheme t
        inner join cm_corp c on c.cp_id = t.cp_id and c.dr=0
		left join bs_area a on t.area_id=a.area_id
        where t.sp_id=${sp_id} and t.cp_id = ${cp_id} and t.dr=0  and  t.state = 'USE'
    </select>


    <resultMap id="result_map_SPS_SCHEME_with_Insurance" type="com.xfs.sp.model.SpsScheme">
        <result column="scheme_id" property="schemeId"/>
        <result column="sp_id" property="spId"/>
        <result column="cp_id" property="cpId"/>
        <result column="name" property="name"/>
        <result column="area_id" property="areaId"/>
        <result column="scheme_type" property="schemeType"/>
        <result column="parent_sp_id" property="parentSpId"/>
        <result column="parent_id" property="parentId"/>
        <result column="state" property="state"/>
        <result column="price" property="price"/>
        <result column="insurance_type" property="insuranceType"/>
        <result column="insurance_account_id" property="insuranceAccountId"/>
        <result column="fund_type" property="fundType"/>
        <result column="fund_account_id" property="fundAccountId"/>
        <result column="bill_type" property="billType"/>
        <result column="end_date" property="endDate"/>
        <result column="bill_date_type" property="billDateType"/>
        <result column="bill_date" property="billDate"/>
        <result column="pay_date_type" property="payDateType"/>
        <result column="pay_date" property="payDate"/>
        <result column="afterpay_rule" property="afterpayRule"/>
        <result column="memo" property="memo"/>
        <result column="isdefault" property="isdefault"/>
        <result column="create_by" property="createBy"/>
        <result column="create_dt" property="createDt"/>
        <result column="modify_by" property="modifyBy"/>
        <result column="modify_dt" property="modifyDt"/>
        <result column="dr" property="dr"/>
        <result column="dr" property="dr"/>

        <collection property="schemeInsurances" javaType="List" ofType="com.xfs.sp.model.SpsSchemeInsurance"
                    column="insurance_id">
            <result column="insurance_id" property="id"/>
            <result column="insurance_scheme_id" property="schemeId"/>
            <result column="insurance_insurance_id" property="insuranceId"/>
            <result column="insurance_emp_ratio" property="empRatio"/>
            <result column="insurance_corp_ratio" property="corpRatio"/>
            <result column="insurance_create_by" property="createBy"/>
            <result column="insurance_create_dt" property="createDt"/>
            <result column="insurance_modify_by" property="modifyBy"/>
            <result column="insurance_modify_dt" property="modifyDt"/>
            <result column="insurance_dr" property="dr"/>
        </collection>
    </resultMap>

    <select id="findSchemesByIds" resultMap="result_map_SPS_SCHEME_with_Insurance" parameterType="Object">
        SELECT
        scheme.scheme_id,scheme.sp_id,scheme.cp_id,scheme.name,scheme.area_id,scheme.scheme_type,scheme.parent_sp_id,scheme.parent_id,scheme.state,
        scheme.price,scheme.insurance_type,scheme.insurance_account_id,scheme.fund_type,scheme.fund_account_id,scheme.bill_type,scheme.end_date,scheme.bill_date_type,
        scheme.bill_date,scheme.pay_date_type,scheme.pay_date,scheme.afterpay_rule,scheme.memo,scheme.isdefault,scheme.create_by,scheme.create_dt,scheme.modify_by,
        scheme.modify_dt,scheme.dr,
        insurance.id insurance_id,insurance.scheme_id insurance_scheme_id,insurance.emp_ratio
        insurance_emp_ratio,insurance.corp_ratio insurance_corp_ratio,insurance.insurance_id insurance_insurance_id,
        insurance.create_by insurance_create_by,insurance.create_dt insurance_create_dt,insurance.modify_by
        insurance_modify_by,insurance.modify_dt insurance_modify_dt,insurance.dr insurance_dr
        from sps_scheme scheme
        left join sps_scheme_insurance insurance on scheme.scheme_id = insurance.scheme_id
        where scheme.sp_id=${sp_id} and scheme.scheme_id in
        <foreach item="id" index="index" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>


    <!-- 根据账单日获取企业列表 -->
    <select id="QUERY_ALL_CROPS_BY_BILL_DAY" resultMap="result_map_SPS_SCHEME" parameterType="Object">
		SELECT t.sp_id,t.cp_id,c_bill.bill_state as scheme_type,t.bill_date FROM (
		SELECT re.* FROM SPS_SCHEME re WHERE re.bill_date = date_format(NOW(),'%e') AND re.sp_id > 0 GROUP BY re.sp_id,re.cp_id ) t
		LEFT JOIN sps_bill c_bill ON c_bill.sp_id = t.sp_id AND c_bill.cp_id = t.cp_id AND c_bill.period = DATE_FORMAT(NOW(),'%Y-%m') AND c_bill.dr = 0 AND c_bill.bill_type = 'PREPAY'
		WHERE NOT EXISTS (
			SELECT bill.bill_id FROM sps_bill bill WHERE bill.sp_id = t.sp_id AND bill.cp_id = t.cp_id AND bill.period = DATE_FORMAT(NOW(),'%Y-%m') AND bill.dr = 0 AND bill.bill_type = 'PREPAY'
            <if test="billState != null">
                 AND bill.bill_state = 'SEND'
            </if>
		)
    </select>

    <select id="findAllSchemeArea" resultType="java.util.Map" parameterType="Object">
		select aa.area_id as city_id ,aa.code as city_code, aa.name as city_name from ( select distinct(a.belong_city) as belong_city from
		( select distinct(area_id) as area_id from SPS_SCHEME where sp_id = #{sp_id} and state = 'USE') s
		left join bs_area a on s.area_id = a.area_id where a.belong_city is not null) be left join bs_area aa on be.belong_city = aa.area_id
		where aa.area_id is not null
	</select>

    <!-- modify by wuzhe merger 20161031 source from cs-->
    <!-- 根据各字段条件带模糊查询  方案 -->
    <select id="FreeFindSPS_SCHEME_IN_TYPE" resultMap="result_map_SPS_SCHEME" parameterType="Object">
        SELECT
        <include refid="Base_Column_List"/>
        FROM SPS_SCHEME
        <trim prefix=" WHERE " prefixOverrides="AND ">
            <if test="schemeId != null">AND scheme_id = '${schemeId}'</if>
            <if test="spId != null">AND sp_id = '${spId}'</if>
            <if test="cpId != null">AND cp_id = '${cpId}'</if>
            <if test="name != null">AND name like '%${name}%'</if>
            <if test="nameEq != null">AND name = #{nameEq}</if>
            <if test="areaId != null">AND area_id = '${areaId}'</if>
            <if test="schemeType != null">AND scheme_type like '${schemeType}%'</if>
            <if test="schemeTypeEq != null">AND scheme_type = #{schemeTypeEq}</if>
            <if test="schemeTypeIn != null">AND scheme_type in
                <foreach collection="schemeTypeIn" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="parentSpId != null">AND parent_sp_id like '%${parentSpId}%'</if>
            <if test="parentId != null">AND parent_id = '${parentId}'</if>
            <if test="state != null">AND state like '%${state}%'</if>
            <if test="stateEq != null">AND state = #{stateEq}</if>
            <if test="price != null">AND price like '%${price}%'</if>
            <if test="insuranceType != null">AND insurance_type like '%${insuranceType}%'</if>
            <if test="insuranceTypeEq != null">AND insurance_type = #{insuranceTypeEq}</if>
            <if test="insuranceAccountId != null">AND insurance_account_id like '%${insuranceAccountId}%'</if>
            <if test="fundType != null">AND fund_type like '%${fundType}%'</if>
            <if test="fundTypeEq != null">AND fund_type = #{fundTypeEq}</if>
            <if test="fundAccountId != null">AND fund_account_id like '%${fundAccountId}%'</if>
            <if test="billType != null">AND bill_type like '%${billType}%'</if>
            <if test="billTypeEq != null">AND bill_type = #{billTypeEq}</if>
            <if test="endDate != null">AND end_date like '%${endDate}%'</if>
            <if test="billDateType != null">AND bill_date_type like '%${billDateType}%'</if>
            <if test="billDateTypeEq != null">AND bill_date_type = #{billDateTypeEq}</if>
            <if test="billDate != null">AND bill_date like '%${billDate}%'</if>
            <if test="payDateType != null">AND pay_date_type like '%${payDateType}%'</if>
            <if test="payDateTypeEq != null">AND pay_date_type = #{payDateTypeEq}</if>
            <if test="payDate != null">AND pay_date like '%${payDate}%'</if>
            <if test="afterpayRule != null">AND afterpay_rule like '%${afterpayRule}%'</if>
            <if test="memo != null">AND memo like '%${memo}%'</if>
            <if test="memoEq != null">AND memo = #{memoEq}</if>
            <if test="isdefault != null">AND isdefault like '%${isdefault}%'</if>
            <if test="isdefaultEq != null">AND isdefault = #{isdefaultEq}</if>
            <if test="createBy != null">AND create_by like '%${createBy}%'</if>
            <if test="createDt != null">AND create_dt = #{createDt}</if>
            <if test="createDtFrom != null">AND create_dt&gt;=#{createDtFrom}</if>
            <if test="createDtTo != null">AND create_dt&lt;=#{createDtTo}</if>
            <if test="modifyBy != null">AND modify_by like '%${modifyBy}%'</if>
            <if test="modifyDt != null">AND modify_dt = #{modifyDt}</if>
            <if test="modifyDtFrom != null">AND modify_dt&gt;=#{modifyDtFrom}</if>
            <if test="modifyDtTo != null">AND modify_dt&lt;=#{modifyDtTo}</if>
            <if test="dr != null">AND dr like '%${dr}%'</if>
        </trim>
    </select>

    <select id="FreeFindSPS_SCHEME_BY_INSURANCE_FUND_TYPE" resultMap="result_map_SPS_SCHEME" parameterType="Object">
        select s.*, concat(IFNULL(a.insurance_fund_type,''),IFNULL(b.insurance_fund_type,'')) as insurance_fund_type
        from sps_scheme s LEFT JOIN sps_account a on s.fund_account_id = a.acc_id
        LEFT JOIN sps_account b on s.insurance_account_id = b.acc_id
        where 1 = 1
        <if test="spId != null">AND s.sp_id = #{spId}</if>
        <if test="cpId != null">AND s.cp_id = #{cpId}</if>
        <if test="state != null">AND s.state = #{state}</if>
    </select>


    <select id="findSchemeListByConditions" resultMap="result_map_SPS_SCHEME" parameterType="Object">
        select min(sch.scheme_id) scheme_id,area_id from sps_scheme sch
        <include refid="Example_Where_Clause2"/>
        GROUP BY area_id;
    </select>


    <select id="findSchemeListByCpId" resultType="java.lang.Integer" parameterType="java.lang.Integer">
		SELECT DISTINCT(area_id) area_id from  sps_scheme WHERE cp_id=#{0} AND  dr=0;
	</select>


    <update id="deleteSchemeBySpIdAndCpId" parameterType="Object">
        UPDATE   sps_scheme set dr = 1 WHERE cp_id = #{cpId}  AND  sp_id = #{spId}
    </update>

    <select id="findSchemeOrderById" resultMap="result_map_SPS_SCHEME" parameterType="Object">
        select min(scheme.scheme_id) schemeId,area_id areaId FROM SPS_SCHEME
        <include refid="Example_Where_Clause2"/>
        ORDER BY area_id
    </select>


    <select id="findSchemeByEmpId" resultMap="result_map_SPS_SCHEME" parameterType="Object">
		select scheme.* from sps_scheme scheme
			left join sps_scheme_emp emp on scheme.scheme_id = emp.scheme_id and emp.dr = 0
			where emp.emp_id = #{0} and emp.state = 'use'
	</select>

	<!-- 根据企业ID和城市获取最小方案 -->
	<select id="findMinSchemeByCityIdAndCpId" resultMap="result_map_SPS_SCHEME" parameterType="Object">
		SELECT 
		min(scheme_id) as scheme_id,sp_id,cp_id,name,area_id,scheme_type,parent_sp_id,parent_id,state,price,insurance_type,insurance_account_id,fund_type,fund_account_id,bill_type,end_date,bill_date_type,bill_date,pay_date_type,pay_date,afterpay_rule,memo,ispackage,isdefault,create_by,create_dt,modify_by,modify_dt,dr
		FROM SPS_SCHEME 
		WHERE cp_id=#{cpId} and area_id=#{areaId} and dr=0
		<if test="authority != 'ALL'"> 
			AND scheme_id in (${authority})
		</if>
	</select>
	
	<!-- 根据企业ID和城市名称获取最小方案 -->
	<select id="findMinSchemeByCpIdAndCityNmae" resultMap="result_map_SPS_SCHEME" parameterType="Object">
		SELECT 
		min(scheme_id) as scheme_id,sp_id,cp_id,name,area_id,scheme_type,parent_sp_id,parent_id,state,price,insurance_type,insurance_account_id,fund_type,fund_account_id,bill_type,end_date,bill_date_type,bill_date,pay_date_type,pay_date,afterpay_rule,memo,ispackage,isdefault,create_by,create_dt,modify_by,modify_dt,dr
		FROM SPS_SCHEME 
		WHERE cp_id=#{cpId} and SUBSTRING_INDEX(name, '_',-1) like '%${areaname}%' and dr=0
	</select>

	<!-- 根据企业ID获取方案列表 -->
	<select id="find_schemeby_cpid" resultMap="result_map_SPS_SCHEME" parameterType="Object">
		SELECT
		scheme.scheme_id,scheme.sp_id,scheme.cp_id,scheme.name,scheme.area_id,scheme.isdefault,area.`name` as areaname,scheme.fund_account_id,scheme.insurance_account_id
		FROM SPS_SCHEME scheme INNER JOIN bs_area area ON scheme.area_id = area.area_id AND scheme.dr = 0
		WHERE scheme.cp_id=#{cpId} AND scheme.sp_id = -999
        <if test="authority != 'ALL'">
            AND scheme.scheme_id in (${authority})
        </if>
		 ORDER BY IFNULL(scheme.isdefault,'N') DESC
	</select>

    <!-- 查询当前方案对应的库支持上行数据情况列表 -->
    <select id="querySchemeAccountAreaList" resultType="java.util.Map" parameterType="Object">
         SELECT t.*,fundacc.reg_num as fundregnum FROM (
          SELECT s.*,ccode.ukey_type,insacc.reg_num as insregnum,area.`code` as areaCode,area.`name` as areaName,area.pinyin,ccode.fundLoginURL,ccode.insuranceLoginURL FROM (
                SELECT scheme.scheme_id,scheme.area_id,IFNULL(scheme.insurance_account_id,-1) as insaccid,IFNULL(scheme.fund_account_id,-1) as fundaccid 
                FROM sps_scheme scheme WHERE scheme.cp_id = #{cpId} AND scheme.state = 'USE' AND scheme.dr = 0
                <if test="authority != 'ALL'"> 
					AND scheme.scheme_id in (${authority})
				</if>
                ) s
                INNER JOIN bs_area area ON area.area_id = s.area_id
                INNER JOIN sps_ts_citycode ccode ON ccode.area_id  = area.`code`
                LEFT JOIN sps_account insacc ON insacc.acc_id = s.insaccid AND insacc.insurance_fund_type = 'INSURANCE'
        ) t
        LEFT JOIN sps_account fundacc ON fundacc.acc_id = t.fundaccid AND fundacc.insurance_fund_type = 'FUND'
    </select>
    
    <!-- 根据权限、企业ID、服务商ID和方案ID获取参保城市 -->
    <select id="findServiceBillDetailsArea" resultType="java.util.Map" parameterType="Object">
         select b.`area_id` areaId,b.name as areaName,a.scheme_id as schemeId
			from (
				select a.belong_city,s.scheme_id
				from sps_scheme s
				inner join bs_area a on s.area_id= a.area_id
				where s.cp_id=#{cpId} and s.sp_id=#{spId}
				<if test="authority != 'ALL'"> 
					AND s.scheme_id in (${authority})
				</if>
				<if test="schemeIds != null"> 
					AND s.scheme_id in
					<foreach item="item" index="index" collection="schemeIds" open="(" separator="," close=")">
						#{item}
					</foreach>
				</if>
				group by a.belong_city
			) a
			inner join bs_area b on a.belong_city= b.area_id
    </select>
    
    <!-- 根据 服务商名称+方案名称 查询方案信息,排除自服务方案 -->
	<select id="findSchemeByName" resultType="java.util.Map" parameterType="Object">
		select scheme.area_id,scheme.scheme_id,scheme.memo,scheme.name from sps_scheme scheme 
		where scheme.cp_id = #{cpId} 
		and scheme.state='USE' and scheme.dr=0 and scheme.sp_id != -999 
		<if test="spId !=null ">
		 and scheme.sp_id = #{spId} 
		</if>
		<if test="name !=null ">
		 and scheme.name = #{name}
		</if>
		<if test="schemeId !=null ">
		 and scheme.scheme_id != #{schemeId}
		</if>
	</select>

    <select id="findSchemeBySpIds" resultType="java.util.Map" parameterType="Object">
        select scheme.scheme_id as schemeId from sps_scheme scheme where scheme.sp_id in (${spIds}) and scheme.cp_id = #{cpId}
    </select>


    <select id="findAllSpSchemeByCpId" resultMap="result_map_SPS_SCHEME" parameterType="Object">
        select <include refid="Base_Column_List"/> from sps_scheme scheme where scheme.sp_id != -999 and scheme.cp_id = #{cpId} and scheme.state='USE' and scheme.dr=0
    </select>
    
    <!-- 查询 有权限的 方案（排除自服务方案） -->
	<select id="findSpSchemeByAuthority" resultType="java.util.Map" parameterType="Object">
		select scheme.scheme_id,scheme.sp_id,scheme.cp_id,scheme.name from sps_scheme scheme  
		where scheme.cp_id = #{cpId} 
		and scheme.state='USE' and scheme.dr=0 and scheme.sp_id != -999 
		<if test="authority != 'ALL'"> 
			AND scheme.scheme_id in (${authority})
		</if>
	</select>
	
	<!-- 根据企业ID和城市获取方案  按自服务倒序 -->
	<select id="findSchemeByCityIdAndCpIdOderBySpId" resultMap="result_map_SPS_SCHEME" parameterType="Object">
		SELECT scheme_id ,name,sp_id
		from sps_scheme
		WHERE cp_id=#{cpId} and area_id=#{areaId} and dr=0
		<if test="authority != 'ALL'"> 
			AND scheme_id in (${authority})
		</if>
		order by sp_id
	</select>

    <!-- 根据企业ID获取自服务方案 -->
    <select id="find_self_scheme_bycpid" resultType="java.util.Map" parameterType="Object">
        SELECT
        scheme.scheme_id,
        scheme.`name`,
        area.area_id,
        area.`name` AS areaName,
        tsc.ukey_type
        FROM
        sps_scheme scheme
        INNER JOIN bs_area area ON scheme.area_id = area.area_id
        LEFT JOIN sps_ts_citycode tsc ON tsc.area_id = area.`code`
        WHERE
        cp_id = #{cpId}
        AND dr = 0
        <if test="authority != 'ALL'">
            AND scheme_id in (${authority})
        </if>
        AND sp_id = - 999
        ORDER BY
        area.areacode
    </select>

</mapper>
